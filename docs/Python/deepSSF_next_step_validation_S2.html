<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Scott Forrest">
<meta name="dcterms.date" content="2025-02-13">

<title>deepSSF Validation - S2 â€“ deepSSF</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Python/deepSSF_next_step_validation.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-fd053a38988e21bb3d3b0b617a2084cf.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">deepSSF</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../study_system.html"> 
<span class="menu-text">Study System</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../step_selection_intuition.html"> 
<span class="menu-text">Step Selection Intuition</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../deepSSF_model_overview.html"> 
<span class="menu-text">deepSSF Model Overview</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/swforrest/deepSSF"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Python/deepSSF_next_step_validation.html">Next-Step Validation</a></li><li class="breadcrumb-item"><a href="../Python/deepSSF_next_step_validation_S2.html">deepSSF Validation - S2</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Data prep</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Model Training</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_train.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Training</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_train_S2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Training - S2</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Generating simulations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_simulations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Simulations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_simulations_S2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Simulations - S2</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Landscape predictions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_landscape_preds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Landscape Predictions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_landscape_preds_S2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Landscape Predictions - S2</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">SSF Model Fitting</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Next-Step Validation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_next_step_validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">deepSSF Validation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Python/deepSSF_next_step_validation_S2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">deepSSF Validation - S2</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#import-packages" id="toc-import-packages" class="nav-link active" data-scroll-target="#import-packages">Import packages</a></li>
  <li><a href="#import-data" id="toc-import-data" class="nav-link" data-scroll-target="#import-data">Import data</a>
  <ul class="collapse">
  <li><a href="#importing-spatial-data" id="toc-importing-spatial-data" class="nav-link" data-scroll-target="#importing-spatial-data">Importing spatial data</a></li>
  <li><a href="#sentinel-2-bands" id="toc-sentinel-2-bands" class="nav-link" data-scroll-target="#sentinel-2-bands">Sentinel-2 bands</a>
  <ul class="collapse">
  <li><a href="#slope" id="toc-slope" class="nav-link" data-scroll-target="#slope">Slope</a></li>
  </ul></li>
  <li><a href="#global-layers" id="toc-global-layers" class="nav-link" data-scroll-target="#global-layers">Global layers</a>
  <ul class="collapse">
  <li><a href="#going-between-cell-and-raster-coordinates" id="toc-going-between-cell-and-raster-coordinates" class="nav-link" data-scroll-target="#going-between-cell-and-raster-coordinates">Going between cell and raster coordinates</a></li>
  </ul></li>
  <li><a href="#subset-function" id="toc-subset-function" class="nav-link" data-scroll-target="#subset-function">Subset function</a>
  <ul class="collapse">
  <li><a href="#save-the-plots-individually" id="toc-save-the-plots-individually" class="nav-link" data-scroll-target="#save-the-plots-individually">Save the plots individually</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#running-the-model-on-the-subset-layers" id="toc-running-the-model-on-the-subset-layers" class="nav-link" data-scroll-target="#running-the-model-on-the-subset-layers">Running the model on the subset layers</a>
  <ul class="collapse">
  <li><a href="#set-the-device-for-the-model" id="toc-set-the-device-for-the-model" class="nav-link" data-scroll-target="#set-the-device-for-the-model">Set the device for the model</a></li>
  </ul></li>
  <li><a href="#define-the-model" id="toc-define-the-model" class="nav-link" data-scroll-target="#define-the-model">Define the model</a>
  <ul class="collapse">
  <li><a href="#instantiate-the-model" id="toc-instantiate-the-model" class="nav-link" data-scroll-target="#instantiate-the-model">Instantiate the model</a></li>
  <li><a href="#load-the-model-weights" id="toc-load-the-model-weights" class="nav-link" data-scroll-target="#load-the-model-weights">Load the model weights</a></li>
  <li><a href="#setup-validation" id="toc-setup-validation" class="nav-link" data-scroll-target="#setup-validation">Setup validation</a></li>
  </ul></li>
  <li><a href="#next-step-probability-values" id="toc-next-step-probability-values" class="nav-link" data-scroll-target="#next-step-probability-values">Next-step probability values</a></li>
  <li><a href="#loop-the-validation-over-each-individual" id="toc-loop-the-validation-over-each-individual" class="nav-link" data-scroll-target="#loop-the-validation-over-each-individual">Loop the validation over each individual</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Python/deepSSF_next_step_validation.html">Next-Step Validation</a></li><li class="breadcrumb-item"><a href="../Python/deepSSF_next_step_validation_S2.html">deepSSF Validation - S2</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">deepSSF Validation - S2</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Scott Forrest <a href="mailto:scottwforrest@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 13, 2025</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>In this script, we will assess how well the deepSSF model predicts the next step in the observed trajectory.</p>
    <p>Whilst the realism and emergent properties of simulated trajectories are difficult to assess, we can validate the deepSSF models on their predictive performance at the next step, for each of the habitat selection, movement and next-step probability surfaces. Ensuring that the probability surfaces are normalised to sum to one, they can be compared to the predictions of typical step selection functions when the same probability surfaces are generated for the same local covariates. This approach not only allows for comparison between models, but can be informative as to when in the observed trajectory the model performs well or poorly, which can be analysed across the entire tracking period or for each hour of the day, and can lead to critical evaluation of the covariates that are used by the models and allow for model refinement.</p>
    <p>This is the same as the <code>deepSSF_next_step_validation.ipynb</code> script, except that here we are using Sentinel-2 layers as covariates. This model was trained in the <code>deepSSF_train_S2.ipynb</code> script.</p>
  </div>
</div>


</header>


<section id="import-packages" class="level2">
<h2 class="anchored" data-anchor-id="import-packages">Import packages</h2>
<div id="cell-2" class="cell" data-outputid="205da944-eee9-4a12-8089-25362f87a046" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.version)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install rasterio</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.plot <span class="im">import</span> show</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Get today's date</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>today_date <span class="op">=</span> datetime.today().strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>3.12.5 | packaged by Anaconda, Inc. | (main, Sep 12 2024, 18:18:29) [MSC v.1929 64 bit (AMD64)]</code></pre>
</div>
</div>
<div id="cell-3" class="cell" data-outputid="a4f7f38c-a7fd-4451-ef8c-e8cdf69c3201" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from google.colab import drive</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># drive.mount('/content/drive')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="import-data" class="level1">
<h1>Import data</h1>
<div id="cell-5" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get today's date</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>today_date <span class="op">=</span> datetime.today().strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># select the id to train the model on</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>buffalo_id <span class="op">=</span> <span class="dv">2005</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="dv">10297</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2014</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 6572</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2327</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 8983</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2387</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 10409</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the path to your CSV file</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>csv_file_path <span class="op">=</span> <span class="ss">f'../buffalo_local_data_id/validation/validation_buffalo_</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_data_df_lag_1hr_n</span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file into a DataFrame</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>buffalo_df <span class="op">=</span> pd.read_csv(csv_file_path)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Lag the values in column 'A' by one index</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Pad the missing value with a specified value, e.g., 0</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing_tm1'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

         ta    cos_ta         x_min         x_max         y_min         y_max  \
0  1.367942  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06   
1 -0.021429  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06   
2  2.994917 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06   
3 -2.799767 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06   
4  0.285377  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06   

   s2_index  points_vect_cent  year_t2  yday_t2_2018_base  
0         7               NaN     2018                206  
1         7               NaN     2018                206  
2         7               NaN     2018                206  
3         7               NaN     2018                206  
4         7               NaN     2018                206  

[5 rows x 35 columns]
             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

     cos_ta         x_min         x_max         y_min         y_max  s2_index  \
0  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06         7   
1  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06         7   
2 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06         7   
3 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06         7   
4  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06         7   

   points_vect_cent  year_t2  yday_t2_2018_base  bearing_tm1  
0               NaN     2018                206     0.000000  
1               NaN     2018                206     2.802478  
2               NaN     2018                206     2.781049  
3               NaN     2018                206    -0.507220  
4               NaN     2018                206     2.976198  

[5 rows x 36 columns]</code></pre>
</div>
</div>
<section id="importing-spatial-data" class="level2">
<h2 class="anchored" data-anchor-id="importing-spatial-data">Importing spatial data</h2>
</section>
<section id="sentinel-2-bands" class="level2">
<h2 class="anchored" data-anchor-id="sentinel-2-bands">Sentinel-2 bands</h2>
<p>Each stack represents a month of median values of cloud-free pixels, and each layer in the stack are the bands.</p>
<div id="cell-8" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Specify the directory containing your TIFF files</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> <span class="st">'../mapping/cropped rasters/sentinel2/25m'</span>  <span class="co"># Replace with the actual path to your TIFF files</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Use glob to get a list of all TIFF files matching the pattern</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>tif_files <span class="op">=</span> glob.glob(os.path.join(data_dir, <span class="st">'S2_SR_masked_25m_*.tif'</span>))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Found </span><span class="sc">{</span><span class="bu">len</span>(tif_files)<span class="sc">}</span><span class="ss"> TIFF files'</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(tif_files))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Found 12 TIFF files
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_01.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_02.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_03.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_04.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_05.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_06.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_07.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_08.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_09.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_10.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_11.tif
../mapping/cropped rasters/sentinel2/25m\S2_SR_masked_25m_2019_12.tif</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Initialize a dictionary to store data with date as the key</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data_dict <span class="op">=</span> {}</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Define the min and max values for normalization for each band</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Values are from the buffalo 2005 local layers</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>band_normalization <span class="op">=</span> {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band1"</span>: {<span class="st">"min"</span>: <span class="fl">1.0</span>, <span class="st">"max"</span>: <span class="fl">1517.0848</span>},</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band2"</span>: {<span class="st">"min"</span>: <span class="fl">28.1072</span>, <span class="st">"max"</span>: <span class="fl">1931.7552</span>},</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band3"</span>: {<span class="st">"min"</span>: <span class="fl">210.9864</span>, <span class="st">"max"</span>: <span class="fl">2795.7568</span>},</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band4"</span>: {<span class="st">"min"</span>: <span class="fl">65.7832</span>, <span class="st">"max"</span>: <span class="fl">4386.7969</span>},</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band5"</span>: {<span class="st">"min"</span>: <span class="fl">358.7600</span>, <span class="st">"max"</span>: <span class="fl">4592.7358</span>},</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band6"</span>: {<span class="st">"min"</span>: <span class="fl">385.3400</span>, <span class="st">"max"</span>: <span class="fl">5120.9146</span>},</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band7"</span>: {<span class="st">"min"</span>: <span class="fl">416.5744</span>, <span class="st">"max"</span>: <span class="fl">6045.6992</span>},</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band8"</span>: {<span class="st">"min"</span>: <span class="fl">368.0320</span>, <span class="st">"max"</span>: <span class="fl">6004.5825</span>},</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band8a"</span>: {<span class="st">"min"</span>: <span class="fl">357.0704</span>, <span class="st">"max"</span>: <span class="fl">6218.4136</span>},</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band9"</span>: {<span class="st">"min"</span>: <span class="fl">123.0</span>, <span class="st">"max"</span>: <span class="fl">5680.5000</span>},</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band11"</span>: {<span class="st">"min"</span>: <span class="fl">174.1200</span>, <span class="st">"max"</span>: <span class="fl">6570.3921</span>},</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Band12"</span>: {<span class="st">"min"</span>: <span class="fl">123.3760</span>, <span class="st">"max"</span>: <span class="fl">5119.9966</span>}</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># # Define the min and max values for normalization for each band - when all scaled by 10000</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># band_normalization = {</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band1": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band2": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band3": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band4": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band5": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band6": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band7": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band8": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band8a": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band9": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band11": {"min": 0.0, "max": 10000.0},</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     "Band12": {"min": 0.0, "max": 10000.0}</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(band_normalization)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{'Band1': {'min': 1.0, 'max': 1517.0848}, 'Band2': {'min': 28.1072, 'max': 1931.7552}, 'Band3': {'min': 210.9864, 'max': 2795.7568}, 'Band4': {'min': 65.7832, 'max': 4386.7969}, 'Band5': {'min': 358.76, 'max': 4592.7358}, 'Band6': {'min': 385.34, 'max': 5120.9146}, 'Band7': {'min': 416.5744, 'max': 6045.6992}, 'Band8': {'min': 368.032, 'max': 6004.5825}, 'Band8a': {'min': 357.0704, 'max': 6218.4136}, 'Band9': {'min': 123.0, 'max': 5680.5}, 'Band11': {'min': 174.12, 'max': 6570.3921}, 'Band12': {'min': 123.376, 'max': 5119.9966}}</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Loop over each TIFF file to read and process the data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tif_file <span class="kw">in</span> tif_files:</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the filename from the path</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> os.path.basename(tif_file)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the date from the filename</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming filenames are in the format 'S2_SR_masked_YYYY_MM.tif'</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    date_str <span class="op">=</span> filename.replace(<span class="st">'S2_SR_masked_25m_'</span>, <span class="st">''</span>).replace(<span class="st">'.tif'</span>, <span class="st">''</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># date_str will be something like '2019_01'</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the TIFF file using rasterio</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rasterio.<span class="bu">open</span>(tif_file) <span class="im">as</span> src:</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read all bands of the TIFF file</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> src.read()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 'data' is a NumPy array with shape (bands, height, width)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize an array to store normalized data</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        normalized_data <span class="op">=</span> np.zeros_like(data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop over each band to perform normalization</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (band_name, values) <span class="kw">in</span> <span class="bu">enumerate</span>(band_normalization.items()):</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the data for the current band</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            band_data <span class="op">=</span> data[i]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the corresponding min and max values for this band</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            band_min <span class="op">=</span> values[<span class="st">'min'</span>]</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            band_max <span class="op">=</span> values[<span class="st">'max'</span>]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Replace NaN values in the original data with the band minimum</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            band_data <span class="op">=</span> np.nan_to_num(band_data, nan<span class="op">=</span>band_min)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Perform min-max normalization to scale data between 0 and 1</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Avoid division by zero by checking if (max - min) is not zero</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band_max <span class="op">-</span> band_min <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                normalized_band <span class="op">=</span> (band_data <span class="op">-</span> band_min) <span class="op">/</span> (band_max <span class="op">-</span> band_min)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If max and min are the same, set normalized data to zero</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                normalized_band <span class="op">=</span> np.zeros_like(band_data, dtype<span class="op">=</span>np.float32)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store the normalized band data</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            normalized_data[i] <span class="op">=</span> normalized_band</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check the normalization for the current band</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Band </span><span class="sc">{</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Original min: </span><span class="sc">{</span>band_data<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, Original max: </span><span class="sc">{</span>band_data<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Normalized min: </span><span class="sc">{</span>normalized_band<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, Normalized max: </span><span class="sc">{</span>normalized_band<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># # Plot the first few layers (bands) for visualization</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if i &lt; 3:  # Change the number of bands you want to plot by adjusting this condition</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     plt.figure(figsize=(8, 6))</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     plt.imshow(normalized_band, cmap='viridis')  # You can change the colormap as needed</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     plt.colorbar() # label='Normalized Value'</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     plt.title(f'Band {i + 1} - {date_str}')</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     plt.show()</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the normalized data to the dictionary with date as the key</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        data_dict[date_str] <span class="op">=</span> normalized_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Band 1 of 2019_01:
Original min: 1.0, Original max: 3130.509521484375
Normalized min: 0.0, Normalized max: 2.064204692840576
--------------------------------------------------
Band 2 of 2019_01:
Original min: 28.107200622558594, Original max: 4062.55517578125
Normalized min: 0.0, Normalized max: 2.1193246841430664
--------------------------------------------------
Band 3 of 2019_01:
Original min: 106.44960021972656, Original max: 4883.92333984375
Normalized min: -0.040443360805511475, Normalized max: 1.8078731298446655
--------------------------------------------------
Band 4 of 2019_01:
Original min: 65.783203125, Original max: 5488.09619140625
Normalized min: 0.0, Normalized max: 1.2548705339431763
--------------------------------------------------
Band 5 of 2019_01:
Original min: 120.79679870605469, Original max: 5836.35107421875
Normalized min: -0.05620325356721878, Normalized max: 1.2937228679656982
--------------------------------------------------
Band 6 of 2019_01:
Original min: 104.21279907226562, Original max: 5704.99658203125
Normalized min: -0.059364959597587585, Normalized max: 1.1233391761779785
--------------------------------------------------
Band 7 of 2019_01:
Original min: 134.27999877929688, Original max: 5897.26708984375
Normalized min: -0.050148896872997284, Normalized max: 0.9736313819885254
--------------------------------------------------
Band 8 of 2019_01:
Original min: 103.34239959716797, Original max: 5588.79541015625
Normalized min: -0.04695950448513031, Normalized max: 0.9262337684631348
--------------------------------------------------
Band 9 of 2019_01:
Original min: 89.87439727783203, Original max: 6002.5927734375
Normalized min: -0.04558613896369934, Normalized max: 0.9631789326667786
--------------------------------------------------
Band 10 of 2019_01:
Original min: 118.0, Original max: 5403.0
Normalized min: -0.0008996851393021643, Normalized max: 0.9500674605369568
--------------------------------------------------
Band 11 of 2019_01:
Original min: 101.806396484375, Original max: 6923.19677734375
Normalized min: -0.011305585503578186, Normalized max: 1.0551578998565674
--------------------------------------------------
Band 12 of 2019_01:
Original min: 89.61920166015625, Original max: 6447.490234375
Normalized min: -0.006755925714969635, Normalized max: 1.2656782865524292
--------------------------------------------------
Band 1 of 2019_02:
Original min: 1.0, Original max: 3391.7080078125
Normalized min: 0.0, Normalized max: 2.2364895343780518
--------------------------------------------------
Band 2 of 2019_02:
Original min: 1.0, Original max: 4440.51513671875
Normalized min: -0.014239608310163021, Normalized max: 2.3178696632385254
--------------------------------------------------
Band 3 of 2019_02:
Original min: 8.954400062561035, Original max: 5315.31689453125
Normalized min: -0.07816245406866074, Normalized max: 1.97477126121521
--------------------------------------------------
Band 4 of 2019_02:
Original min: 18.737600326538086, Original max: 6157.92626953125
Normalized min: -0.01088763028383255, Normalized max: 1.409887433052063
--------------------------------------------------
Band 5 of 2019_02:
Original min: 67.9280014038086, Original max: 6442.4375
Normalized min: -0.06869005411863327, Normalized max: 1.4368712902069092
--------------------------------------------------
Band 6 of 2019_02:
Original min: 4.492800235748291, Original max: 6278.216796875
Normalized min: -0.08042259514331818, Normalized max: 1.244384765625
--------------------------------------------------
Band 7 of 2019_02:
Original min: 24.778400421142578, Original max: 6504.63037109375
Normalized min: -0.06960158050060272, Normalized max: 1.0815279483795166
--------------------------------------------------
Band 8 of 2019_02:
Original min: 2.657599925994873, Original max: 6235.12939453125
Normalized min: -0.06482234597206116, Normalized max: 1.0409021377563477
--------------------------------------------------
Band 9 of 2019_02:
Original min: 5.070400238037109, Original max: 6606.5341796875
Normalized min: -0.06005449220538139, Normalized max: 1.066217064857483
--------------------------------------------------
Band 10 of 2019_02:
Original min: 1.0, Original max: 6120.5
Normalized min: -0.021952316164970398, Normalized max: 1.0791722536087036
--------------------------------------------------
Band 11 of 2019_02:
Original min: 53.60960006713867, Original max: 7070.3017578125
Normalized min: -0.018840722739696503, Normalized max: 1.0781564712524414
--------------------------------------------------
Band 12 of 2019_02:
Original min: 51.79119873046875, Original max: 6487.13818359375
Normalized min: -0.014326643198728561, Normalized max: 1.2736132144927979
--------------------------------------------------
Band 1 of 2019_03:
Original min: 1.0, Original max: 3667.921630859375
Normalized min: 0.0, Normalized max: 2.4186782836914062
--------------------------------------------------
Band 2 of 2019_03:
Original min: 1.0, Original max: 4531.5712890625
Normalized min: -0.014239608310163021, Normalized max: 2.3657021522521973
--------------------------------------------------
Band 3 of 2019_03:
Original min: 1.0, Original max: 5131.46875
Normalized min: -0.08123986423015594, Normalized max: 1.9036438465118408
--------------------------------------------------
Band 4 of 2019_03:
Original min: 1.0, Original max: 5739.20947265625
Normalized min: -0.01499259378761053, Normalized max: 1.3129850625991821
--------------------------------------------------
Band 5 of 2019_03:
Original min: 60.261600494384766, Original max: 6059.52880859375
Normalized min: -0.07050073891878128, Normalized max: 1.3464339971542358
--------------------------------------------------
Band 6 of 2019_03:
Original min: 1.0, Original max: 7035.96142578125
Normalized min: -0.08116015791893005, Normalized max: 1.4043958187103271
--------------------------------------------------
Band 7 of 2019_03:
Original min: 1.0, Original max: 8270.6171875
Normalized min: -0.07382575422525406, Normalized max: 1.3952511548995972
--------------------------------------------------
Band 8 of 2019_03:
Original min: 1.0, Original max: 7965.4462890625
Normalized min: -0.06511642783880234, Normalized max: 1.347883701324463
--------------------------------------------------
Band 9 of 2019_03:
Original min: 1.0, Original max: 8667.9306640625
Normalized min: -0.06074894219636917, Normalized max: 1.4179105758666992
--------------------------------------------------
Band 10 of 2019_03:
Original min: 4.400000095367432, Original max: 8372.701171875
Normalized min: -0.02134053036570549, Normalized max: 1.4844266176223755
--------------------------------------------------
Band 11 of 2019_03:
Original min: 47.04079818725586, Original max: 6702.408203125
Normalized min: -0.01986769773066044, Normalized max: 1.0206395387649536
--------------------------------------------------
Band 12 of 2019_03:
Original min: 43.54079818725586, Original max: 6128.4921875
Normalized min: -0.01597784087061882, Normalized max: 1.2018355131149292
--------------------------------------------------
Band 1 of 2019_04:
Original min: 1.0, Original max: 3339.30810546875
Normalized min: 0.0, Normalized max: 2.2019269466400146
--------------------------------------------------
Band 2 of 2019_04:
Original min: 14.190400123596191, Original max: 4312.416015625
Normalized min: -0.007310595829039812, Normalized max: 2.2505781650543213
--------------------------------------------------
Band 3 of 2019_04:
Original min: 45.36479949951172, Original max: 5238.5185546875
Normalized min: -0.06407594680786133, Normalized max: 1.9450594186782837
--------------------------------------------------
Band 4 of 2019_04:
Original min: 36.9192008972168, Original max: 5950.73291015625
Normalized min: -0.006679914426058531, Normalized max: 1.3619372844696045
--------------------------------------------------
Band 5 of 2019_04:
Original min: 40.17919921875, Original max: 6383.9208984375
Normalized min: -0.07524389773607254, Normalized max: 1.4230505228042603
--------------------------------------------------
Band 6 of 2019_04:
Original min: 1.0, Original max: 6169.95751953125
Normalized min: -0.08116015791893005, Normalized max: 1.2215238809585571
--------------------------------------------------
Band 7 of 2019_04:
Original min: 1.0, Original max: 6732.357421875
Normalized min: -0.07382575422525406, Normalized max: 1.1219831705093384
--------------------------------------------------
Band 8 of 2019_04:
Original min: 1.0, Original max: 6609.89453125
Normalized min: -0.06511642783880234, Normalized max: 1.1073905229568481
--------------------------------------------------
Band 9 of 2019_04:
Original min: 1.0, Original max: 7060.90478515625
Normalized min: -0.06074894219636917, Normalized max: 1.1437368392944336
--------------------------------------------------
Band 10 of 2019_04:
Original min: 1.0, Original max: 7147.0
Normalized min: -0.021952316164970398, Normalized max: 1.2638776302337646
--------------------------------------------------
Band 11 of 2019_04:
Original min: 24.7455997467041, Original max: 6833.92724609375
Normalized min: -0.023353351280093193, Normalized max: 1.0412013530731201
--------------------------------------------------
Band 12 of 2019_04:
Original min: 20.95840072631836, Original max: 6376.7783203125
Normalized min: -0.02049737423658371, Normalized max: 1.2515263557434082
--------------------------------------------------
Band 1 of 2019_05:
Original min: 1.0, Original max: 3433.771240234375
Normalized min: 0.0, Normalized max: 2.2642343044281006
--------------------------------------------------
Band 2 of 2019_05:
Original min: 1.0, Original max: 4441.66259765625
Normalized min: -0.014239608310163021, Normalized max: 2.318472385406494
--------------------------------------------------
Band 3 of 2019_05:
Original min: 8.166399955749512, Original max: 5285.01123046875
Normalized min: -0.07846731692552567, Normalized max: 1.9630465507507324
--------------------------------------------------
Band 4 of 2019_05:
Original min: 1.0240000486373901, Original max: 5865.8173828125
Normalized min: -0.014987039379775524, Normalized max: 1.3422855138778687
--------------------------------------------------
Band 5 of 2019_05:
Original min: 9.308799743652344, Original max: 6258.33837890625
Normalized min: -0.08253500610589981, Normalized max: 1.3933897018432617
--------------------------------------------------
Band 6 of 2019_05:
Original min: 1.0, Original max: 6027.23583984375
Normalized min: -0.08116015791893005, Normalized max: 1.1913857460021973
--------------------------------------------------
Band 7 of 2019_05:
Original min: 1.0, Original max: 6165.66259765625
Normalized min: -0.07382575422525406, Normalized max: 1.0213111639022827
--------------------------------------------------
Band 8 of 2019_05:
Original min: 1.0, Original max: 6259.55517578125
Normalized min: -0.06511642783880234, Normalized max: 1.0452356338500977
--------------------------------------------------
Band 9 of 2019_05:
Original min: 1.0, Original max: 6525.44140625
Normalized min: -0.06074894219636917, Normalized max: 1.0523818731307983
--------------------------------------------------
Band 10 of 2019_05:
Original min: 1.0, Original max: 6769.02001953125
Normalized min: -0.021952316164970398, Normalized max: 1.1958650350570679
--------------------------------------------------
Band 11 of 2019_05:
Original min: 12.742400169372559, Original max: 6933.49609375
Normalized min: -0.02522994577884674, Normalized max: 1.0567680597305298
--------------------------------------------------
Band 12 of 2019_05:
Original min: 6.840000152587891, Original max: 6644.17529296875
Normalized min: -0.02332296222448349, Normalized max: 1.3050419092178345
--------------------------------------------------
Band 1 of 2019_06:
Original min: 1.0, Original max: 3236.017578125
Normalized min: 0.0, Normalized max: 2.1337971687316895
--------------------------------------------------
Band 2 of 2019_06:
Original min: 8.56879997253418, Original max: 4389.61279296875
Normalized min: -0.010263662785291672, Normalized max: 2.291130304336548
--------------------------------------------------
Band 3 of 2019_06:
Original min: 74.37120056152344, Original max: 5176.671875
Normalized min: -0.05285390093922615, Normalized max: 1.9211320877075195
--------------------------------------------------
Band 4 of 2019_06:
Original min: 26.035200119018555, Original max: 5846.98583984375
Normalized min: -0.009198768064379692, Normalized max: 1.3379274606704712
--------------------------------------------------
Band 5 of 2019_06:
Original min: 23.665599822998047, Original max: 6027.583984375
Normalized min: -0.07914415746927261, Normalized max: 1.338889241218567
--------------------------------------------------
Band 6 of 2019_06:
Original min: 1.0, Original max: 5887.2646484375
Normalized min: -0.08116015791893005, Normalized max: 1.1618282794952393
--------------------------------------------------
Band 7 of 2019_06:
Original min: 1.0, Original max: 5982.5849609375
Normalized min: -0.07382575422525406, Normalized max: 0.9887878894805908
--------------------------------------------------
Band 8 of 2019_06:
Original min: 1.0, Original max: 6105.24169921875
Normalized min: -0.06511642783880234, Normalized max: 1.0178582668304443
--------------------------------------------------
Band 9 of 2019_06:
Original min: 1.0, Original max: 6020.00390625
Normalized min: -0.06074894219636917, Normalized max: 0.9661494493484497
--------------------------------------------------
Band 10 of 2019_06:
Original min: 1.0, Original max: 5469.80224609375
Normalized min: -0.021952316164970398, Normalized max: 0.9620876908302307
--------------------------------------------------
Band 11 of 2019_06:
Original min: 27.90399932861328, Original max: 6561.875
Normalized min: -0.022859565913677216, Normalized max: 0.9986684322357178
--------------------------------------------------
Band 12 of 2019_06:
Original min: 27.4768009185791, Original max: 6229.6201171875
Normalized min: -0.019192812964320183, Normalized max: 1.2220747470855713
--------------------------------------------------
Band 1 of 2019_07:
Original min: 1.0, Original max: 3354.7294921875
Normalized min: 0.0, Normalized max: 2.2120988368988037
--------------------------------------------------
Band 2 of 2019_07:
Original min: 1.0, Original max: 4239.18408203125
Normalized min: -0.014239608310163021, Normalized max: 2.212108850479126
--------------------------------------------------
Band 3 of 2019_07:
Original min: 69.9280014038086, Original max: 5010.18896484375
Normalized min: -0.05457289516925812, Normalized max: 1.8567229509353638
--------------------------------------------------
Band 4 of 2019_07:
Original min: 6.132800102233887, Original max: 5697.83056640625
Normalized min: -0.0138047244399786, Normalized max: 1.3034088611602783
--------------------------------------------------
Band 5 of 2019_07:
Original min: 4.584000110626221, Original max: 5928.41845703125
Normalized min: -0.08365093171596527, Normalized max: 1.3154677152633667
--------------------------------------------------
Band 6 of 2019_07:
Original min: 1.0, Original max: 5842.5048828125
Normalized min: -0.08116015791893005, Normalized max: 1.1523765325546265
--------------------------------------------------
Band 7 of 2019_07:
Original min: 1.0, Original max: 5931.01025390625
Normalized min: -0.07382575422525406, Normalized max: 0.9796258211135864
--------------------------------------------------
Band 8 of 2019_07:
Original min: 1.0, Original max: 5965.62548828125
Normalized min: -0.06511642783880234, Normalized max: 0.9930884838104248
--------------------------------------------------
Band 9 of 2019_07:
Original min: 1.0, Original max: 5976.9765625
Normalized min: -0.06074894219636917, Normalized max: 0.9588086009025574
--------------------------------------------------
Band 10 of 2019_07:
Original min: 1.0, Original max: 5407.2119140625
Normalized min: -0.021952316164970398, Normalized max: 0.9508253335952759
--------------------------------------------------
Band 11 of 2019_07:
Original min: 1.0, Original max: 6648.115234375
Normalized min: -0.027065765112638474, Normalized max: 1.0121513605117798
--------------------------------------------------
Band 12 of 2019_07:
Original min: 8.038399696350098, Original max: 6236.06884765625
Normalized min: -0.023083122447133064, Normalized max: 1.2233654260635376
--------------------------------------------------
Band 1 of 2019_08:
Original min: 1.0, Original max: 3266.366455078125
Normalized min: 0.0, Normalized max: 2.1538150310516357
--------------------------------------------------
Band 2 of 2019_08:
Original min: 1.062399983406067, Original max: 4354.7666015625
Normalized min: -0.01420682854950428, Normalized max: 2.272825241088867
--------------------------------------------------
Band 3 of 2019_08:
Original min: 49.3568000793457, Original max: 5170.822265625
Normalized min: -0.06253150850534439, Normalized max: 1.9188690185546875
--------------------------------------------------
Band 4 of 2019_08:
Original min: 8.721599578857422, Original max: 5994.017578125
Normalized min: -0.013205605559051037, Normalized max: 1.3719545602798462
--------------------------------------------------
Band 5 of 2019_08:
Original min: 22.86720085144043, Original max: 6259.99755859375
Normalized min: -0.07933272421360016, Normalized max: 1.3937816619873047
--------------------------------------------------
Band 6 of 2019_08:
Original min: 1.0, Original max: 6045.15771484375
Normalized min: -0.08116015791893005, Normalized max: 1.1951701641082764
--------------------------------------------------
Band 7 of 2019_08:
Original min: 1.0, Original max: 6074.607421875
Normalized min: -0.07382575422525406, Normalized max: 1.005135416984558
--------------------------------------------------
Band 8 of 2019_08:
Original min: 1.0, Original max: 6155.26708984375
Normalized min: -0.06511642783880234, Normalized max: 1.0267335176467896
--------------------------------------------------
Band 9 of 2019_08:
Original min: 1.0, Original max: 6096.89599609375
Normalized min: -0.06074894219636917, Normalized max: 0.979267954826355
--------------------------------------------------
Band 10 of 2019_08:
Original min: 1.0, Original max: 5442.3408203125
Normalized min: -0.021952316164970398, Normalized max: 0.9571463465690613
--------------------------------------------------
Band 11 of 2019_08:
Original min: 23.638399124145508, Original max: 6714.63427734375
Normalized min: -0.023526454344391823, Normalized max: 1.0225509405136108
--------------------------------------------------
Band 12 of 2019_08:
Original min: 24.430400848388672, Original max: 6365.9736328125
Normalized min: -0.019802505150437355, Normalized max: 1.249363899230957
--------------------------------------------------
Band 1 of 2019_09:
Original min: 1.0, Original max: 3183.698486328125
Normalized min: 0.0, Normalized max: 2.099287748336792
--------------------------------------------------
Band 2 of 2019_09:
Original min: 28.107200622558594, Original max: 4021.892822265625
Normalized min: 0.0, Normalized max: 2.0979645252227783
--------------------------------------------------
Band 3 of 2019_09:
Original min: 165.4647979736328, Original max: 4911.85302734375
Normalized min: -0.017611470073461533, Normalized max: 1.8186784982681274
--------------------------------------------------
Band 4 of 2019_09:
Original min: 65.783203125, Original max: 5674.5087890625
Normalized min: 0.0, Normalized max: 1.2980115413665771
--------------------------------------------------
Band 5 of 2019_09:
Original min: 74.53279876708984, Original max: 6061.4072265625
Normalized min: -0.06713009625673294, Normalized max: 1.3468776941299438
--------------------------------------------------
Band 6 of 2019_09:
Original min: 16.939199447631836, Original max: 5879.60498046875
Normalized min: -0.07779431343078613, Normalized max: 1.1602108478546143
--------------------------------------------------
Band 7 of 2019_09:
Original min: 29.526399612426758, Original max: 5951.17578125
Normalized min: -0.06875811517238617, Normalized max: 0.9832081198692322
--------------------------------------------------
Band 8 of 2019_09:
Original min: 19.507200241088867, Original max: 6065.71533203125
Normalized min: -0.06183299794793129, Normalized max: 1.0108457803726196
--------------------------------------------------
Band 9 of 2019_09:
Original min: 12.548800468444824, Original max: 5988.3408203125
Normalized min: -0.058778610080480576, Normalized max: 0.9607474207878113
--------------------------------------------------
Band 10 of 2019_09:
Original min: 1.0, Original max: 5419.35986328125
Normalized min: -0.021952316164970398, Normalized max: 0.9530112147331238
--------------------------------------------------
Band 11 of 2019_09:
Original min: 39.3120002746582, Original max: 6790.4384765625
Normalized min: -0.021076027303934097, Normalized max: 1.0344022512435913
--------------------------------------------------
Band 12 of 2019_09:
Original min: 31.515199661254883, Original max: 6453.60791015625
Normalized min: -0.01838458701968193, Normalized max: 1.2669026851654053
--------------------------------------------------
Band 1 of 2019_10:
Original min: 76.81999969482422, Original max: 3226.445556640625
Normalized min: 0.05001039430499077, Normalized max: 2.127483606338501
--------------------------------------------------
Band 2 of 2019_10:
Original min: 143.55679321289062, Original max: 4082.16650390625
Normalized min: 0.060646504163742065, Normalized max: 2.129626512527466
--------------------------------------------------
Band 3 of 2019_10:
Original min: 229.33120727539062, Original max: 4954.63671875
Normalized min: 0.007097265683114529, Normalized max: 1.835230827331543
--------------------------------------------------
Band 4 of 2019_10:
Original min: 153.42160034179688, Original max: 5660.03857421875
Normalized min: 0.02028190717101097, Normalized max: 1.2946627140045166
--------------------------------------------------
Band 5 of 2019_10:
Original min: 186.9456024169922, Original max: 6028.29736328125
Normalized min: -0.04057992249727249, Normalized max: 1.3390575647354126
--------------------------------------------------
Band 6 of 2019_10:
Original min: 110.46399688720703, Original max: 5883.8662109375
Normalized min: -0.0580449104309082, Normalized max: 1.1611106395721436
--------------------------------------------------
Band 7 of 2019_10:
Original min: 122.0624008178711, Original max: 5954.65283203125
Normalized min: -0.052319321781396866, Normalized max: 0.9838258624076843
--------------------------------------------------
Band 8 of 2019_10:
Original min: 107.84159851074219, Original max: 5912.51513671875
Normalized min: -0.046161290258169174, Normalized max: 0.9836660027503967
--------------------------------------------------
Band 9 of 2019_10:
Original min: 92.75520324707031, Original max: 6000.85205078125
Normalized min: -0.04509464278817177, Normalized max: 0.9628819823265076
--------------------------------------------------
Band 10 of 2019_10:
Original min: 62.20000076293945, Original max: 5452.0
Normalized min: -0.010940170846879482, Normalized max: 0.9588844180107117
--------------------------------------------------
Band 11 of 2019_10:
Original min: 102.7040023803711, Original max: 6868.75048828125
Normalized min: -0.011165252886712551, Normalized max: 1.0466456413269043
--------------------------------------------------
Band 12 of 2019_10:
Original min: 74.7488021850586, Original max: 6594.52978515625
Normalized min: -0.009732017293572426, Normalized max: 1.295106053352356
--------------------------------------------------
Band 1 of 2019_11:
Original min: 1.0, Original max: 3290.122314453125
Normalized min: 0.0, Normalized max: 2.1694843769073486
--------------------------------------------------
Band 2 of 2019_11:
Original min: 28.107200622558594, Original max: 4118.31689453125
Normalized min: 0.0, Normalized max: 2.1486165523529053
--------------------------------------------------
Band 3 of 2019_11:
Original min: 198.53280639648438, Original max: 4987.55859375
Normalized min: -0.004818067420274019, Normalized max: 1.8479676246643066
--------------------------------------------------
Band 4 of 2019_11:
Original min: 65.783203125, Original max: 5684.90869140625
Normalized min: 0.0, Normalized max: 1.3004183769226074
--------------------------------------------------
Band 5 of 2019_11:
Original min: 176.21600341796875, Original max: 5996.052734375
Normalized min: -0.04311409220099449, Normalized max: 1.3314419984817505
--------------------------------------------------
Band 6 of 2019_11:
Original min: 107.910400390625, Original max: 5825.63427734375
Normalized min: -0.058584146201610565, Normalized max: 1.1488139629364014
--------------------------------------------------
Band 7 of 2019_11:
Original min: 119.21759796142578, Original max: 5883.265625
Normalized min: -0.05282469466328621, Normalized max: 0.9711440801620483
--------------------------------------------------
Band 8 of 2019_11:
Original min: 102.37760162353516, Original max: 5796.53125
Normalized min: -0.04713067412376404, Normalized max: 0.9630889296531677
--------------------------------------------------
Band 9 of 2019_11:
Original min: 87.06079864501953, Original max: 5945.70556640625
Normalized min: -0.04606616497039795, Normalized max: 0.9534734487533569
--------------------------------------------------
Band 10 of 2019_11:
Original min: 100.5199966430664, Original max: 5333.22900390625
Normalized min: -0.004044984932988882, Normalized max: 0.9375131130218506
--------------------------------------------------
Band 11 of 2019_11:
Original min: 77.72480010986328, Original max: 7963.66796875
Normalized min: -0.015070527791976929, Normalized max: 1.217826247215271
--------------------------------------------------
Band 12 of 2019_11:
Original min: 65.90239715576172, Original max: 6645.1064453125
Normalized min: -0.011502495035529137, Normalized max: 1.3052282333374023
--------------------------------------------------
Band 1 of 2019_12:
Original min: 83.0, Original max: 3081.68408203125
Normalized min: 0.054086681455373764, Normalized max: 2.0319998264312744
--------------------------------------------------
Band 2 of 2019_12:
Original min: 121.30159759521484, Original max: 3902.246337890625
Normalized min: 0.04895569011569023, Normalized max: 2.0351133346557617
--------------------------------------------------
Band 3 of 2019_12:
Original min: 209.1248016357422, Original max: 4787.990234375
Normalized min: -0.0007202197448350489, Normalized max: 1.7707582712173462
--------------------------------------------------
Band 4 of 2019_12:
Original min: 157.22000122070312, Original max: 5521.5009765625
Normalized min: 0.02116096019744873, Normalized max: 1.262601375579834
--------------------------------------------------
Band 5 of 2019_12:
Original min: 250.0991973876953, Original max: 5903.6865234375
Normalized min: -0.025664014741778374, Normalized max: 1.309626579284668
--------------------------------------------------
Band 6 of 2019_12:
Original min: 173.05599975585938, Original max: 5790.28466796875
Normalized min: -0.04482750594615936, Normalized max: 1.1413493156433105
--------------------------------------------------
Band 7 of 2019_12:
Original min: 171.52479553222656, Original max: 5880.91845703125
Normalized min: -0.04353244975209236, Normalized max: 0.9707270860671997
--------------------------------------------------
Band 8 of 2019_12:
Original min: 151.193603515625, Original max: 5775.6767578125
Normalized min: -0.038470055907964706, Normalized max: 0.9593890309333801
--------------------------------------------------
Band 9 of 2019_12:
Original min: 149.6815948486328, Original max: 6008.1455078125
Normalized min: -0.0353824719786644, Normalized max: 0.9641262888908386
--------------------------------------------------
Band 10 of 2019_12:
Original min: 233.0, Original max: 5218.81982421875
Normalized min: 0.01979307271540165, Normalized max: 0.9169266223907471
--------------------------------------------------
Band 11 of 2019_12:
Original min: 124.07360076904297, Original max: 8157.59619140625
Normalized min: -0.0078243063762784, Normalized max: 1.2481452226638794
--------------------------------------------------
Band 12 of 2019_12:
Original min: 110.85919952392578, Original max: 6344.9951171875
Normalized min: -0.0025050530675798655, Normalized max: 1.245165467262268
--------------------------------------------------</code></pre>
</div>
</div>
<div id="cell-11" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Select some bands from the processed data stored in 'data_dict' for plotting</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>layers_to_plot <span class="op">=</span> []</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the date and band numbers you want to plot</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>dates_to_plot <span class="op">=</span> [<span class="st">'2019_01'</span>, <span class="st">'2019_05'</span>]  <span class="co"># This grabs all available dates. You can select specific ones if needed.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>bands_to_plot <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>]  <span class="co"># Band indices for bands 2, 3, and 4, which are B, G, and R</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the selected dates and bands to prepare them for plotting</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date_str <span class="kw">in</span> dates_to_plot:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    normalized_data <span class="op">=</span> data_dict[date_str]  <span class="co"># Get the normalized data for this date</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band_idx <span class="kw">in</span> bands_to_plot:</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collect the specific band for plotting</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        layers_to_plot.append((normalized_data[band_idx], band_idx <span class="op">+</span> <span class="dv">1</span>, date_str))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># random layers to test plotting function</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># layers_to_plot = [</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     (np.random.rand(100, 100), 1, '2023-01-01'),</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     (np.random.rand(100, 100), 2, '2023-02-01'),</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     (np.random.rand(100, 100), 3, '2023-03-01')</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ]</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Plot the stored layers</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> normalized_band, band_number, date_str <span class="kw">in</span> layers_to_plot:</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    plt.imshow(normalized_band, cmap<span class="op">=</span><span class="st">'viridis'</span>) </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Band </span><span class="sc">{</span>band_number<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    plt.colorbar() <span class="co">#label='Normalized Value'</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-8-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-8-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-8-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-8-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="slope" class="level3">
<h3 class="anchored" data-anchor-id="slope">Slope</h3>
<div id="cell-13" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'../mapping/cropped rasters/slope.tif'</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># read the raster file</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the raster band as separate variable</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    slope_global <span class="op">=</span> src.read(<span class="dv">1</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the metadata of the raster</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    slope_meta <span class="op">=</span> src.meta</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    raster_transform <span class="op">=</span> src.transform <span class="co"># same as the raster transform in the NDVI raster read</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_global)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_transform)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[       nan        nan        nan ...        nan        nan        nan]
 [       nan 0.3352837  0.39781624 ... 0.         0.                nan]
 [       nan 0.3983888  0.48142004 ... 0.         0.                nan]
 ...
 [       nan 2.215875   1.9798415  ... 1.5078747  1.268342          nan]
 [       nan 1.9740707  1.7354656  ... 1.697194   1.4880029         nan]
 [       nan        nan        nan ...        nan        nan        nan]]
| 25.00, 0.00, 0.00|
| 0.00,-25.00,-1406000.00|
| 0.00, 0.00, 1.00|</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_meta)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_global.shape)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace NaNs in the original array with -1, which represents water</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>slope_global <span class="op">=</span> np.nan_to_num(slope_global, nan<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># from the stack of local layers</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>slope_max <span class="op">=</span> <span class="fl">12.2981</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>slope_min <span class="op">=</span> <span class="fl">0.0006</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>slope_global_tens <span class="op">=</span> torch.from_numpy(slope_global)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the data</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>slope_global_norm <span class="op">=</span> (slope_global_tens <span class="op">-</span> slope_min) <span class="op">/</span> (slope_max <span class="op">-</span> slope_min)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>plt.imshow(slope_global_norm.numpy())</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>plt.colorbar()  </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{'driver': 'GTiff', 'dtype': 'float32', 'nodata': nan, 'width': 2400, 'height': 2280, 'count': 1, 'crs': CRS.from_wkt('LOCAL_CS["GDA94 / Geoscience Australia Lambert",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]'), 'transform': Affine(25.0, 0.0, 0.0,
       0.0, -25.0, -1406000.0)}
(2280, 2400)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="global-layers" class="level2">
<h2 class="anchored" data-anchor-id="global-layers">Global layers</h2>
<div id="cell-16" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure and axis with matplotlib</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="fl">7.5</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the raster</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>show(slope_global, transform<span class="op">=</span>raster_transform, ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the title and labels</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Raster with Geographic Coordinates'</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Longitude'</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Latitude'</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="going-between-cell-and-raster-coordinates" class="level3">
<h3 class="anchored" data-anchor-id="going-between-cell-and-raster-coordinates">Going between cell and raster coordinates</h3>
<div id="cell-18" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> <span class="fl">5.9e4</span>, <span class="op">-</span><span class="fl">1.447e6</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x, y)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>px, py <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x, y)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Round pixel coordinates to integers</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>px, py <span class="op">=</span> <span class="bu">int</span>(<span class="bu">round</span>(px)), <span class="bu">int</span>(<span class="bu">round</span>(py))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the pixel coordinates   </span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(px, py)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>59000.0 -1447000.0
2360 1640</code></pre>
</div>
</div>
</section>
</section>
<section id="subset-function" class="level2">
<h2 class="anchored" data-anchor-id="subset-function">Subset function</h2>
<div id="cell-20" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> subset_raster_with_padding_torch(raster_tensor, x, y, window_size, transform):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    px, py <span class="op">=</span> <span class="op">~</span>transform <span class="op">*</span> (x, y)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Round pixel coordinates to integers</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># px, py = int(round(px)), int(round(py)) # this will go to the cell adjacent when above 0.5 - which is NOT what we want</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    px, py <span class="op">=</span> <span class="bu">int</span>(px), <span class="bu">int</span>(py) <span class="co"># this will always round towards zero, therefore staying in the same cell</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define half the window size</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    half_window <span class="op">=</span> window_size <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the window boundaries</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    row_start <span class="op">=</span> py <span class="op">-</span> half_window</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    row_stop <span class="op">=</span> py <span class="op">+</span> half_window <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    col_start <span class="op">=</span> px <span class="op">-</span> half_window</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    col_stop <span class="op">=</span> px <span class="op">+</span> half_window <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the subset tensor with zeros (or any other padding value)</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> torch.full((window_size, window_size), <span class="op">-</span><span class="fl">1.0</span>, dtype<span class="op">=</span>raster_tensor.dtype)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the valid region within the raster bounds</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    valid_row_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, row_start)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    valid_row_stop <span class="op">=</span> <span class="bu">min</span>(raster_tensor.shape[<span class="dv">0</span>], row_stop)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    valid_col_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, col_start)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    valid_col_stop <span class="op">=</span> <span class="bu">min</span>(raster_tensor.shape[<span class="dv">1</span>], col_stop)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the corresponding region in the subset tensor</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    subset_row_start <span class="op">=</span> valid_row_start <span class="op">-</span> row_start</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    subset_row_stop <span class="op">=</span> subset_row_start <span class="op">+</span> (valid_row_stop <span class="op">-</span> valid_row_start)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    subset_col_start <span class="op">=</span> valid_col_start <span class="op">-</span> col_start</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    subset_col_stop <span class="op">=</span> subset_col_start <span class="op">+</span> (valid_col_stop <span class="op">-</span> valid_col_start)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Copy the valid region from the raster tensor to the subset tensor</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    subset[subset_row_start:subset_row_stop, subset_col_start:subset_col_stop] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        raster_tensor[valid_row_start:valid_row_stop, valid_col_start:valid_col_stop]</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> subset, col_start, row_start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Testing the subset function</p>
<div id="cell-22" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">2.8e4</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="op">-</span><span class="fl">1.43e6</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>window_size <span class="op">=</span> <span class="dv">101</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>which_ndvi <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ndvi_subset, origin_x, origin_y = subset_raster_with_padding_torch(ndvi_global_norm[which_ndvi,:,:], x, y, window_size, raster_transform)</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># canopy_subset, origin_x, origin_y = subset_raster_with_padding_torch(canopy_global_norm, x, y, window_size, raster_transform)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># herby_subset, origin_x, origin_y = subset_raster_with_padding_torch(herby_global_norm, x, y, window_size, raster_transform)</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># for sentinel 2 data</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>selected_month <span class="op">=</span> <span class="st">'2019_01'</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the normalized data for the selected month</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>s2_data <span class="op">=</span> data_dict[selected_month]</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the NumPy array to a PyTorch tensor</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>s2_tensor <span class="op">=</span> torch.from_numpy(s2_data)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>s2_tensor <span class="op">=</span> s2_tensor.<span class="bu">float</span>()  <span class="co"># Ensure the tensor is of type float</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(s2_tensor.shape)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>s2_b1_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">0</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>s2_b2_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">1</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>s2_b3_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">2</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>s2_b4_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">3</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>s2_b5_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">4</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>s2_b6_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">5</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>s2_b7_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">6</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>s2_b8_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">7</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>s2_b8a_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">8</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>s2_b9_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">9</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>s2_b11_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">10</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>s2_b12_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">11</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the subset</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].imshow(s2_b2_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Band 2 (blue) Subset'</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[0, 0].axis('off')</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].imshow(s2_b3_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Band 3 (green) Subset'</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="co"># # axs[0, 1].axis('off')</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].imshow(s2_b4_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Band 4 (red) Subset'</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="co"># # axs[1, 0].axis('off')</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].imshow(slope_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Slope Subset'</span>)</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[1, 1].axis('off')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([12, 2280, 2400])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Text(0.5, 1.0, 'Slope Subset')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="save-the-plots-individually" class="level3">
<h3 class="anchored" data-anchor-id="save-the-plots-individually">Save the plots individually</h3>
<div id="cell-24" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="ss">f'outputs/s2_plots'</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># RGB for plotting</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pull out the RGB bands</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>r_band <span class="op">=</span> s2_b4_subset.detach().numpy()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>g_band <span class="op">=</span> s2_b3_subset.detach().numpy()</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>b_band <span class="op">=</span> s2_b2_subset.detach().numpy()</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Reverse the normalization process using the original min and max values</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>r_band <span class="op">=</span> r_band <span class="op">*</span> (band_normalization[<span class="st">"Band4"</span>][<span class="st">"max"</span>] <span class="op">-</span> band_normalization[<span class="st">"Band4"</span>][<span class="st">"min"</span>]) <span class="op">+</span> band_normalization[<span class="st">"Band4"</span>][<span class="st">"min"</span>]</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>g_band <span class="op">=</span> g_band <span class="op">*</span> (band_normalization[<span class="st">"Band3"</span>][<span class="st">"max"</span>] <span class="op">-</span> band_normalization[<span class="st">"Band3"</span>][<span class="st">"min"</span>]) <span class="op">+</span> band_normalization[<span class="st">"Band3"</span>][<span class="st">"min"</span>]</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>b_band <span class="op">=</span> b_band <span class="op">*</span> (band_normalization[<span class="st">"Band2"</span>][<span class="st">"max"</span>] <span class="op">-</span> band_normalization[<span class="st">"Band2"</span>][<span class="st">"min"</span>]) <span class="op">+</span> band_normalization[<span class="st">"Band2"</span>][<span class="st">"min"</span>]</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack the bands along a new axis; here, -1 is used for the channel axis in NumPy</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>rgb_image <span class="op">=</span> np.stack([r_band, g_band, b_band], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> np.percentile(rgb_image, <span class="dv">1</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>p99 <span class="op">=</span> np.percentile(rgb_image, <span class="dv">99</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>rgb_image <span class="op">=</span> np.clip(rgb_image, p1, p99)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>rgb_image <span class="op">=</span> (rgb_image <span class="op">-</span> p1) <span class="op">/</span> (p99 <span class="op">-</span> p1)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> <span class="fl">1.1</span>  <span class="co"># Adjust gamma value as needed</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>rgb_image <span class="op">=</span> np.power(rgb_image, gamma)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot s2_b2</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>plt.imshow(rgb_image)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Sentinel 2 RGB'</span>)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/rgb_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co"># fig_out.colorbar(im1, ax=axs_out[0, 0], shrink=0.7)</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the covariates</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b1_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 1 Subset'</span>)</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b1_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b2_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 2 (blue) Subset'</span>)</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b2_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b3_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 3 (green) Subset'</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b3_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b4_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 4 (red) Subset'</span>)</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b4_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b5_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 5 Subset'</span>)</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b5_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b6_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 6 Subset'</span>)</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b6_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b7_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 7 Subset'</span>)</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b7_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b8_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 8 Subset'</span>)</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b8_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b8a_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 8a Subset'</span>)</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b8a_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b9_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 9 Subset'</span>)</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b9_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b11_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 11 Subset'</span>)</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b11_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>plt.imshow(s2_b12_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Band 12 Subset'</span>)</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/s2_b12_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>plt.imshow(slope_subset.detach().numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Slope Subset'</span>)</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/slope_subset.png'</span>, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-13.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-15-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="running-the-model-on-the-subset-layers" class="level1">
<h1>Running the model on the subset layers</h1>
<section id="set-the-device-for-the-model" class="level3">
<h3 class="anchored" data-anchor-id="set-the-device-for-the-model">Set the device for the model</h3>
<div id="cell-27" class="cell" data-execution_count="50">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train on the GPU or on the CPU, if a GPU is not available</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span>) <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> torch.device(<span class="st">'cpu'</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using </span><span class="sc">{</span>device<span class="sc">}</span><span class="ss"> device"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Using cpu device</code></pre>
</div>
</div>
</section>
</section>
<section id="define-the-model" class="level1">
<h1>Define the model</h1>
<div id="cell-29" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Conv2d_block_toFC(nn.Module):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Conv2d_block_toFC, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_channels <span class="op">=</span> params.input_channels</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_channels <span class="op">=</span> params.output_channels</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size <span class="op">=</span> params.kernel_size</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride <span class="op">=</span> params.stride</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size_mp <span class="op">=</span> params.kernel_size_mp</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride_mp <span class="op">=</span> params.stride_mp</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.padding <span class="op">=</span> params.padding</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2d <span class="op">=</span> nn.Sequential(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.input_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        nn.MaxPool2d(kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size_mp, stride<span class="op">=</span><span class="va">self</span>.stride_mp),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.output_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        nn.MaxPool2d(kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size_mp, stride<span class="op">=</span><span class="va">self</span>.stride_mp),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        nn.Flatten())</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.conv2d(x)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Conv2d_block_spatial(nn.Module):</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Conv2d_block_spatial, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_channels <span class="op">=</span> params.input_channels</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_channels <span class="op">=</span> params.output_channels</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size <span class="op">=</span> params.kernel_size</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride <span class="op">=</span> params.stride</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.kernel_size_mp = params.kernel_size_mp</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.stride_mp = params.stride_mp</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.padding <span class="op">=</span> params.padding</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2d <span class="op">=</span> nn.Sequential(</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.input_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.output_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.output_channels, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("Shape before squeeze:", self.conv2d(x).shape)</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>        conv2d_spatial <span class="op">=</span> <span class="va">self</span>.conv2d(x).squeeze(dim <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("Shape before logsumexp:", conv2d_spatial.shape)</span></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise before combining with the movement grid</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>        conv2d_spatial <span class="op">=</span> conv2d_spatial <span class="op">-</span> torch.logsumexp(conv2d_spatial, dim <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># conv2d_spatial = conv2d_spatial/torch.sum(conv2d_spatial)</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conv2d_spatial</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FCN_block_all_habitat(nn.Module):</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FCN_block_all_habitat, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_all <span class="op">=</span> params.dense_dim_in_all</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> params.dense_dim_hidden</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> params.dense_dim_out</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> params.dropout</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffn <span class="op">=</span> nn.Sequential(</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_in_all, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.image_dim <span class="op">*</span> <span class="va">self</span>.image_dim)</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.ffn(x)</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FCN_block_all_movement(nn.Module):</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FCN_block_all_movement, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_all <span class="op">=</span> params.dense_dim_in_all</span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> params.dense_dim_hidden</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> params.dense_dim_out</span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_movement_params <span class="op">=</span> params.num_movement_params</span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> params.dropout</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffn <span class="op">=</span> nn.Sequential(</span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_in_all, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.num_movement_params)</span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-108"><a href="#cb27-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-109"><a href="#cb27-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-110"><a href="#cb27-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.ffn(x)</span>
<span id="cb27-111"><a href="#cb27-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-112"><a href="#cb27-112" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FCN_block_nonspatial(nn.Module):</span>
<span id="cb27-113"><a href="#cb27-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-114"><a href="#cb27-114" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FCN_block_nonspatial, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-115"><a href="#cb27-115" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-116"><a href="#cb27-116" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_nonspatial <span class="op">=</span> params.dense_dim_in_nonspatial</span>
<span id="cb27-117"><a href="#cb27-117" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> params.dense_dim_hidden</span>
<span id="cb27-118"><a href="#cb27-118" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> params.dense_dim_out</span>
<span id="cb27-119"><a href="#cb27-119" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-120"><a href="#cb27-120" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-121"><a href="#cb27-121" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> params.dropout</span>
<span id="cb27-122"><a href="#cb27-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-123"><a href="#cb27-123" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffn <span class="op">=</span> nn.Sequential(</span>
<span id="cb27-124"><a href="#cb27-124" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_in_nonspatial, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb27-125"><a href="#cb27-125" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb27-126"><a href="#cb27-126" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb27-127"><a href="#cb27-127" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb27-128"><a href="#cb27-128" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb27-129"><a href="#cb27-129" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb27-130"><a href="#cb27-130" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_out)</span>
<span id="cb27-131"><a href="#cb27-131" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-132"><a href="#cb27-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-133"><a href="#cb27-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-134"><a href="#cb27-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.ffn(x)</span>
<span id="cb27-135"><a href="#cb27-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-136"><a href="#cb27-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-137"><a href="#cb27-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-138"><a href="#cb27-138" aria-hidden="true" tabindex="-1"></a><span class="co">##################################################</span></span>
<span id="cb27-139"><a href="#cb27-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixture of two Gamma and von Mises distributions with the von Mises mu parameters allowed to vary</span></span>
<span id="cb27-140"><a href="#cb27-140" aria-hidden="true" tabindex="-1"></a><span class="co">##################################################</span></span>
<span id="cb27-141"><a href="#cb27-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-142"><a href="#cb27-142" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Params_to_Grid_Block(nn.Module):</span>
<span id="cb27-143"><a href="#cb27-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-144"><a href="#cb27-144" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Params_to_Grid_Block, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-145"><a href="#cb27-145" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-146"><a href="#cb27-146" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-147"><a href="#cb27-147" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pixel_size <span class="op">=</span> params.pixel_size</span>
<span id="cb27-148"><a href="#cb27-148" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.center <span class="op">=</span> <span class="va">self</span>.image_dim <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb27-149"><a href="#cb27-149" aria-hidden="true" tabindex="-1"></a>        y, x <span class="op">=</span> np.indices((<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim))</span>
<span id="cb27-150"><a href="#cb27-150" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_layer <span class="op">=</span> torch.from_numpy(np.sqrt((<span class="va">self</span>.pixel_size<span class="op">*</span>(x <span class="op">-</span> <span class="va">self</span>.center))<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (<span class="va">self</span>.pixel_size<span class="op">*</span>(y <span class="op">-</span> <span class="va">self</span>.center))<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb27-151"><a href="#cb27-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># change the centre cell to the average distance from the centre to the edge of the pixel</span></span>
<span id="cb27-152"><a href="#cb27-152" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_layer[<span class="va">self</span>.center, <span class="va">self</span>.center] <span class="op">=</span> <span class="fl">0.56</span><span class="op">*</span><span class="va">self</span>.pixel_size <span class="co"># average distance from the centre to the perimeter of the pixel (accounting for longer distances at the corners)</span></span>
<span id="cb27-153"><a href="#cb27-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.bearing_layer = torch.from_numpy(np.arctan2(y - self.center, x - self.center))</span></span>
<span id="cb27-154"><a href="#cb27-154" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bearing_layer <span class="op">=</span> torch.from_numpy(np.arctan2(<span class="va">self</span>.center <span class="op">-</span> y, x <span class="op">-</span> <span class="va">self</span>.center))</span>
<span id="cb27-155"><a href="#cb27-155" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-156"><a href="#cb27-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-157"><a href="#cb27-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-158"><a href="#cb27-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gamma desnities for the mixture distribution</span></span>
<span id="cb27-159"><a href="#cb27-159" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gamma_density(<span class="va">self</span>, x, shape, scale):</span>
<span id="cb27-160"><a href="#cb27-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure all tensors are on the same device as x</span></span>
<span id="cb27-161"><a href="#cb27-161" aria-hidden="true" tabindex="-1"></a>        shape <span class="op">=</span> shape.to(x.device)</span>
<span id="cb27-162"><a href="#cb27-162" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> scale.to(x.device)</span>
<span id="cb27-163"><a href="#cb27-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span>torch.lgamma(shape) <span class="op">-</span>shape<span class="op">*</span>torch.log(scale) <span class="op">+</span> (shape <span class="op">-</span> <span class="dv">1</span>)<span class="op">*</span>torch.log(x) <span class="op">-</span> x<span class="op">/</span>scale</span>
<span id="cb27-164"><a href="#cb27-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-165"><a href="#cb27-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># von Mises densities for the mixture distribution</span></span>
<span id="cb27-166"><a href="#cb27-166" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vonmises_density(<span class="va">self</span>, x, kappa, vm_mu):</span>
<span id="cb27-167"><a href="#cb27-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure all tensors are on the same device as x</span></span>
<span id="cb27-168"><a href="#cb27-168" aria-hidden="true" tabindex="-1"></a>        kappa <span class="op">=</span> kappa.to(x.device)</span>
<span id="cb27-169"><a href="#cb27-169" aria-hidden="true" tabindex="-1"></a>        vm_mu <span class="op">=</span> vm_mu.to(x.device)</span>
<span id="cb27-170"><a href="#cb27-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> kappa<span class="op">*</span>torch.cos(x <span class="op">-</span> vm_mu) <span class="op">-</span> <span class="dv">1</span><span class="op">*</span>(np.log(<span class="dv">2</span><span class="op">*</span>torch.pi) <span class="op">+</span> torch.log(torch.special.i0(kappa)))</span>
<span id="cb27-171"><a href="#cb27-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-172"><a href="#cb27-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-173"><a href="#cb27-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, bearing):</span>
<span id="cb27-174"><a href="#cb27-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-175"><a href="#cb27-175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the first mixture distribution</span></span>
<span id="cb27-176"><a href="#cb27-176" aria-hidden="true" tabindex="-1"></a>        gamma_shape1 <span class="op">=</span> torch.exp(x[:, <span class="dv">0</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-177"><a href="#cb27-177" aria-hidden="true" tabindex="-1"></a>        gamma_shape1 <span class="op">=</span> gamma_shape1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-178"><a href="#cb27-178" aria-hidden="true" tabindex="-1"></a>        gamma_shape1 <span class="op">=</span> gamma_shape1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-179"><a href="#cb27-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-180"><a href="#cb27-180" aria-hidden="true" tabindex="-1"></a>        gamma_scale1 <span class="op">=</span> torch.exp(x[:, <span class="dv">1</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-181"><a href="#cb27-181" aria-hidden="true" tabindex="-1"></a>        gamma_scale1 <span class="op">=</span> gamma_scale1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-182"><a href="#cb27-182" aria-hidden="true" tabindex="-1"></a>        gamma_scale1 <span class="op">=</span> gamma_scale1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-183"><a href="#cb27-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-184"><a href="#cb27-184" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> torch.exp(x[:, <span class="dv">2</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-185"><a href="#cb27-185" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> gamma_weight1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-186"><a href="#cb27-186" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> gamma_weight1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-187"><a href="#cb27-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-188"><a href="#cb27-188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the second mixture distribution</span></span>
<span id="cb27-189"><a href="#cb27-189" aria-hidden="true" tabindex="-1"></a>        gamma_shape2 <span class="op">=</span> torch.exp(x[:, <span class="dv">3</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-190"><a href="#cb27-190" aria-hidden="true" tabindex="-1"></a>        gamma_shape2 <span class="op">=</span> gamma_shape2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-191"><a href="#cb27-191" aria-hidden="true" tabindex="-1"></a>        gamma_shape2 <span class="op">=</span> gamma_shape2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-192"><a href="#cb27-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-193"><a href="#cb27-193" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> torch.exp(x[:, <span class="dv">4</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-194"><a href="#cb27-194" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> gamma_scale2 <span class="op">*</span> <span class="dv">500</span> <span class="co">### to transform the scale parameter to be near 1</span></span>
<span id="cb27-195"><a href="#cb27-195" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> gamma_scale2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-196"><a href="#cb27-196" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> gamma_scale2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-197"><a href="#cb27-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-198"><a href="#cb27-198" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> torch.exp(x[:, <span class="dv">5</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-199"><a href="#cb27-199" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> gamma_weight2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-200"><a href="#cb27-200" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> gamma_weight2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-201"><a href="#cb27-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-202"><a href="#cb27-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply softmax to the weights</span></span>
<span id="cb27-203"><a href="#cb27-203" aria-hidden="true" tabindex="-1"></a>        gamma_weights <span class="op">=</span> torch.stack([gamma_weight1, gamma_weight2], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-204"><a href="#cb27-204" aria-hidden="true" tabindex="-1"></a>        gamma_weights <span class="op">=</span> torch.nn.functional.softmax(gamma_weights, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-205"><a href="#cb27-205" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> gamma_weights[<span class="dv">0</span>]</span>
<span id="cb27-206"><a href="#cb27-206" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> gamma_weights[<span class="dv">1</span>]</span>
<span id="cb27-207"><a href="#cb27-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-208"><a href="#cb27-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculation of Gamma densities</span></span>
<span id="cb27-209"><a href="#cb27-209" aria-hidden="true" tabindex="-1"></a>        gamma_density_layer1 <span class="op">=</span> <span class="va">self</span>.gamma_density(<span class="va">self</span>.distance_layer, gamma_shape1, gamma_scale1).to(device)</span>
<span id="cb27-210"><a href="#cb27-210" aria-hidden="true" tabindex="-1"></a>        gamma_density_layer2 <span class="op">=</span> <span class="va">self</span>.gamma_density(<span class="va">self</span>.distance_layer, gamma_shape2, gamma_scale2).to(device)</span>
<span id="cb27-211"><a href="#cb27-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-212"><a href="#cb27-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combining both densities to create a mixture distribution using logsumexp</span></span>
<span id="cb27-213"><a href="#cb27-213" aria-hidden="true" tabindex="-1"></a>        logsumexp_gamma_corr <span class="op">=</span> torch.<span class="bu">max</span>(gamma_density_layer1, gamma_density_layer2)</span>
<span id="cb27-214"><a href="#cb27-214" aria-hidden="true" tabindex="-1"></a>        gamma_density_layer <span class="op">=</span> logsumexp_gamma_corr <span class="op">+</span> torch.log(gamma_weight1 <span class="op">*</span> torch.exp(gamma_density_layer1 <span class="op">-</span> logsumexp_gamma_corr) <span class="op">+</span> gamma_weight2 <span class="op">*</span> torch.exp(gamma_density_layer2 <span class="op">-</span> logsumexp_gamma_corr))</span>
<span id="cb27-215"><a href="#cb27-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(gamma_density_layer))</span></span>
<span id="cb27-216"><a href="#cb27-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(gamma_density_layer)))</span></span>
<span id="cb27-217"><a href="#cb27-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-218"><a href="#cb27-218" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise the gamma weights so they sum to 1</span></span>
<span id="cb27-219"><a href="#cb27-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># gamma_density_layer = gamma_density_layer - torch.logsumexp(gamma_density_layer, dim = (1, 2), keepdim = True)</span></span>
<span id="cb27-220"><a href="#cb27-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-221"><a href="#cb27-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(gamma_density_layer))</span></span>
<span id="cb27-222"><a href="#cb27-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(gamma_density_layer)))</span></span>
<span id="cb27-223"><a href="#cb27-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-224"><a href="#cb27-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-225"><a href="#cb27-225" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Von Mises Distributions</span></span>
<span id="cb27-226"><a href="#cb27-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-227"><a href="#cb27-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate the new bearing from the turning angle</span></span>
<span id="cb27-228"><a href="#cb27-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># takes in the bearing from the previous step and adds the turning angle</span></span>
<span id="cb27-229"><a href="#cb27-229" aria-hidden="true" tabindex="-1"></a>        bearing_new1 <span class="op">=</span> x[:, <span class="dv">6</span>] <span class="op">+</span> bearing[:, <span class="dv">0</span>]</span>
<span id="cb27-230"><a href="#cb27-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing_new1 = 0.0 + bearing[:, 0]</span></span>
<span id="cb27-231"><a href="#cb27-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-232"><a href="#cb27-232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Bearing.shape ', bearing.shape)</span></span>
<span id="cb27-233"><a href="#cb27-233" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Bearing[:, 0].shape ', bearing[:, 0].shape)</span></span>
<span id="cb27-234"><a href="#cb27-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Bearing[:, 0] ', bearing[:, 0])</span></span>
<span id="cb27-235"><a href="#cb27-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the new bearing becomes the mean of the von Mises distribution</span></span>
<span id="cb27-236"><a href="#cb27-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the estimated parameter [x:, 7] is the turning angle of the next step</span></span>
<span id="cb27-237"><a href="#cb27-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># which is always in reference to the input bearing</span></span>
<span id="cb27-238"><a href="#cb27-238" aria-hidden="true" tabindex="-1"></a>        vonmises_mu1 <span class="op">=</span> bearing_new1.unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-239"><a href="#cb27-239" aria-hidden="true" tabindex="-1"></a>        vonmises_mu1 <span class="op">=</span> vonmises_mu1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-240"><a href="#cb27-240" aria-hidden="true" tabindex="-1"></a>        vonmises_mu1 <span class="op">=</span> vonmises_mu1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-241"><a href="#cb27-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-242"><a href="#cb27-242" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the first von Mises distribution</span></span>
<span id="cb27-243"><a href="#cb27-243" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa1 <span class="op">=</span> torch.exp(x[:, <span class="dv">7</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-244"><a href="#cb27-244" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa1 <span class="op">=</span> vonmises_kappa1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-245"><a href="#cb27-245" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa1 <span class="op">=</span> vonmises_kappa1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-246"><a href="#cb27-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-247"><a href="#cb27-247" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> torch.exp(x[:, <span class="dv">8</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-248"><a href="#cb27-248" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> vonmises_weight1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-249"><a href="#cb27-249" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> vonmises_weight1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-250"><a href="#cb27-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-251"><a href="#cb27-251" aria-hidden="true" tabindex="-1"></a>        <span class="co"># vm_mu and weight for the second von Mises distribution</span></span>
<span id="cb27-252"><a href="#cb27-252" aria-hidden="true" tabindex="-1"></a>        bearing_new2 <span class="op">=</span> x[:, <span class="dv">9</span>] <span class="op">+</span> bearing[:, <span class="dv">0</span>]</span>
<span id="cb27-253"><a href="#cb27-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing_new2 = torch.pi + bearing[:, 0]</span></span>
<span id="cb27-254"><a href="#cb27-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing_new2 = -torch.pi + bearing[:, 0]</span></span>
<span id="cb27-255"><a href="#cb27-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-256"><a href="#cb27-256" aria-hidden="true" tabindex="-1"></a>        vonmises_mu2 <span class="op">=</span> bearing_new2.unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-257"><a href="#cb27-257" aria-hidden="true" tabindex="-1"></a>        vonmises_mu2 <span class="op">=</span> vonmises_mu2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-258"><a href="#cb27-258" aria-hidden="true" tabindex="-1"></a>        vonmises_mu2 <span class="op">=</span> vonmises_mu2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-259"><a href="#cb27-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-260"><a href="#cb27-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the second von Mises distribution</span></span>
<span id="cb27-261"><a href="#cb27-261" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa2 <span class="op">=</span> torch.exp(x[:, <span class="dv">10</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-262"><a href="#cb27-262" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa2 <span class="op">=</span> vonmises_kappa2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-263"><a href="#cb27-263" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa2 <span class="op">=</span> vonmises_kappa2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-264"><a href="#cb27-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-265"><a href="#cb27-265" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> torch.exp(x[:, <span class="dv">11</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb27-266"><a href="#cb27-266" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> vonmises_weight2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb27-267"><a href="#cb27-267" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> vonmises_weight2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb27-268"><a href="#cb27-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-269"><a href="#cb27-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply softmax to the weights</span></span>
<span id="cb27-270"><a href="#cb27-270" aria-hidden="true" tabindex="-1"></a>        vonmises_weights <span class="op">=</span> torch.stack([vonmises_weight1, vonmises_weight2], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-271"><a href="#cb27-271" aria-hidden="true" tabindex="-1"></a>        vonmises_weights <span class="op">=</span> torch.nn.functional.softmax(vonmises_weights, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-272"><a href="#cb27-272" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> vonmises_weights[<span class="dv">0</span>]</span>
<span id="cb27-273"><a href="#cb27-273" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> vonmises_weights[<span class="dv">1</span>]</span>
<span id="cb27-274"><a href="#cb27-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-275"><a href="#cb27-275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculation of von Mises densities</span></span>
<span id="cb27-276"><a href="#cb27-276" aria-hidden="true" tabindex="-1"></a>        vonmises_density_layer1 <span class="op">=</span> <span class="va">self</span>.vonmises_density(<span class="va">self</span>.bearing_layer, vonmises_kappa1, vonmises_mu1).to(device)</span>
<span id="cb27-277"><a href="#cb27-277" aria-hidden="true" tabindex="-1"></a>        vonmises_density_layer2 <span class="op">=</span> <span class="va">self</span>.vonmises_density(<span class="va">self</span>.bearing_layer, vonmises_kappa2, vonmises_mu2).to(device)</span>
<span id="cb27-278"><a href="#cb27-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-279"><a href="#cb27-279" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combining both densities to create a mixture distribution using the logsumexp trick</span></span>
<span id="cb27-280"><a href="#cb27-280" aria-hidden="true" tabindex="-1"></a>        logsumexp_vm_corr <span class="op">=</span> torch.<span class="bu">max</span>(vonmises_density_layer1, vonmises_density_layer2)</span>
<span id="cb27-281"><a href="#cb27-281" aria-hidden="true" tabindex="-1"></a>        vonmises_density_layer <span class="op">=</span> logsumexp_vm_corr <span class="op">+</span> torch.log(vonmises_weight1 <span class="op">*</span> torch.exp(vonmises_density_layer1 <span class="op">-</span> logsumexp_vm_corr) <span class="op">+</span> vonmises_weight2 <span class="op">*</span> torch.exp(vonmises_density_layer2 <span class="op">-</span> logsumexp_vm_corr))</span>
<span id="cb27-282"><a href="#cb27-282" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(vonmises_density_layer))</span></span>
<span id="cb27-283"><a href="#cb27-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(vonmises_density_layer)))</span></span>
<span id="cb27-284"><a href="#cb27-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-285"><a href="#cb27-285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise so the densities sum to 1 when exponentiated</span></span>
<span id="cb27-286"><a href="#cb27-286" aria-hidden="true" tabindex="-1"></a>        <span class="co"># vonmises_density_layer = vonmises_density_layer - torch.logsumexp(vonmises_density_layer, dim = (1, 2), keepdim = True)</span></span>
<span id="cb27-287"><a href="#cb27-287" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(vonmises_density_layer))</span></span>
<span id="cb27-288"><a href="#cb27-288" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(vonmises_density_layer)))</span></span>
<span id="cb27-289"><a href="#cb27-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-290"><a href="#cb27-290" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combining the two distributions</span></span>
<span id="cb27-291"><a href="#cb27-291" aria-hidden="true" tabindex="-1"></a>        movement_grid <span class="op">=</span> gamma_density_layer <span class="op">+</span> vonmises_density_layer <span class="co"># Gamma and von Mises densities are on the log-scale</span></span>
<span id="cb27-292"><a href="#cb27-292" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Movement grid ', torch.sum(movement_grid))</span></span>
<span id="cb27-293"><a href="#cb27-293" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(movement_grid)))</span></span>
<span id="cb27-294"><a href="#cb27-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-295"><a href="#cb27-295" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise before combining with the habitat predictions</span></span>
<span id="cb27-296"><a href="#cb27-296" aria-hidden="true" tabindex="-1"></a>        movement_grid <span class="op">=</span> movement_grid <span class="op">-</span> torch.logsumexp(movement_grid, dim <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb27-297"><a href="#cb27-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-298"><a href="#cb27-298" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Movement grid norm ', torch.sum(movement_grid))</span></span>
<span id="cb27-299"><a href="#cb27-299" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(movement_grid)))</span></span>
<span id="cb27-300"><a href="#cb27-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-301"><a href="#cb27-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> movement_grid</span>
<span id="cb27-302"><a href="#cb27-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-303"><a href="#cb27-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-304"><a href="#cb27-304" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Scalar_to_Grid_Block(nn.Module):</span>
<span id="cb27-305"><a href="#cb27-305" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-306"><a href="#cb27-306" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Scalar_to_Grid_Block, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-307"><a href="#cb27-307" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-308"><a href="#cb27-308" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-309"><a href="#cb27-309" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-310"><a href="#cb27-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-311"><a href="#cb27-311" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-312"><a href="#cb27-312" aria-hidden="true" tabindex="-1"></a>        num_scalars <span class="op">=</span> x.shape[<span class="dv">1</span>]</span>
<span id="cb27-313"><a href="#cb27-313" aria-hidden="true" tabindex="-1"></a>        scalar_map <span class="op">=</span> x.view(x.shape[<span class="dv">0</span>], num_scalars, <span class="dv">1</span>, <span class="dv">1</span>).expand(x.shape[<span class="dv">0</span>], num_scalars, <span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim)</span>
<span id="cb27-314"><a href="#cb27-314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scalar_map</span>
<span id="cb27-315"><a href="#cb27-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-316"><a href="#cb27-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-317"><a href="#cb27-317" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Vector_to_Grid_Block(nn.Module):</span>
<span id="cb27-318"><a href="#cb27-318" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-319"><a href="#cb27-319" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Vector_to_Grid_Block, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-320"><a href="#cb27-320" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb27-321"><a href="#cb27-321" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb27-322"><a href="#cb27-322" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-323"><a href="#cb27-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-324"><a href="#cb27-324" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-325"><a href="#cb27-325" aria-hidden="true" tabindex="-1"></a>        x_unnorm <span class="op">=</span> x.reshape(x.shape[<span class="dv">0</span>], <span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim)</span>
<span id="cb27-326"><a href="#cb27-326" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x_unnorm <span class="op">-</span> torch.logsumexp(x_unnorm, dim <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb27-327"><a href="#cb27-327" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb27-328"><a href="#cb27-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-329"><a href="#cb27-329" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x = x_unnorm/torch.sum(x_unnorm)</span></span>
<span id="cb27-330"><a href="#cb27-330" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return x</span></span>
<span id="cb27-331"><a href="#cb27-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-332"><a href="#cb27-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-333"><a href="#cb27-333" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConvJointModel(nn.Module):</span>
<span id="cb27-334"><a href="#cb27-334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb27-335"><a href="#cb27-335" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(ConvJointModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb27-336"><a href="#cb27-336" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.conv_habitat = Conv2d_block(params)</span></span>
<span id="cb27-337"><a href="#cb27-337" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.fcn_habitat_all = FCN_block_all_habitat(params)</span></span>
<span id="cb27-338"><a href="#cb27-338" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.fcn_habitat_nonspatial = FCN_block_nonspatial(params)</span></span>
<span id="cb27-339"><a href="#cb27-339" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.habitat_grid_output = Vector_to_Grid_Block(params)</span></span>
<span id="cb27-340"><a href="#cb27-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-341"><a href="#cb27-341" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scalar_grid_output <span class="op">=</span> Scalar_to_Grid_Block(params)</span>
<span id="cb27-342"><a href="#cb27-342" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_habitat <span class="op">=</span> Conv2d_block_spatial(params)</span>
<span id="cb27-343"><a href="#cb27-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-344"><a href="#cb27-344" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_movement <span class="op">=</span> Conv2d_block_toFC(params)</span>
<span id="cb27-345"><a href="#cb27-345" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fcn_movement_all <span class="op">=</span> FCN_block_all_movement(params)</span>
<span id="cb27-346"><a href="#cb27-346" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fcn_movement_nonspatial <span class="op">=</span> FCN_block_nonspatial(params)</span>
<span id="cb27-347"><a href="#cb27-347" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.movement_grid_output <span class="op">=</span> Params_to_Grid_Block(params)</span>
<span id="cb27-348"><a href="#cb27-348" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb27-349"><a href="#cb27-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-350"><a href="#cb27-350" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb27-351"><a href="#cb27-351" aria-hidden="true" tabindex="-1"></a>        spatial_data_x <span class="op">=</span> x[<span class="dv">0</span>]</span>
<span id="cb27-352"><a href="#cb27-352" aria-hidden="true" tabindex="-1"></a>        scalars_to_grid <span class="op">=</span> x[<span class="dv">1</span>]</span>
<span id="cb27-353"><a href="#cb27-353" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional_data_x = x[2]</span></span>
<span id="cb27-354"><a href="#cb27-354" aria-hidden="true" tabindex="-1"></a>        bearing_x <span class="op">=</span> x[<span class="dv">2</span>]</span>
<span id="cb27-355"><a href="#cb27-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-356"><a href="#cb27-356" aria-hidden="true" tabindex="-1"></a>        <span class="co"># conv_habitat = self.conv_habitat(spatial_data_x)</span></span>
<span id="cb27-357"><a href="#cb27-357" aria-hidden="true" tabindex="-1"></a>        <span class="co"># covariates_habitat = self.fcn_habitat_nonspatial(additional_data_x)</span></span>
<span id="cb27-358"><a href="#cb27-358" aria-hidden="true" tabindex="-1"></a>        <span class="co"># all_predictors_habitat = torch.cat([conv_habitat, covariates_habitat], dim = 1)</span></span>
<span id="cb27-359"><a href="#cb27-359" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # print(f"Shape after concatenation: {all_predictors_habitat.shape}")  # Debugging print</span></span>
<span id="cb27-360"><a href="#cb27-360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output_habitat = self.fcn_habitat_all(all_predictors_habitat)</span></span>
<span id="cb27-361"><a href="#cb27-361" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output_habitat = self.habitat_grid_output(output_habitat)</span></span>
<span id="cb27-362"><a href="#cb27-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-363"><a href="#cb27-363" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SCALAR GRIDS</span></span>
<span id="cb27-364"><a href="#cb27-364" aria-hidden="true" tabindex="-1"></a>        scalar_grids <span class="op">=</span> <span class="va">self</span>.scalar_grid_output(scalars_to_grid)</span>
<span id="cb27-365"><a href="#cb27-365" aria-hidden="true" tabindex="-1"></a>        all_spatial <span class="op">=</span> torch.cat([spatial_data_x, scalar_grids], dim <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb27-366"><a href="#cb27-366" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after scalar grid: {all_spatial.shape}")  # Debugging print</span></span>
<span id="cb27-367"><a href="#cb27-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-368"><a href="#cb27-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-369"><a href="#cb27-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># HABITAT SELECTION</span></span>
<span id="cb27-370"><a href="#cb27-370" aria-hidden="true" tabindex="-1"></a>        output_habitat <span class="op">=</span> <span class="va">self</span>.conv_habitat(all_spatial)</span>
<span id="cb27-371"><a href="#cb27-371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after CNN habitat: {output_habitat.shape}")  # Debugging print</span></span>
<span id="cb27-372"><a href="#cb27-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-373"><a href="#cb27-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-374"><a href="#cb27-374" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MOVEMENT</span></span>
<span id="cb27-375"><a href="#cb27-375" aria-hidden="true" tabindex="-1"></a>        conv_movement <span class="op">=</span> <span class="va">self</span>.conv_movement(all_spatial)</span>
<span id="cb27-376"><a href="#cb27-376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after CNN to FC movement: {conv_movement.shape}")  # Debugging print</span></span>
<span id="cb27-377"><a href="#cb27-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-378"><a href="#cb27-378" aria-hidden="true" tabindex="-1"></a>        <span class="co"># covariates_movement = self.fcn_movement_nonspatial(additional_data_x)</span></span>
<span id="cb27-379"><a href="#cb27-379" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after fcn_movement_nonspatial: {covariates_movement.shape}")  # Debugging print</span></span>
<span id="cb27-380"><a href="#cb27-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-381"><a href="#cb27-381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># all_predictors_movement = torch.cat([conv_movement, covariates_movement], dim = 1)</span></span>
<span id="cb27-382"><a href="#cb27-382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after torch.cat([conv_movement, covariates_movement], dim = 1): {all_predictors_movement.shape}")  # Debugging print</span></span>
<span id="cb27-383"><a href="#cb27-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-384"><a href="#cb27-384" aria-hidden="true" tabindex="-1"></a>        output_movement <span class="op">=</span> <span class="va">self</span>.fcn_movement_all(conv_movement)</span>
<span id="cb27-385"><a href="#cb27-385" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after fcn_movement_all: {output_movement.shape}")  # Debugging print</span></span>
<span id="cb27-386"><a href="#cb27-386" aria-hidden="true" tabindex="-1"></a>        output_movement <span class="op">=</span> <span class="va">self</span>.movement_grid_output(output_movement, bearing_x)</span>
<span id="cb27-387"><a href="#cb27-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after CNN movement: {output_movement.shape}")  # Debugging print</span></span>
<span id="cb27-388"><a href="#cb27-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-389"><a href="#cb27-389" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combine the habitat and movement predictions</span></span>
<span id="cb27-390"><a href="#cb27-390" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> torch.stack((output_habitat, output_movement), dim <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb27-391"><a href="#cb27-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb27-392"><a href="#cb27-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-393"><a href="#cb27-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-394"><a href="#cb27-394" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelParams():</span>
<span id="cb27-395"><a href="#cb27-395" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dict_params):</span>
<span id="cb27-396"><a href="#cb27-396" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb27-397"><a href="#cb27-397" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> dict_params[<span class="st">"image_dim"</span>]</span>
<span id="cb27-398"><a href="#cb27-398" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pixel_size <span class="op">=</span> dict_params[<span class="st">"pixel_size"</span>]</span>
<span id="cb27-399"><a href="#cb27-399" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb27-400"><a href="#cb27-400" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dim_in_nonspatial_to_grid <span class="op">=</span> dict_params[<span class="st">"dim_in_nonspatial_to_grid"</span>]</span>
<span id="cb27-401"><a href="#cb27-401" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_nonspatial <span class="op">=</span> dict_params[<span class="st">"dense_dim_in_nonspatial"</span>]</span>
<span id="cb27-402"><a href="#cb27-402" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> dict_params[<span class="st">"dense_dim_hidden"</span>]</span>
<span id="cb27-403"><a href="#cb27-403" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> dict_params[<span class="st">"dense_dim_out"</span>]</span>
<span id="cb27-404"><a href="#cb27-404" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb27-405"><a href="#cb27-405" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_all <span class="op">=</span> dict_params[<span class="st">"dense_dim_in_all"</span>]</span>
<span id="cb27-406"><a href="#cb27-406" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> dict_params[<span class="st">"dense_dim_hidden"</span>]</span>
<span id="cb27-407"><a href="#cb27-407" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> dict_params[<span class="st">"dense_dim_out"</span>]</span>
<span id="cb27-408"><a href="#cb27-408" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb27-409"><a href="#cb27-409" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_channels <span class="op">=</span> dict_params[<span class="st">"input_channels"</span>]</span>
<span id="cb27-410"><a href="#cb27-410" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_channels <span class="op">=</span> dict_params[<span class="st">"output_channels"</span>]</span>
<span id="cb27-411"><a href="#cb27-411" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size <span class="op">=</span> dict_params[<span class="st">"kernel_size"</span>]</span>
<span id="cb27-412"><a href="#cb27-412" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride <span class="op">=</span> dict_params[<span class="st">"stride"</span>]</span>
<span id="cb27-413"><a href="#cb27-413" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size_mp <span class="op">=</span> dict_params[<span class="st">"kernel_size_mp"</span>]</span>
<span id="cb27-414"><a href="#cb27-414" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride_mp <span class="op">=</span> dict_params[<span class="st">"stride_mp"</span>]</span>
<span id="cb27-415"><a href="#cb27-415" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.padding <span class="op">=</span> dict_params[<span class="st">"padding"</span>]</span>
<span id="cb27-416"><a href="#cb27-416" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> dict_params[<span class="st">"image_dim"</span>]</span>
<span id="cb27-417"><a href="#cb27-417" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_movement_params <span class="op">=</span> dict_params[<span class="st">"num_movement_params"</span>]</span>
<span id="cb27-418"><a href="#cb27-418" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> dict_params[<span class="st">"dropout"</span>]</span>
<span id="cb27-419"><a href="#cb27-419" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> dict_params[<span class="st">"device"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="instantiate-the-model" class="level2">
<h2 class="anchored" data-anchor-id="instantiate-the-model">Instantiate the model</h2>
<div id="cell-31" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>params_dict <span class="op">=</span> {<span class="st">"batch_size"</span>: <span class="dv">32</span>,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">"image_dim"</span>: <span class="dv">101</span>, <span class="co">#number of pixels along the edge of each local patch/image</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"pixel_size"</span>: <span class="dv">25</span>, <span class="co">#number of metres along the edge of a pixel</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dim_in_nonspatial_to_grid"</span>: <span class="dv">4</span>, <span class="co">#the number of scalar predictors that are converted to a grid and appended to the spatial features</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_in_nonspatial"</span>: <span class="dv">4</span>, <span class="co">#change this to however many other scalar predictors you have (bearing, velocity etc)</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_hidden"</span>: <span class="dv">128</span>, <span class="co">#number of nodes in the hidden layers</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_out"</span>: <span class="dv">128</span>, <span class="co">#number of nodes in the output of the fully connected block (FCN)</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_in_all"</span>: <span class="dv">2500</span>,<span class="co"># + 128, #number of inputs entering the fully connected block once the nonspatial features have been concatenated to the spatial features</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>               <span class="st">"input_channels"</span>: <span class="dv">13</span> <span class="op">+</span> <span class="dv">4</span>, <span class="co">#number of spatial layers in each image + number of scalar layers that are converted to a grid</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>               <span class="st">"output_channels"</span>: <span class="dv">4</span>, <span class="co">#number of filters to learn</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">"kernel_size"</span>: <span class="dv">3</span>, <span class="co">#the size of the 2D moving windows / kernels that are being learned</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">"stride"</span>: <span class="dv">1</span>, <span class="co">#the stride used when applying the kernel.  This reduces the dimension of the output if set to greater than 1</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>               <span class="st">"kernel_size_mp"</span>: <span class="dv">2</span>, <span class="co">#the size of the kernel that is used in max pooling operations</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>               <span class="st">"stride_mp"</span>: <span class="dv">2</span>, <span class="co">#the stride that is used in max pooling operations</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>               <span class="st">"padding"</span>: <span class="dv">1</span>, <span class="co">#the amount of padding to apply to images prior to applying the 2D convolution</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>               <span class="st">"num_movement_params"</span>: <span class="dv">12</span>, <span class="co">#number of parameters used to parameterise the movement kernel</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dropout"</span>: <span class="fl">0.1</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>               <span class="st">"device"</span>: device</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>               }</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> ModelParams(params_dict)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ConvJointModel(params).to(device)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># print(model)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-the-model-weights" class="level2">
<h2 class="anchored" data-anchor-id="load-the-model-weights">Load the model weights</h2>
<div id="cell-33" class="cell" data-execution_count="52">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># date of the trained model checkpoint</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>date <span class="op">=</span> <span class="st">'2024-10-24'</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # load the model weights</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(model.state_dict())</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(<span class="ss">f'model_checkpoints/checkpoint_CNN_S2_slope_buffalo</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">.pt'</span>, weights_only<span class="op">=</span><span class="va">True</span>, map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>)))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(model.state_dict())</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.eval()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>&lt;All keys matched successfully&gt;</code></pre>
</div>
</div>
</section>
<section id="setup-validation" class="level2">
<h2 class="anchored" data-anchor-id="setup-validation">Setup validation</h2>
<div id="cell-35" class="cell" data-execution_count="60">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping from day of the year to month index</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> day_to_month_index(day_of_year):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the year and the day within that year</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    base_date <span class="op">=</span> datetime(<span class="dv">2018</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> base_date <span class="op">+</span> timedelta(days<span class="op">=</span><span class="bu">int</span>(day_of_year) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    year_diff <span class="op">=</span> date.year <span class="op">-</span> base_date.year</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># month_index = (date.month - 1) + (year_diff * 12)  # month index (0-based, accounting for year change)</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    month_index <span class="op">=</span> (date.month) <span class="op">+</span> (year_diff <span class="op">*</span> <span class="dv">12</span>)  <span class="co"># month index (1-based)</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> month_index</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>yday <span class="op">=</span> <span class="dv">370</span> <span class="co"># NOT THE MONTH (due to 0 indexing) - but the index of the of month of the year to extract the appropriate monthly NDVI</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>month_index <span class="op">=</span> day_to_month_index(yday) </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(month_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>13</code></pre>
</div>
</div>
<div id="cell-36" class="cell" data-execution_count="61">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>window_size <span class="op">=</span> <span class="dv">101</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># starting location of buffalo 2005</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">41969.310875</span> </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="op">-</span><span class="fl">1.435671e+06</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>yday <span class="op">=</span> <span class="dv">280</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>month_index <span class="op">=</span> day_to_month_index(yday)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># for sentinel 2 data</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>selected_month <span class="op">=</span> <span class="ss">f'2019_</span><span class="sc">{</span>month_index<span class="sc">:02d}</span><span class="ss">'</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the normalized data for the selected month</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>s2_data <span class="op">=</span> data_dict[selected_month]</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the NumPy array to a PyTorch tensor</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>s2_tensor <span class="op">=</span> torch.from_numpy(s2_data)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>s2_tensor <span class="op">=</span> s2_tensor.<span class="bu">float</span>()  <span class="co"># Ensure the tensor is of type float</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(s2_tensor.shape)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>s2_b1_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">0</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>s2_b2_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">1</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>s2_b3_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">2</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>s2_b4_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">3</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>s2_b5_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">4</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>s2_b6_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">5</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>s2_b7_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">6</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>s2_b8_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">7</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>s2_b8a_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">8</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>s2_b9_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">9</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>s2_b11_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">10</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>s2_b12_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">11</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the subset</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].imshow(s2_b2_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Band 2 (blue) Subset'</span>)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[0, 0].axis('off')</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].imshow(s2_b3_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Band 3 (green) Subset'</span>)</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="co"># # axs[0, 1].axis('off')</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].imshow(s2_b4_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Band 4 (red) Subset'</span>)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="co"># # axs[1, 0].axis('off')</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].imshow(slope_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Slope Subset'</span>)</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[1, 1].axis('off')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([12, 2280, 2400])</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>Text(0.5, 1.0, 'Slope Subset')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-21-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="next-step-probability-values" class="level1">
<h1>Next-step probability values</h1>
<div id="cell-38" class="cell" data-execution_count="62">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test_data = buffalo_df.iloc[0:10]</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> buffalo_df</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(test_data)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># n = 4</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty vectors to store the predicted probabilities</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>habitat_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>move_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>next_step_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># start at 1 so the bearing at t - 1 is available</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n):</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  sample_tm1 <span class="op">=</span> test_data.iloc[i<span class="op">-</span><span class="dv">1</span>] <span class="co"># get the step at t - 1 for the bearing of the approaching step</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  sample <span class="op">=</span> test_data.iloc[i]</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current location (x1, y1)</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> sample[<span class="st">'x1_'</span>]</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> sample[<span class="st">'y1_'</span>]</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('x and y are ', x,y)</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  px, py <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x, y)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_x, new_y = raster_transform * (px, py)</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('px and py are ', px, py)</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next step location (x2, y2)</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>  x2 <span class="op">=</span> sample[<span class="st">'x2_'</span>]</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  y2 <span class="op">=</span> sample[<span class="st">'y2_'</span>]</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('x2 and y2 are ', x2, y2)</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  px2, py2 <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x2, y2)</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('px2 and py2 are ', px2, py2)</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # THE Y COORDINATE COMES FIRST in the sampled coordinates</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_px = origin_xs[0] + sampled_coordinates[1]</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_py = origin_ys[0] + sampled_coordinates[0]</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_x, new_y = raster_transform * (new_px, new_py)</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>  d_x <span class="op">=</span> x2 <span class="op">-</span> x</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>  d_y <span class="op">=</span> y2 <span class="op">-</span> y</span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('d_x and d_y are ', d_x, d_y)</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># temporal covariates</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>  hour_t2_sin <span class="op">=</span> sample[<span class="st">'hour_t2_sin'</span>]</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>  hour_t2_cos <span class="op">=</span> sample[<span class="st">'hour_t2_cos'</span>]</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>  yday_t2_sin <span class="op">=</span> sample[<span class="st">'yday_t2_sin'</span>]</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>  yday_t2_cos <span class="op">=</span> sample[<span class="st">'yday_t2_cos'</span>]</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(hour_t2_sin, hour_t2_cos, yday_t2_sin, yday_t2_cos)</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bearing of PREVIOUS step</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>  bearing <span class="op">=</span> sample_tm1[<span class="st">'bearing'</span>]</span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(bearing)</span></span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yday = sample['yday_t2_base_2018']</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>  yday <span class="op">=</span> sample[<span class="st">'yday_t2'</span>]</span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(yday)</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>  month_index <span class="op">=</span> day_to_month_index(yday)</span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(month_index)</span></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for sentinel 2 data</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>  selected_month <span class="op">=</span> <span class="ss">f'2019_</span><span class="sc">{</span>month_index<span class="sc">:02d}</span><span class="ss">'</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the normalized data for the selected month</span></span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>  s2_data <span class="op">=</span> data_dict[selected_month]</span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the NumPy array to a PyTorch tensor</span></span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>  s2_tensor <span class="op">=</span> torch.from_numpy(s2_data)</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>  s2_tensor <span class="op">=</span> s2_tensor.<span class="bu">float</span>()  <span class="co"># Ensure the tensor is of type float</span></span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(s2_tensor.shape)</span></span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>  s2_b1_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">0</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>  s2_b2_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">1</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>  s2_b3_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">2</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a>  s2_b4_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">3</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a>  s2_b5_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">4</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a>  s2_b6_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">5</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>  s2_b7_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">6</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a>  s2_b8_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">7</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>  s2_b8a_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">8</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>  s2_b9_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">9</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a>  s2_b11_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">10</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a>  s2_b12_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">11</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a>  slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('origin_x and origin_y are ', origin_x, origin_y)</span></span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a>  px2_subset <span class="op">=</span> px2 <span class="op">-</span> origin_x</span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a>  py2_subset <span class="op">=</span> py2 <span class="op">-</span> origin_y</span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('delta origin_x and origin_y are ', px2_subset, py2_subset)</span></span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('delta origin_x and origin_y are ', int(px2_subset), int(py2_subset))</span></span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># value = ndvi_subset.detach().cpu().numpy()[(int(py2_subset), int(px2_subset))]</span></span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # from the stack of local layers</span></span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ndvi_max = 0.8220</span></span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ndvi_min = -0.2772</span></span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # return to natural scale</span></span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># value_natural = value * (ndvi_max - ndvi_min) + ndvi_min</span></span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Value natural scale = ', value_natural)</span></span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot the subset</span></span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig, axs = plt.subplots(2, 2, figsize=(10, 10))</span></span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[0, 0].imshow(s2_b2_subset.numpy(), cmap='viridis')</span></span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[0, 0].set_title('Band 2 (blue) Subset')</span></span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig.colorbar(axs[0, 0].imshow(s2_b2_subset.numpy(), cmap='viridis'), ax=axs[0, 0], shrink=0.7)</span></span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[0, 0].axis('off')</span></span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[0, 1].imshow(s2_b3_subset.numpy(), cmap='viridis')</span></span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[0, 1].set_title('Band 3 (green) Subset')</span></span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig.colorbar(axs[0, 1].imshow(s2_b3_subset.numpy(), cmap='viridis'), ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # axs[0, 1].axis('off')</span></span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[1, 0].imshow(s2_b4_subset.numpy(), cmap='viridis')</span></span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[1, 0].set_title('Band 4 (red) Subset')</span></span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig.colorbar(axs[1, 0].imshow(s2_b4_subset.numpy(), cmap='viridis'), ax=axs[1, 0], shrink=0.7)</span></span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # axs[1, 0].axis('off')</span></span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-128"><a href="#cb36-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[1, 1].imshow(slope_subset.numpy(), cmap='viridis')</span></span>
<span id="cb36-129"><a href="#cb36-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs[1, 1].set_title('Slope Subset')</span></span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig.colorbar(axs[1, 1].imshow(slope_subset.numpy(), cmap='viridis'), ax=axs[1, 1], shrink=0.7)</span></span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[1, 1].axis('off')</span></span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack the channels along a new axis; here, 1 is commonly used for channel axis in PyTorch</span></span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a>  x1 <span class="op">=</span> torch.stack([s2_b1_subset,</span>
<span id="cb36-135"><a href="#cb36-135" aria-hidden="true" tabindex="-1"></a>                    s2_b2_subset, </span>
<span id="cb36-136"><a href="#cb36-136" aria-hidden="true" tabindex="-1"></a>                    s2_b3_subset, </span>
<span id="cb36-137"><a href="#cb36-137" aria-hidden="true" tabindex="-1"></a>                    s2_b4_subset, </span>
<span id="cb36-138"><a href="#cb36-138" aria-hidden="true" tabindex="-1"></a>                    s2_b5_subset,</span>
<span id="cb36-139"><a href="#cb36-139" aria-hidden="true" tabindex="-1"></a>                    s2_b6_subset,</span>
<span id="cb36-140"><a href="#cb36-140" aria-hidden="true" tabindex="-1"></a>                    s2_b7_subset,</span>
<span id="cb36-141"><a href="#cb36-141" aria-hidden="true" tabindex="-1"></a>                    s2_b8_subset,</span>
<span id="cb36-142"><a href="#cb36-142" aria-hidden="true" tabindex="-1"></a>                    s2_b8a_subset,</span>
<span id="cb36-143"><a href="#cb36-143" aria-hidden="true" tabindex="-1"></a>                    s2_b9_subset,</span>
<span id="cb36-144"><a href="#cb36-144" aria-hidden="true" tabindex="-1"></a>                    s2_b11_subset,</span>
<span id="cb36-145"><a href="#cb36-145" aria-hidden="true" tabindex="-1"></a>                    s2_b12_subset,</span>
<span id="cb36-146"><a href="#cb36-146" aria-hidden="true" tabindex="-1"></a>                    slope_subset], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb36-147"><a href="#cb36-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-148"><a href="#cb36-148" aria-hidden="true" tabindex="-1"></a>  x1 <span class="op">=</span> x1.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb36-149"><a href="#cb36-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x1.shape)</span></span>
<span id="cb36-150"><a href="#cb36-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-151"><a href="#cb36-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert lists to PyTorch tensors</span></span>
<span id="cb36-152"><a href="#cb36-152" aria-hidden="true" tabindex="-1"></a>  hour_t2_sin_tensor <span class="op">=</span> torch.tensor(hour_t2_sin).<span class="bu">float</span>()</span>
<span id="cb36-153"><a href="#cb36-153" aria-hidden="true" tabindex="-1"></a>  hour_t2_cos_tensor <span class="op">=</span> torch.tensor(hour_t2_cos).<span class="bu">float</span>()</span>
<span id="cb36-154"><a href="#cb36-154" aria-hidden="true" tabindex="-1"></a>  yday_t2_sin_tensor <span class="op">=</span> torch.tensor(yday_t2_sin).<span class="bu">float</span>()</span>
<span id="cb36-155"><a href="#cb36-155" aria-hidden="true" tabindex="-1"></a>  yday_t2_cos_tensor <span class="op">=</span> torch.tensor(yday_t2_cos).<span class="bu">float</span>()</span>
<span id="cb36-156"><a href="#cb36-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-157"><a href="#cb36-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack tensors column-wise</span></span>
<span id="cb36-158"><a href="#cb36-158" aria-hidden="true" tabindex="-1"></a>  x2 <span class="op">=</span> torch.stack((hour_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb36-159"><a href="#cb36-159" aria-hidden="true" tabindex="-1"></a>                    hour_t2_cos_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb36-160"><a href="#cb36-160" aria-hidden="true" tabindex="-1"></a>                    yday_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb36-161"><a href="#cb36-161" aria-hidden="true" tabindex="-1"></a>                    yday_t2_cos_tensor.unsqueeze(<span class="dv">0</span>)),  </span>
<span id="cb36-162"><a href="#cb36-162" aria-hidden="true" tabindex="-1"></a>                    dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-163"><a href="#cb36-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x2)</span></span>
<span id="cb36-164"><a href="#cb36-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x2.shape)</span></span>
<span id="cb36-165"><a href="#cb36-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-166"><a href="#cb36-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put bearing in the correct dimension (batch_size, 1)</span></span>
<span id="cb36-167"><a href="#cb36-167" aria-hidden="true" tabindex="-1"></a>  bearing <span class="op">=</span> torch.tensor(bearing).<span class="bu">float</span>().unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb36-168"><a href="#cb36-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(bearing)</span></span>
<span id="cb36-169"><a href="#cb36-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(bearing.shape)</span></span>
<span id="cb36-170"><a href="#cb36-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-171"><a href="#cb36-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run the model on the subsetted layers</span></span>
<span id="cb36-172"><a href="#cb36-172" aria-hidden="true" tabindex="-1"></a>  test <span class="op">=</span> model((x1, x2, bearing))</span>
<span id="cb36-173"><a href="#cb36-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-174"><a href="#cb36-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the results of the habitat density as an image</span></span>
<span id="cb36-175"><a href="#cb36-175" aria-hidden="true" tabindex="-1"></a>  hab_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">0</span>]</span>
<span id="cb36-176"><a href="#cb36-176" aria-hidden="true" tabindex="-1"></a>  hab_density_exp <span class="op">=</span> np.exp(hab_density)</span>
<span id="cb36-177"><a href="#cb36-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(np.sum(hab_density_exp))</span></span>
<span id="cb36-178"><a href="#cb36-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-179"><a href="#cb36-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the probability of habitat selection at the location of x2, y2</span></span>
<span id="cb36-180"><a href="#cb36-180" aria-hidden="true" tabindex="-1"></a>  habitat_probs[i] <span class="op">=</span> hab_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb36-181"><a href="#cb36-181" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Habitat probability value = ', habitat_probs[i])</span></span>
<span id="cb36-182"><a href="#cb36-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-183"><a href="#cb36-183" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the mask for x and y coordinates</span></span>
<span id="cb36-184"><a href="#cb36-184" aria-hidden="true" tabindex="-1"></a>  x_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb36-185"><a href="#cb36-185" aria-hidden="true" tabindex="-1"></a>  y_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb36-186"><a href="#cb36-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-187"><a href="#cb36-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mask out cells on the edges that affect the colour scale</span></span>
<span id="cb36-188"><a href="#cb36-188" aria-hidden="true" tabindex="-1"></a>  x_mask[:, :<span class="dv">3</span>] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb36-189"><a href="#cb36-189" aria-hidden="true" tabindex="-1"></a>  x_mask[:, <span class="dv">98</span>:] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb36-190"><a href="#cb36-190" aria-hidden="true" tabindex="-1"></a>  y_mask[:<span class="dv">3</span>, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb36-191"><a href="#cb36-191" aria-hidden="true" tabindex="-1"></a>  y_mask[<span class="dv">98</span>:, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb36-192"><a href="#cb36-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-193"><a href="#cb36-193" aria-hidden="true" tabindex="-1"></a>  hab_density_mask <span class="op">=</span> hab_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb36-194"><a href="#cb36-194" aria-hidden="true" tabindex="-1"></a>  hab_density_exp_mask <span class="op">=</span> hab_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb36-195"><a href="#cb36-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-196"><a href="#cb36-196" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the habitat density as an image - in log scale</span></span>
<span id="cb36-197"><a href="#cb36-197" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(hab_density_mask)</span></span>
<span id="cb36-198"><a href="#cb36-198" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb36-199"><a href="#cb36-199" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb36-200"><a href="#cb36-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-201"><a href="#cb36-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the habitat density as an image - as probabilities</span></span>
<span id="cb36-202"><a href="#cb36-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(hab_density_exp_mask)</span></span>
<span id="cb36-203"><a href="#cb36-203" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb36-204"><a href="#cb36-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb36-205"><a href="#cb36-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-206"><a href="#cb36-206" aria-hidden="true" tabindex="-1"></a>  <span class="co"># movement probability</span></span>
<span id="cb36-207"><a href="#cb36-207" aria-hidden="true" tabindex="-1"></a>  move_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">1</span>]</span>
<span id="cb36-208"><a href="#cb36-208" aria-hidden="true" tabindex="-1"></a>  move_density_exp <span class="op">=</span> np.exp(move_density)</span>
<span id="cb36-209"><a href="#cb36-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(np.sum(move_density_exp))</span></span>
<span id="cb36-210"><a href="#cb36-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-211"><a href="#cb36-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the probability of movement at the location of x2, y2</span></span>
<span id="cb36-212"><a href="#cb36-212" aria-hidden="true" tabindex="-1"></a>  move_probs[i] <span class="op">=</span> move_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb36-213"><a href="#cb36-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Movement probability value = ', move_probs[i])</span></span>
<span id="cb36-214"><a href="#cb36-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-215"><a href="#cb36-215" aria-hidden="true" tabindex="-1"></a>  move_density_mask <span class="op">=</span> move_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb36-216"><a href="#cb36-216" aria-hidden="true" tabindex="-1"></a>  move_density_exp_mask <span class="op">=</span> move_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb36-217"><a href="#cb36-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-218"><a href="#cb36-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the movement density as an image - in log scale</span></span>
<span id="cb36-219"><a href="#cb36-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(move_density_mask)</span></span>
<span id="cb36-220"><a href="#cb36-220" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb36-221"><a href="#cb36-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb36-222"><a href="#cb36-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-223"><a href="#cb36-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the movement density as an image - as probabilities</span></span>
<span id="cb36-224"><a href="#cb36-224" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(move_density_exp_mask)</span></span>
<span id="cb36-225"><a href="#cb36-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb36-226"><a href="#cb36-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb36-227"><a href="#cb36-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-228"><a href="#cb36-228" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next step probability</span></span>
<span id="cb36-229"><a href="#cb36-229" aria-hidden="true" tabindex="-1"></a>  step_density <span class="op">=</span> test[<span class="dv">0</span>, :, :, <span class="dv">0</span>] <span class="op">+</span> test[<span class="dv">0</span>, :, :, <span class="dv">1</span>]</span>
<span id="cb36-230"><a href="#cb36-230" aria-hidden="true" tabindex="-1"></a>  step_density <span class="op">=</span> step_density.detach().cpu().numpy()</span>
<span id="cb36-231"><a href="#cb36-231" aria-hidden="true" tabindex="-1"></a>  step_density_exp <span class="op">=</span> np.exp(step_density)</span>
<span id="cb36-232"><a href="#cb36-232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Sum of step density exp = ', np.sum(step_density_exp))</span></span>
<span id="cb36-233"><a href="#cb36-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-234"><a href="#cb36-234" aria-hidden="true" tabindex="-1"></a>  step_density_exp_norm <span class="op">=</span> step_density_exp <span class="op">/</span> np.<span class="bu">sum</span>(step_density_exp)</span>
<span id="cb36-235"><a href="#cb36-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Sum of step density exp norm = ', np.sum(step_density_exp_norm))</span></span>
<span id="cb36-236"><a href="#cb36-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-237"><a href="#cb36-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb36-238"><a href="#cb36-238" aria-hidden="true" tabindex="-1"></a>  next_step_probs[i] <span class="op">=</span> step_density_exp_norm[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb36-239"><a href="#cb36-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Next-step probability value = ', next_step_probs[i])</span></span>
<span id="cb36-240"><a href="#cb36-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-241"><a href="#cb36-241" aria-hidden="true" tabindex="-1"></a>  step_density_mask <span class="op">=</span> step_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb36-242"><a href="#cb36-242" aria-hidden="true" tabindex="-1"></a>  step_density_exp_norm_mask <span class="op">=</span> step_density_exp_norm <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb36-243"><a href="#cb36-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-244"><a href="#cb36-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # results of the habitat and movement densities</span></span>
<span id="cb36-245"><a href="#cb36-245" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # log-scale</span></span>
<span id="cb36-246"><a href="#cb36-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(step_density_mask)</span></span>
<span id="cb36-247"><a href="#cb36-247" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb36-248"><a href="#cb36-248" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb36-249"><a href="#cb36-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-250"><a href="#cb36-250" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # exponentiated</span></span>
<span id="cb36-251"><a href="#cb36-251" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(step_density_exp_mask)</span></span>
<span id="cb36-252"><a href="#cb36-252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb36-253"><a href="#cb36-253" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb36-254"><a href="#cb36-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-255"><a href="#cb36-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-256"><a href="#cb36-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-257"><a href="#cb36-257" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot the outputs</span></span>
<span id="cb36-258"><a href="#cb36-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out, axs_out = plt.subplots(2, 2, figsize=(10, 10))</span></span>
<span id="cb36-259"><a href="#cb36-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-260"><a href="#cb36-260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # RGB for plotting</span></span>
<span id="cb36-261"><a href="#cb36-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # pull out the RGB bands</span></span>
<span id="cb36-262"><a href="#cb36-262" aria-hidden="true" tabindex="-1"></a>  <span class="co"># r_band = s2_b4_subset.detach().numpy()</span></span>
<span id="cb36-263"><a href="#cb36-263" aria-hidden="true" tabindex="-1"></a>  <span class="co"># g_band = s2_b3_subset.detach().numpy()</span></span>
<span id="cb36-264"><a href="#cb36-264" aria-hidden="true" tabindex="-1"></a>  <span class="co"># b_band = s2_b2_subset.detach().numpy()</span></span>
<span id="cb36-265"><a href="#cb36-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-266"><a href="#cb36-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Stack the bands along a new axis</span></span>
<span id="cb36-267"><a href="#cb36-267" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rgb_image = np.stack([r_band, g_band, b_band], axis=-1)</span></span>
<span id="cb36-268"><a href="#cb36-268" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Normalize to the range [0, 1] for display</span></span>
<span id="cb36-269"><a href="#cb36-269" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rgb_image = (rgb_image - rgb_image.min()) / (rgb_image.max() - rgb_image.min())</span></span>
<span id="cb36-270"><a href="#cb36-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-271"><a href="#cb36-271" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot s2_b2</span></span>
<span id="cb36-272"><a href="#cb36-272" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im1 = axs_out[0, 0].imshow(rgb_image)</span></span>
<span id="cb36-273"><a href="#cb36-273" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[0, 0].set_title('Sentinel 2 RGB')</span></span>
<span id="cb36-274"><a href="#cb36-274" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # fig_out.colorbar(im1, ax=axs_out[0, 0], shrink=0.7)</span></span>
<span id="cb36-275"><a href="#cb36-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-276"><a href="#cb36-276" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # Plot target</span></span>
<span id="cb36-277"><a href="#cb36-277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # im2 = axs[0, 1].imshow(labels.detach().cpu().numpy()[0,:,:], cmap='viridis')</span></span>
<span id="cb36-278"><a href="#cb36-278" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[0, 1].set_title('Observed next step')</span></span>
<span id="cb36-279"><a href="#cb36-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb36-280"><a href="#cb36-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-281"><a href="#cb36-281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # Plot slope</span></span>
<span id="cb36-282"><a href="#cb36-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # im2 = axs[0, 1].imshow(x1.detach().cpu().numpy()[0,12,:,:], cmap='viridis')</span></span>
<span id="cb36-283"><a href="#cb36-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[0, 1].set_title('Slope')</span></span>
<span id="cb36-284"><a href="#cb36-284" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb36-285"><a href="#cb36-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-286"><a href="#cb36-286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot habitat selection log-probability</span></span>
<span id="cb36-287"><a href="#cb36-287" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im2 = axs_out[0, 1].imshow(hab_density_mask, cmap='viridis')</span></span>
<span id="cb36-288"><a href="#cb36-288" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[0, 1].set_title('Habitat selection log-probability')</span></span>
<span id="cb36-289"><a href="#cb36-289" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im2, ax=axs_out[0, 1], shrink=0.7)</span></span>
<span id="cb36-290"><a href="#cb36-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-291"><a href="#cb36-291" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Movement density log-probability</span></span>
<span id="cb36-292"><a href="#cb36-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im3 = axs_out[1, 0].imshow(move_density_mask, cmap='viridis')</span></span>
<span id="cb36-293"><a href="#cb36-293" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[1, 0].set_title('Movement log-probability')</span></span>
<span id="cb36-294"><a href="#cb36-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im3, ax=axs_out[1, 0], shrink=0.7)</span></span>
<span id="cb36-295"><a href="#cb36-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-296"><a href="#cb36-296" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # Next-step log probability</span></span>
<span id="cb36-297"><a href="#cb36-297" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # im4 = axs[1, 1].imshow(step_density_mask, cmap='viridis')</span></span>
<span id="cb36-298"><a href="#cb36-298" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[1, 1].set_title('Next-step log-probability')</span></span>
<span id="cb36-299"><a href="#cb36-299" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # fig.colorbar(im4, ax=axs[1, 1], shrink=0.7)</span></span>
<span id="cb36-300"><a href="#cb36-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-301"><a href="#cb36-301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # [(int(py2_subset), int(px2_subset))]</span></span>
<span id="cb36-302"><a href="#cb36-302" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next_step_mask = np.ones_like(hab_density)</span></span>
<span id="cb36-303"><a href="#cb36-303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next_step_mask[int(py2_subset), int(px2_subset)] = -np.inf</span></span>
<span id="cb36-304"><a href="#cb36-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-305"><a href="#cb36-305" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Next-step probability</span></span>
<span id="cb36-306"><a href="#cb36-306" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im4 = axs_out[1, 1].imshow(step_density_exp_norm_mask * next_step_mask, cmap='viridis')</span></span>
<span id="cb36-307"><a href="#cb36-307" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[1, 1].set_title('Next-step probability')</span></span>
<span id="cb36-308"><a href="#cb36-308" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im4, ax=axs_out[1, 1], shrink=0.7)</span></span>
<span id="cb36-309"><a href="#cb36-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-310"><a href="#cb36-310" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # filename_covs = f'outputs/next_step_validation/id{buffalo_id}_yday{yday_t2_integer}_hour{hour_t2_integer}_bearing{bearing_degrees}_next_r{row}_c{column}.png'</span></span>
<span id="cb36-311"><a href="#cb36-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.tight_layout()</span></span>
<span id="cb36-312"><a href="#cb36-312" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.savefig(filename_covs, dpi=600, bbox_inches='tight')</span></span>
<span id="cb36-313"><a href="#cb36-313" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.show()</span></span>
<span id="cb36-314"><a href="#cb36-314" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.close()  # Close the figure to free memory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-39" class="cell" data-execution_count="63">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(next_step_probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.00000000e+00 3.24961298e-03 5.54401817e-03 ... 8.63930943e-01
 1.09650402e-04 8.40177505e-05]</code></pre>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="64">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the habitat probs through time as a line graph</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(habitat_probs[habitat_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Habitat Probability'</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the movement probs through time as a line graph</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(move_probs[move_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Movement Probability'</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the next_step probs through time as a line graph</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(next_step_probs[next_step_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Next-step Probability'</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-24-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-24-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-41" class="cell" data-execution_count="65">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Append the probabilities to the dataframe</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'habitat_probs'</span>] <span class="op">=</span> habitat_probs</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'move_probs'</span>] <span class="op">=</span> move_probs</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'next_step_probs'</span>] <span class="op">=</span> next_step_probs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-42" class="cell" data-execution_count="66">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>csv_filename <span class="op">=</span> <span class="ss">f'../outputs/next_step_probs_S2_id</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>today_date<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(csv_filename)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>buffalo_df.to_csv(csv_filename, index<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2005_2025-01-03.csv</code></pre>
</div>
</div>
</section>
<section id="loop-the-validation-over-each-individual" class="level1">
<h1>Loop the validation over each individual</h1>
<div id="cell-44" class="cell" data-execution_count="67">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select the id to train the model on</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2005</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 10297</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2014</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 6572</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2327</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 8983</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2387</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 10409</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the path to your CSV file</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>csv_file_path <span class="op">=</span> <span class="ss">f'../buffalo_local_data_id/validation/validation_buffalo_</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_data_df_lag_1hr_n</span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file into a DataFrame</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>buffalo_df <span class="op">=</span> pd.read_csv(csv_file_path)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Lag the values in column 'A' by one index</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Pad the missing value with a specified value, e.g., 0</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing_tm1'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

         ta    cos_ta         x_min         x_max         y_min         y_max  \
0  1.367942  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06   
1 -0.021429  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06   
2  2.994917 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06   
3 -2.799767 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06   
4  0.285377  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06   

   s2_index  points_vect_cent  year_t2  yday_t2_2018_base  
0         7               NaN     2018                206  
1         7               NaN     2018                206  
2         7               NaN     2018                206  
3         7               NaN     2018                206  
4         7               NaN     2018                206  

[5 rows x 35 columns]
             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

     cos_ta         x_min         x_max         y_min         y_max  s2_index  \
0  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06         7   
1  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06         7   
2 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06         7   
3 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06         7   
4  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06         7   

   points_vect_cent  year_t2  yday_t2_2018_base  bearing_tm1  
0               NaN     2018                206     0.000000  
1               NaN     2018                206     2.802478  
2               NaN     2018                206     2.781049  
3               NaN     2018                206    -0.507220  
4               NaN     2018                206     2.976198  

[5 rows x 36 columns]</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="68">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Specify the directory containing your TIFF files</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> <span class="st">'../buffalo_local_data_id/validation'</span>  <span class="co"># Replace with the actual path to your TIFF files</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Use glob to get a list of all TIFF files matching the pattern</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>csv_files <span class="op">=</span> glob.glob(os.path.join(data_dir, <span class="st">'validation_*.csv'</span>)) </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Found </span><span class="sc">{</span><span class="bu">len</span>(csv_files)<span class="sc">}</span><span class="ss"> CSV files'</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(csv_files))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Found 13 CSV files
../buffalo_local_data_id/validation\validation_buffalo_2005_data_df_lag_1hr_n10297.csv
../buffalo_local_data_id/validation\validation_buffalo_2014_data_df_lag_1hr_n6572.csv
../buffalo_local_data_id/validation\validation_buffalo_2018_data_df_lag_1hr_n9440.csv
../buffalo_local_data_id/validation\validation_buffalo_2021_data_df_lag_1hr_n6928.csv
../buffalo_local_data_id/validation\validation_buffalo_2022_data_df_lag_1hr_n9099.csv
../buffalo_local_data_id/validation\validation_buffalo_2024_data_df_lag_1hr_n9531.csv
../buffalo_local_data_id/validation\validation_buffalo_2039_data_df_lag_1hr_n5569.csv
../buffalo_local_data_id/validation\validation_buffalo_2154_data_df_lag_1hr_n10417.csv
../buffalo_local_data_id/validation\validation_buffalo_2158_data_df_lag_1hr_n9700.csv
../buffalo_local_data_id/validation\validation_buffalo_2223_data_df_lag_1hr_n5310.csv
../buffalo_local_data_id/validation\validation_buffalo_2327_data_df_lag_1hr_n8983.csv
../buffalo_local_data_id/validation\validation_buffalo_2387_data_df_lag_1hr_n10409.csv
../buffalo_local_data_id/validation\validation_buffalo_2393_data_df_lag_1hr_n5299.csv</code></pre>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="72">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(csv_files)):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file into a DataFrame</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    buffalo_df <span class="op">=</span> pd.read_csv(csv_files[j])</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for saving the file</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    buffalo_id <span class="op">=</span> csv_files[j][<span class="dv">55</span>:<span class="dv">59</span>]</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(buffalo_df.head())</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag the values in column 'A' by one index</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pad the missing value with a specified value, e.g., 0</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing_tm1'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># test_data = buffalo_df.iloc[0:10]</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    test_data <span class="op">=</span> buffalo_df</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(test_data)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create empty vectors to store the predicted probabilities</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    habitat_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    move_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    next_step_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># start at 1 so the bearing at t - 1 is available</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n):</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>        sample_tm1 <span class="op">=</span> test_data.iloc[i<span class="op">-</span><span class="dv">1</span>] <span class="co"># get the step at t - 1 for the bearing of the approaching step</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>        sample <span class="op">=</span> test_data.iloc[i]</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># current location (x1, y1)</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> sample[<span class="st">'x1_'</span>]</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> sample[<span class="st">'y1_'</span>]</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('x and y are ', x,y)</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>        px, py <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x, y)</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_x, new_y = raster_transform * (px, py)</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('px and py are ', px, py)</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># next step location (x2, y2)</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> sample[<span class="st">'x2_'</span>]</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>        y2 <span class="op">=</span> sample[<span class="st">'y2_'</span>]</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('x2 and y2 are ', x2, y2)</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>        px2, py2 <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x2, y2)</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('px2 and py2 are ', px2, py2)</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # THE Y COORDINATE COMES FIRST in the sampled coordinates</span></span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_px = origin_xs[0] + sampled_coordinates[1]</span></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_py = origin_ys[0] + sampled_coordinates[0]</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_x, new_y = raster_transform * (new_px, new_py)</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>        d_x <span class="op">=</span> x2 <span class="op">-</span> x</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>        d_y <span class="op">=</span> y2 <span class="op">-</span> y</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('d_x and d_y are ', d_x, d_y)</span></span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># temporal covariates</span></span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>        hour_t2_sin <span class="op">=</span> sample[<span class="st">'hour_t2_sin'</span>]</span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>        hour_t2_cos <span class="op">=</span> sample[<span class="st">'hour_t2_cos'</span>]</span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>        yday_t2_sin <span class="op">=</span> sample[<span class="st">'yday_t2_sin'</span>]</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>        yday_t2_cos <span class="op">=</span> sample[<span class="st">'yday_t2_cos'</span>]</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(hour_t2_sin, hour_t2_cos, yday_t2_sin, yday_t2_cos)</span></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing of PREVIOUS step</span></span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>        bearing <span class="op">=</span> sample_tm1[<span class="st">'bearing'</span>]</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(bearing)</span></span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>        yday <span class="op">=</span> sample[<span class="st">'yday_t2_2018_base'</span>]</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># yday = sample['yday_t2']</span></span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(yday)</span></span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>        month_index <span class="op">=</span> day_to_month_index(yday)</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(month_index)</span></span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adjust month_index to range from 1 to 12</span></span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>        month_index <span class="op">=</span> (month_index <span class="op">-</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">12</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for sentinel 2 data</span></span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>        selected_month <span class="op">=</span> <span class="ss">f'2019_</span><span class="sc">{</span>month_index<span class="sc">:02d}</span><span class="ss">'</span></span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the normalized data for the selected month</span></span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>        s2_data <span class="op">=</span> data_dict[selected_month]</span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the NumPy array to a PyTorch tensor</span></span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>        s2_tensor <span class="op">=</span> torch.from_numpy(s2_data)</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>        s2_tensor <span class="op">=</span> s2_tensor.<span class="bu">float</span>()  <span class="co"># Ensure the tensor is of type float</span></span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(s2_tensor.shape)</span></span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>        s2_b1_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">0</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>        s2_b2_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">1</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>        s2_b3_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">2</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a>        s2_b4_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">3</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a>        s2_b5_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">4</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a>        s2_b6_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">5</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a>        s2_b7_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">6</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-103"><a href="#cb47-103" aria-hidden="true" tabindex="-1"></a>        s2_b8_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">7</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-104"><a href="#cb47-104" aria-hidden="true" tabindex="-1"></a>        s2_b8a_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">8</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a>        s2_b9_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">9</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a>        s2_b11_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">10</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a>        s2_b12_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(s2_tensor[<span class="dv">11</span>,:,:], x, y, window_size, raster_transform)</span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a>        slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb47-110"><a href="#cb47-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-111"><a href="#cb47-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack the channels along a new axis; here, 1 is commonly used for channel axis in PyTorch</span></span>
<span id="cb47-112"><a href="#cb47-112" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> torch.stack([s2_b1_subset,</span>
<span id="cb47-113"><a href="#cb47-113" aria-hidden="true" tabindex="-1"></a>                            s2_b2_subset, </span>
<span id="cb47-114"><a href="#cb47-114" aria-hidden="true" tabindex="-1"></a>                            s2_b3_subset, </span>
<span id="cb47-115"><a href="#cb47-115" aria-hidden="true" tabindex="-1"></a>                            s2_b4_subset, </span>
<span id="cb47-116"><a href="#cb47-116" aria-hidden="true" tabindex="-1"></a>                            s2_b5_subset,</span>
<span id="cb47-117"><a href="#cb47-117" aria-hidden="true" tabindex="-1"></a>                            s2_b6_subset,</span>
<span id="cb47-118"><a href="#cb47-118" aria-hidden="true" tabindex="-1"></a>                            s2_b7_subset,</span>
<span id="cb47-119"><a href="#cb47-119" aria-hidden="true" tabindex="-1"></a>                            s2_b8_subset,</span>
<span id="cb47-120"><a href="#cb47-120" aria-hidden="true" tabindex="-1"></a>                            s2_b8a_subset,</span>
<span id="cb47-121"><a href="#cb47-121" aria-hidden="true" tabindex="-1"></a>                            s2_b9_subset,</span>
<span id="cb47-122"><a href="#cb47-122" aria-hidden="true" tabindex="-1"></a>                            s2_b11_subset,</span>
<span id="cb47-123"><a href="#cb47-123" aria-hidden="true" tabindex="-1"></a>                            s2_b12_subset,</span>
<span id="cb47-124"><a href="#cb47-124" aria-hidden="true" tabindex="-1"></a>                            slope_subset], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb47-125"><a href="#cb47-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-126"><a href="#cb47-126" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> x1.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb47-127"><a href="#cb47-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x1.shape)</span></span>
<span id="cb47-128"><a href="#cb47-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-129"><a href="#cb47-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('origin_x and origin_y are ', origin_x, origin_y)</span></span>
<span id="cb47-130"><a href="#cb47-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-131"><a href="#cb47-131" aria-hidden="true" tabindex="-1"></a>        px2_subset <span class="op">=</span> px2 <span class="op">-</span> origin_x</span>
<span id="cb47-132"><a href="#cb47-132" aria-hidden="true" tabindex="-1"></a>        py2_subset <span class="op">=</span> py2 <span class="op">-</span> origin_y</span>
<span id="cb47-133"><a href="#cb47-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('delta origin_x and origin_y are ', px2_subset, py2_subset)</span></span>
<span id="cb47-134"><a href="#cb47-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('delta origin_x and origin_y are ', int(px2_subset), int(py2_subset))</span></span>
<span id="cb47-135"><a href="#cb47-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-136"><a href="#cb47-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert lists to PyTorch tensors</span></span>
<span id="cb47-137"><a href="#cb47-137" aria-hidden="true" tabindex="-1"></a>        hour_t2_sin_tensor <span class="op">=</span> torch.tensor(hour_t2_sin).<span class="bu">float</span>()</span>
<span id="cb47-138"><a href="#cb47-138" aria-hidden="true" tabindex="-1"></a>        hour_t2_cos_tensor <span class="op">=</span> torch.tensor(hour_t2_cos).<span class="bu">float</span>()</span>
<span id="cb47-139"><a href="#cb47-139" aria-hidden="true" tabindex="-1"></a>        yday_t2_sin_tensor <span class="op">=</span> torch.tensor(yday_t2_sin).<span class="bu">float</span>()</span>
<span id="cb47-140"><a href="#cb47-140" aria-hidden="true" tabindex="-1"></a>        yday_t2_cos_tensor <span class="op">=</span> torch.tensor(yday_t2_cos).<span class="bu">float</span>()</span>
<span id="cb47-141"><a href="#cb47-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-142"><a href="#cb47-142" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack tensors column-wise</span></span>
<span id="cb47-143"><a href="#cb47-143" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> torch.stack((hour_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb47-144"><a href="#cb47-144" aria-hidden="true" tabindex="-1"></a>                            hour_t2_cos_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb47-145"><a href="#cb47-145" aria-hidden="true" tabindex="-1"></a>                            yday_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb47-146"><a href="#cb47-146" aria-hidden="true" tabindex="-1"></a>                            yday_t2_cos_tensor.unsqueeze(<span class="dv">0</span>)),  </span>
<span id="cb47-147"><a href="#cb47-147" aria-hidden="true" tabindex="-1"></a>                            dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-148"><a href="#cb47-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x2)</span></span>
<span id="cb47-149"><a href="#cb47-149" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x2.shape)</span></span>
<span id="cb47-150"><a href="#cb47-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-151"><a href="#cb47-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># put bearing in the correct dimension (batch_size, 1)</span></span>
<span id="cb47-152"><a href="#cb47-152" aria-hidden="true" tabindex="-1"></a>        bearing <span class="op">=</span> torch.tensor(bearing).<span class="bu">float</span>().unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb47-153"><a href="#cb47-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(bearing)</span></span>
<span id="cb47-154"><a href="#cb47-154" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(bearing.shape)</span></span>
<span id="cb47-155"><a href="#cb47-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-156"><a href="#cb47-156" aria-hidden="true" tabindex="-1"></a>        test <span class="op">=</span> model((x1, x2, bearing))</span>
<span id="cb47-157"><a href="#cb47-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-158"><a href="#cb47-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plot the results of the habitat density as an image</span></span>
<span id="cb47-159"><a href="#cb47-159" aria-hidden="true" tabindex="-1"></a>        hab_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">0</span>]</span>
<span id="cb47-160"><a href="#cb47-160" aria-hidden="true" tabindex="-1"></a>        hab_density_exp <span class="op">=</span> np.exp(hab_density)</span>
<span id="cb47-161"><a href="#cb47-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(np.sum(hab_density_exp))</span></span>
<span id="cb47-162"><a href="#cb47-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-163"><a href="#cb47-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the probability of habitat selection at the location of x2, y2</span></span>
<span id="cb47-164"><a href="#cb47-164" aria-hidden="true" tabindex="-1"></a>        habitat_probs[i] <span class="op">=</span> hab_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb47-165"><a href="#cb47-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Habitat probability value = ', habitat_probs[i])</span></span>
<span id="cb47-166"><a href="#cb47-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-167"><a href="#cb47-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the mask for x and y coordinates</span></span>
<span id="cb47-168"><a href="#cb47-168" aria-hidden="true" tabindex="-1"></a>        x_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb47-169"><a href="#cb47-169" aria-hidden="true" tabindex="-1"></a>        y_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb47-170"><a href="#cb47-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-171"><a href="#cb47-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mask out cells on the edges that affect the colour scale</span></span>
<span id="cb47-172"><a href="#cb47-172" aria-hidden="true" tabindex="-1"></a>        x_mask[:, :<span class="dv">3</span>] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb47-173"><a href="#cb47-173" aria-hidden="true" tabindex="-1"></a>        x_mask[:, <span class="dv">98</span>:] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb47-174"><a href="#cb47-174" aria-hidden="true" tabindex="-1"></a>        y_mask[:<span class="dv">3</span>, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb47-175"><a href="#cb47-175" aria-hidden="true" tabindex="-1"></a>        y_mask[<span class="dv">98</span>:, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb47-176"><a href="#cb47-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-177"><a href="#cb47-177" aria-hidden="true" tabindex="-1"></a>        hab_density_mask <span class="op">=</span> hab_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb47-178"><a href="#cb47-178" aria-hidden="true" tabindex="-1"></a>        hab_density_exp_mask <span class="op">=</span> hab_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb47-179"><a href="#cb47-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-180"><a href="#cb47-180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the habitat density as an image - in log scale</span></span>
<span id="cb47-181"><a href="#cb47-181" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(hab_density_mask)</span></span>
<span id="cb47-182"><a href="#cb47-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb47-183"><a href="#cb47-183" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb47-184"><a href="#cb47-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-185"><a href="#cb47-185" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the habitat density as an image - as probabilities</span></span>
<span id="cb47-186"><a href="#cb47-186" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(hab_density_exp_mask)</span></span>
<span id="cb47-187"><a href="#cb47-187" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb47-188"><a href="#cb47-188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb47-189"><a href="#cb47-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-190"><a href="#cb47-190" aria-hidden="true" tabindex="-1"></a>        <span class="co"># movement probability</span></span>
<span id="cb47-191"><a href="#cb47-191" aria-hidden="true" tabindex="-1"></a>        move_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">1</span>]</span>
<span id="cb47-192"><a href="#cb47-192" aria-hidden="true" tabindex="-1"></a>        move_density_exp <span class="op">=</span> np.exp(move_density)</span>
<span id="cb47-193"><a href="#cb47-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(np.sum(move_density_exp))</span></span>
<span id="cb47-194"><a href="#cb47-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-195"><a href="#cb47-195" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the probability of movement at the location of x2, y2</span></span>
<span id="cb47-196"><a href="#cb47-196" aria-hidden="true" tabindex="-1"></a>        move_probs[i] <span class="op">=</span> move_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb47-197"><a href="#cb47-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Movement probability value = ', move_probs[i])</span></span>
<span id="cb47-198"><a href="#cb47-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-199"><a href="#cb47-199" aria-hidden="true" tabindex="-1"></a>        move_density_mask <span class="op">=</span> move_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb47-200"><a href="#cb47-200" aria-hidden="true" tabindex="-1"></a>        move_density_exp_mask <span class="op">=</span> move_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb47-201"><a href="#cb47-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-202"><a href="#cb47-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the movement density as an image - in log scale</span></span>
<span id="cb47-203"><a href="#cb47-203" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(move_density_mask)</span></span>
<span id="cb47-204"><a href="#cb47-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb47-205"><a href="#cb47-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb47-206"><a href="#cb47-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-207"><a href="#cb47-207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the movement density as an image - as probabilities</span></span>
<span id="cb47-208"><a href="#cb47-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(move_density_exp_mask)</span></span>
<span id="cb47-209"><a href="#cb47-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb47-210"><a href="#cb47-210" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb47-211"><a href="#cb47-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-212"><a href="#cb47-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># next step probability</span></span>
<span id="cb47-213"><a href="#cb47-213" aria-hidden="true" tabindex="-1"></a>        step_density <span class="op">=</span> test[<span class="dv">0</span>, :, :, <span class="dv">0</span>] <span class="op">+</span> test[<span class="dv">0</span>, :, :, <span class="dv">1</span>]</span>
<span id="cb47-214"><a href="#cb47-214" aria-hidden="true" tabindex="-1"></a>        step_density <span class="op">=</span> step_density.detach().cpu().numpy()</span>
<span id="cb47-215"><a href="#cb47-215" aria-hidden="true" tabindex="-1"></a>        step_density_exp <span class="op">=</span> np.exp(step_density)</span>
<span id="cb47-216"><a href="#cb47-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Sum of step density exp = ', np.sum(step_density_exp))</span></span>
<span id="cb47-217"><a href="#cb47-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-218"><a href="#cb47-218" aria-hidden="true" tabindex="-1"></a>        step_density_exp_norm <span class="op">=</span> step_density_exp <span class="op">/</span> np.<span class="bu">sum</span>(step_density_exp)</span>
<span id="cb47-219"><a href="#cb47-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Sum of step density exp norm = ', np.sum(step_density_exp_norm))</span></span>
<span id="cb47-220"><a href="#cb47-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-221"><a href="#cb47-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb47-222"><a href="#cb47-222" aria-hidden="true" tabindex="-1"></a>        next_step_probs[i] <span class="op">=</span> step_density_exp_norm[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb47-223"><a href="#cb47-223" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Next-step probability value = ', next_step_probs[i])</span></span>
<span id="cb47-224"><a href="#cb47-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-225"><a href="#cb47-225" aria-hidden="true" tabindex="-1"></a>        step_density_mask <span class="op">=</span> step_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb47-226"><a href="#cb47-226" aria-hidden="true" tabindex="-1"></a>        step_density_exp_norm_mask <span class="op">=</span> step_density_exp_norm <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb47-227"><a href="#cb47-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-228"><a href="#cb47-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # results of the habitat and movement densities</span></span>
<span id="cb47-229"><a href="#cb47-229" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # log-scale</span></span>
<span id="cb47-230"><a href="#cb47-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(step_density_mask)</span></span>
<span id="cb47-231"><a href="#cb47-231" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb47-232"><a href="#cb47-232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb47-233"><a href="#cb47-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-234"><a href="#cb47-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # exponentiated</span></span>
<span id="cb47-235"><a href="#cb47-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(step_density_exp_mask)</span></span>
<span id="cb47-236"><a href="#cb47-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb47-237"><a href="#cb47-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb47-238"><a href="#cb47-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-239"><a href="#cb47-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-240"><a href="#cb47-240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot the outputs</span></span>
<span id="cb47-241"><a href="#cb47-241" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_out, axs_out = plt.subplots(2, 2, figsize=(10, 10))</span></span>
<span id="cb47-242"><a href="#cb47-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-243"><a href="#cb47-243" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot NDVI</span></span>
<span id="cb47-244"><a href="#cb47-244" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im1 = axs_out[0, 0].imshow(ndvi_subset.numpy(), cmap='viridis')</span></span>
<span id="cb47-245"><a href="#cb47-245" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_out[0, 0].set_title('NDVI')</span></span>
<span id="cb47-246"><a href="#cb47-246" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_out.colorbar(im1, ax=axs_out[0, 0], shrink=0.7)</span></span>
<span id="cb47-247"><a href="#cb47-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-248"><a href="#cb47-248" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # # Plot target</span></span>
<span id="cb47-249"><a href="#cb47-249" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # im2 = axs[0, 1].imshow(labels.detach().cpu().numpy()[0,:,:], cmap='viridis')</span></span>
<span id="cb47-250"><a href="#cb47-250" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # axs[0, 1].set_title('Observed next step')</span></span>
<span id="cb47-251"><a href="#cb47-251" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb47-252"><a href="#cb47-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-253"><a href="#cb47-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # # Plot slope</span></span>
<span id="cb47-254"><a href="#cb47-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # im2 = axs[0, 1].imshow(x1.detach().cpu().numpy()[0,12,:,:], cmap='viridis')</span></span>
<span id="cb47-255"><a href="#cb47-255" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # axs[0, 1].set_title('Slope')</span></span>
<span id="cb47-256"><a href="#cb47-256" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb47-257"><a href="#cb47-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-258"><a href="#cb47-258" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot habitat selection log-probability</span></span>
<span id="cb47-259"><a href="#cb47-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im2 = axs_out[0, 1].imshow(hab_density_mask, cmap='viridis')</span></span>
<span id="cb47-260"><a href="#cb47-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_out[0, 1].set_title('Habitat selection log-probability')</span></span>
<span id="cb47-261"><a href="#cb47-261" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_out.colorbar(im2, ax=axs_out[0, 1], shrink=0.7)</span></span>
<span id="cb47-262"><a href="#cb47-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-263"><a href="#cb47-263" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Movement density log-probability</span></span>
<span id="cb47-264"><a href="#cb47-264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im3 = axs_out[1, 0].imshow(move_density_mask, cmap='viridis')</span></span>
<span id="cb47-265"><a href="#cb47-265" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_out[1, 0].set_title('Movement log-probability')</span></span>
<span id="cb47-266"><a href="#cb47-266" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_out.colorbar(im3, ax=axs_out[1, 0], shrink=0.7)</span></span>
<span id="cb47-267"><a href="#cb47-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-268"><a href="#cb47-268" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # # Next-step log probability</span></span>
<span id="cb47-269"><a href="#cb47-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # im4 = axs[1, 1].imshow(step_density_mask, cmap='viridis')</span></span>
<span id="cb47-270"><a href="#cb47-270" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # axs[1, 1].set_title('Next-step log-probability')</span></span>
<span id="cb47-271"><a href="#cb47-271" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # fig.colorbar(im4, ax=axs[1, 1], shrink=0.7)</span></span>
<span id="cb47-272"><a href="#cb47-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-273"><a href="#cb47-273" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # [(int(py2_subset), int(px2_subset))]</span></span>
<span id="cb47-274"><a href="#cb47-274" aria-hidden="true" tabindex="-1"></a>        <span class="co"># next_step_mask = np.ones_like(hab_density)</span></span>
<span id="cb47-275"><a href="#cb47-275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># next_step_mask[int(py2_subset), int(px2_subset)] = -np.inf</span></span>
<span id="cb47-276"><a href="#cb47-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-277"><a href="#cb47-277" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Next-step probability</span></span>
<span id="cb47-278"><a href="#cb47-278" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im4 = axs_out[1, 1].imshow(step_density_exp_norm_mask * next_step_mask, cmap='viridis')</span></span>
<span id="cb47-279"><a href="#cb47-279" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_out[1, 1].set_title('Next-step probability')</span></span>
<span id="cb47-280"><a href="#cb47-280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_out.colorbar(im4, ax=axs_out[1, 1], shrink=0.7)</span></span>
<span id="cb47-281"><a href="#cb47-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-282"><a href="#cb47-282" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # filename_covs = f'outputs/next_step_validation/id{buffalo_id}_yday{yday_t2_integer}_hour{hour_t2_integer}_bearing{bearing_degrees}_next_r{row}_c{column}.png'</span></span>
<span id="cb47-283"><a href="#cb47-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plt.tight_layout()</span></span>
<span id="cb47-284"><a href="#cb47-284" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plt.savefig(filename_covs, dpi=600, bbox_inches='tight')</span></span>
<span id="cb47-285"><a href="#cb47-285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plt.show()</span></span>
<span id="cb47-286"><a href="#cb47-286" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plt.close()  # Close the figure to free memory</span></span>
<span id="cb47-287"><a href="#cb47-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-288"><a href="#cb47-288" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-289"><a href="#cb47-289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the habitat probs through time as a line graph</span></span>
<span id="cb47-290"><a href="#cb47-290" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.log(habitat_probs[habitat_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb47-291"><a href="#cb47-291" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb47-292"><a href="#cb47-292" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb47-293"><a href="#cb47-293" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Habitat Probability'</span>)</span>
<span id="cb47-294"><a href="#cb47-294" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-295"><a href="#cb47-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-296"><a href="#cb47-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the movement probs through time as a line graph</span></span>
<span id="cb47-297"><a href="#cb47-297" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.log(move_probs[move_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb47-298"><a href="#cb47-298" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb47-299"><a href="#cb47-299" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb47-300"><a href="#cb47-300" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Movement Probability'</span>)</span>
<span id="cb47-301"><a href="#cb47-301" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-302"><a href="#cb47-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-303"><a href="#cb47-303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the next_step probs through time as a line graph</span></span>
<span id="cb47-304"><a href="#cb47-304" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.log(next_step_probs[next_step_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb47-305"><a href="#cb47-305" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb47-306"><a href="#cb47-306" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb47-307"><a href="#cb47-307" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Next-step Probability'</span>)</span>
<span id="cb47-308"><a href="#cb47-308" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb47-309"><a href="#cb47-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-310"><a href="#cb47-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the probabilities to the dataframe</span></span>
<span id="cb47-311"><a href="#cb47-311" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'habitat_probs'</span>] <span class="op">=</span> habitat_probs</span>
<span id="cb47-312"><a href="#cb47-312" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'move_probs'</span>] <span class="op">=</span> move_probs</span>
<span id="cb47-313"><a href="#cb47-313" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'next_step_probs'</span>] <span class="op">=</span> next_step_probs</span>
<span id="cb47-314"><a href="#cb47-314" aria-hidden="true" tabindex="-1"></a>    csv_filename <span class="op">=</span> <span class="ss">f'../outputs/next_step_probs_S2_id</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>today_date<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb47-315"><a href="#cb47-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-316"><a href="#cb47-316" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(csv_filename)</span>
<span id="cb47-317"><a href="#cb47-317" aria-hidden="true" tabindex="-1"></a>    buffalo_df.to_csv(csv_filename, index<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2005_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2014_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2018_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-13.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-15.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2021_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-17.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-18.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-19.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2022_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-21.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-22.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-23.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2024_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-25.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-26.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-27.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2039_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-29.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-30.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-31.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2154_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-33.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-34.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-35.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2158_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-37.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-38.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-39.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2223_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-41.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-42.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-43.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2327_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-45.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-46.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-47.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2387_2025-01-03.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-49.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-50.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_S2_files/figure-html/cell-29-output-51.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_S2_id2393_2025-01-03.csv</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="64">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>buffalo_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="64">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x_</th>
<th data-quarto-table-cell-role="th">y_</th>
<th data-quarto-table-cell-role="th">t_</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">x1_</th>
<th data-quarto-table-cell-role="th">y1_</th>
<th data-quarto-table-cell-role="th">x2_</th>
<th data-quarto-table-cell-role="th">y2_</th>
<th data-quarto-table-cell-role="th">x2_cent</th>
<th data-quarto-table-cell-role="th">y2_cent</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">x_max</th>
<th data-quarto-table-cell-role="th">y_min</th>
<th data-quarto-table-cell-role="th">y_max</th>
<th data-quarto-table-cell-role="th">ndvi_index</th>
<th data-quarto-table-cell-role="th">year_t2</th>
<th data-quarto-table-cell-role="th">yday_t2_2018_base</th>
<th data-quarto-table-cell-role="th">bearing_tm1</th>
<th data-quarto-table-cell-role="th">habitat_probs</th>
<th data-quarto-table-cell-role="th">move_probs</th>
<th data-quarto-table-cell-role="th">next_step_probs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>32550.348534</td>
<td>-1.423005e+06</td>
<td>2018-07-25T02:11:31Z</td>
<td>2393</td>
<td>32550.348534</td>
<td>-1.423005e+06</td>
<td>32550.671636</td>
<td>-1.423009e+06</td>
<td>0.323102</td>
<td>-4.336324</td>
<td>...</td>
<td>33812.848534</td>
<td>-1.424267e+06</td>
<td>-1.421742e+06</td>
<td>8</td>
<td>2018</td>
<td>206</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>32550.671636</td>
<td>-1.423009e+06</td>
<td>2018-07-25T03:10:28Z</td>
<td>2393</td>
<td>32550.671636</td>
<td>-1.423009e+06</td>
<td>32549.540847</td>
<td>-1.423008e+06</td>
<td>-1.130789</td>
<td>0.917171</td>
<td>...</td>
<td>33813.171636</td>
<td>-1.424272e+06</td>
<td>-1.421747e+06</td>
<td>8</td>
<td>2018</td>
<td>206</td>
<td>-1.496423</td>
<td>0.000090</td>
<td>0.017356</td>
<td>0.015585</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>32549.540847</td>
<td>-1.423008e+06</td>
<td>2018-07-25T04:11:04Z</td>
<td>2393</td>
<td>32549.540847</td>
<td>-1.423008e+06</td>
<td>32552.107877</td>
<td>-1.423003e+06</td>
<td>2.567030</td>
<td>5.311862</td>
<td>...</td>
<td>33812.040847</td>
<td>-1.424271e+06</td>
<td>-1.421746e+06</td>
<td>8</td>
<td>2018</td>
<td>206</td>
<td>2.460126</td>
<td>0.000096</td>
<td>0.020171</td>
<td>0.019478</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>32552.107877</td>
<td>-1.423003e+06</td>
<td>2018-07-25T05:12:01Z</td>
<td>2393</td>
<td>32552.107877</td>
<td>-1.423003e+06</td>
<td>32555.777954</td>
<td>-1.423001e+06</td>
<td>3.670077</td>
<td>2.023739</td>
<td>...</td>
<td>33814.607877</td>
<td>-1.424266e+06</td>
<td>-1.421741e+06</td>
<td>8</td>
<td>2018</td>
<td>206</td>
<td>1.120627</td>
<td>0.000096</td>
<td>0.088415</td>
<td>0.082264</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>32555.777954</td>
<td>-1.423001e+06</td>
<td>2018-07-25T06:10:49Z</td>
<td>2393</td>
<td>32555.777954</td>
<td>-1.423001e+06</td>
<td>32550.932926</td>
<td>-1.422997e+06</td>
<td>-4.845028</td>
<td>3.771053</td>
<td>...</td>
<td>33818.277954</td>
<td>-1.424264e+06</td>
<td>-1.421739e+06</td>
<td>8</td>
<td>2018</td>
<td>206</td>
<td>0.503930</td>
<td>0.000100</td>
<td>0.011493</td>
<td>0.010830</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4928</td>
<td>28787.834376</td>
<td>-1.424392e+06</td>
<td>2019-03-27T16:00:32Z</td>
<td>2393</td>
<td>28787.834376</td>
<td>-1.424392e+06</td>
<td>28777.782281</td>
<td>-1.424457e+06</td>
<td>-10.052095</td>
<td>-65.189917</td>
<td>...</td>
<td>30050.334376</td>
<td>-1.425654e+06</td>
<td>-1.423129e+06</td>
<td>16</td>
<td>2019</td>
<td>452</td>
<td>1.614742</td>
<td>0.000027</td>
<td>0.002081</td>
<td>0.000713</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4929</td>
<td>28777.782281</td>
<td>-1.424457e+06</td>
<td>2019-03-27T17:01:31Z</td>
<td>2393</td>
<td>28777.782281</td>
<td>-1.424457e+06</td>
<td>28716.577830</td>
<td>-1.424413e+06</td>
<td>-61.204452</td>
<td>43.456804</td>
<td>...</td>
<td>30040.282281</td>
<td>-1.425719e+06</td>
<td>-1.423194e+06</td>
<td>16</td>
<td>2019</td>
<td>452</td>
<td>-1.723788</td>
<td>0.000061</td>
<td>0.001257</td>
<td>0.000586</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4930</td>
<td>28716.577830</td>
<td>-1.424413e+06</td>
<td>2019-03-27T18:01:19Z</td>
<td>2393</td>
<td>28716.577830</td>
<td>-1.424413e+06</td>
<td>28714.836029</td>
<td>-1.424412e+06</td>
<td>-1.741801</td>
<td>0.895489</td>
<td>...</td>
<td>29979.077830</td>
<td>-1.425676e+06</td>
<td>-1.423151e+06</td>
<td>16</td>
<td>2019</td>
<td>452</td>
<td>2.524169</td>
<td>0.000068</td>
<td>0.090440</td>
<td>0.046953</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4931</td>
<td>28714.836029</td>
<td>-1.424412e+06</td>
<td>2019-03-27T19:00:46Z</td>
<td>2393</td>
<td>28714.836029</td>
<td>-1.424412e+06</td>
<td>28712.673595</td>
<td>-1.424411e+06</td>
<td>-2.162434</td>
<td>1.573750</td>
<td>...</td>
<td>29977.336029</td>
<td>-1.425675e+06</td>
<td>-1.423150e+06</td>
<td>16</td>
<td>2019</td>
<td>452</td>
<td>2.666716</td>
<td>0.000070</td>
<td>0.044450</td>
<td>0.022507</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4932</td>
<td>28712.673595</td>
<td>-1.424411e+06</td>
<td>2019-03-27T20:00:32Z</td>
<td>2393</td>
<td>28712.673595</td>
<td>-1.424411e+06</td>
<td>28860.395066</td>
<td>-1.424357e+06</td>
<td>147.721471</td>
<td>53.920949</td>
<td>...</td>
<td>29975.173595</td>
<td>-1.425673e+06</td>
<td>-1.423148e+06</td>
<td>16</td>
<td>2019</td>
<td>452</td>
<td>2.512473</td>
<td>0.000108</td>
<td>0.000570</td>
<td>0.000488</td>
</tr>
</tbody>
</table>

<p>4933 rows Ã— 38 columns</p>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Python/deepSSF_next_step_validation.html" class="pagination-link" aria-label="deepSSF Validation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">deepSSF Validation</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>