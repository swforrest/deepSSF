<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Import packages â€“ deepSSF</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">deepSSF</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">about</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/swforrest/deepSSF"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#import-data" id="toc-import-data" class="nav-link active" data-scroll-target="#import-data">Import data</a>
  <ul class="collapse">
  <li><a href="#importing-spatial-data" id="toc-importing-spatial-data" class="nav-link" data-scroll-target="#importing-spatial-data">Importing spatial data</a></li>
  <li><a href="#global-layers" id="toc-global-layers" class="nav-link" data-scroll-target="#global-layers">Global layers</a>
  <ul class="collapse">
  <li><a href="#ndvi" id="toc-ndvi" class="nav-link" data-scroll-target="#ndvi">NDVI</a></li>
  <li><a href="#canopy-cover" id="toc-canopy-cover" class="nav-link" data-scroll-target="#canopy-cover">Canopy cover</a></li>
  <li><a href="#herbaceous-vegetation" id="toc-herbaceous-vegetation" class="nav-link" data-scroll-target="#herbaceous-vegetation">Herbaceous vegetation</a></li>
  <li><a href="#slope" id="toc-slope" class="nav-link" data-scroll-target="#slope">Slope</a></li>
  </ul></li>
  <li><a href="#global-layers-1" id="toc-global-layers-1" class="nav-link" data-scroll-target="#global-layers-1">Global layers</a>
  <ul class="collapse">
  <li><a href="#going-between-cell-and-raster-coordinates" id="toc-going-between-cell-and-raster-coordinates" class="nav-link" data-scroll-target="#going-between-cell-and-raster-coordinates">Going between cell and raster coordinates</a></li>
  </ul></li>
  <li><a href="#subset-function" id="toc-subset-function" class="nav-link" data-scroll-target="#subset-function">Subset function</a></li>
  </ul></li>
  <li><a href="#running-the-model-on-the-subset-layers" id="toc-running-the-model-on-the-subset-layers" class="nav-link" data-scroll-target="#running-the-model-on-the-subset-layers">Running the model on the subset layers</a>
  <ul class="collapse">
  <li><a href="#set-the-device-for-the-model" id="toc-set-the-device-for-the-model" class="nav-link" data-scroll-target="#set-the-device-for-the-model">Set the device for the model</a></li>
  </ul></li>
  <li><a href="#define-the-model" id="toc-define-the-model" class="nav-link" data-scroll-target="#define-the-model">Define the model</a>
  <ul class="collapse">
  <li><a href="#instantiate-the-model" id="toc-instantiate-the-model" class="nav-link" data-scroll-target="#instantiate-the-model">Instantiate the model</a></li>
  <li><a href="#load-the-model-weights" id="toc-load-the-model-weights" class="nav-link" data-scroll-target="#load-the-model-weights">Load the model weights</a></li>
  <li><a href="#setup-validation" id="toc-setup-validation" class="nav-link" data-scroll-target="#setup-validation">Setup validation</a></li>
  </ul></li>
  <li><a href="#next-step-probability-values" id="toc-next-step-probability-values" class="nav-link" data-scroll-target="#next-step-probability-values">Next-step probability values</a></li>
  <li><a href="#loop-the-validation-over-each-individual" id="toc-loop-the-validation-over-each-individual" class="nav-link" data-scroll-target="#loop-the-validation-over-each-individual">Loop the validation over each individual</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Import packages</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="cell-2" class="cell" data-outputid="205da944-eee9-4a12-8089-25362f87a046" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.version)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install rasterio</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.plot <span class="im">import</span> show</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Get today's date</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>today_date <span class="op">=</span> datetime.today().strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.12.5 | packaged by Anaconda, Inc. | (main, Sep 12 2024, 18:18:29) [MSC v.1929 64 bit (AMD64)]</code></pre>
</div>
</div>
<div id="cell-3" class="cell" data-outputid="a4f7f38c-a7fd-4451-ef8c-e8cdf69c3201" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from google.colab import drive</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># drive.mount('/content/drive')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>image_dim <span class="op">=</span> <span class="dv">101</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>pixel_size <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>center <span class="op">=</span> image_dim <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>y, x <span class="op">=</span> np.indices((image_dim, image_dim))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>distance_layer <span class="op">=</span> np.sqrt((pixel_size<span class="op">*</span>(x <span class="op">-</span> center))<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (pixel_size<span class="op">*</span>(y <span class="op">-</span> center))<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># change the centre cell to the average distance from the centre to the edge of the pixel</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>distance_layer[center, center] <span class="op">=</span> <span class="fl">0.56</span><span class="op">*</span>pixel_size <span class="co"># average distance from the centre to the perimeter of the pixel (accounting for longer distances at the corners)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>bearing_layer <span class="op">=</span> np.arctan2(center <span class="op">-</span> y, x <span class="op">-</span> center)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both of the layers</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].imshow(distance_layer)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">'Distance Layer'</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># add colour scale</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(ax[<span class="dv">0</span>].imshow(distance_layer), ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].imshow(bearing_layer)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">'Bearing Layer'</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># add colour scale</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(ax[<span class="dv">1</span>].imshow(bearing_layer), ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="import-data" class="level1">
<h1>Import data</h1>
<div id="cell-6" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get today's date</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>today_date <span class="op">=</span> datetime.today().strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># select the id to train the model on</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>buffalo_id <span class="op">=</span> <span class="dv">2005</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="dv">10297</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2014</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 6572</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2327</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 8983</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2387</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 10409</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the path to your CSV file</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>csv_file_path <span class="op">=</span> <span class="ss">f'../buffalo_local_data_id/validation/validation_buffalo_</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_data_df_lag_1hr_n</span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file into a DataFrame</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>buffalo_df <span class="op">=</span> pd.read_csv(csv_file_path)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Lag the values in column 'A' by one index</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Pad the missing value with a specified value, e.g., 0</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing_tm1'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

         ta    cos_ta         x_min         x_max         y_min         y_max  \
0  1.367942  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06   
1 -0.021429  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06   
2  2.994917 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06   
3 -2.799767 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06   
4  0.285377  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06   

   s2_index  points_vect_cent  year_t2  yday_t2_2018_base  
0         7               NaN     2018                206  
1         7               NaN     2018                206  
2         7               NaN     2018                206  
3         7               NaN     2018                206  
4         7               NaN     2018                206  

[5 rows x 35 columns]
             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

     cos_ta         x_min         x_max         y_min         y_max  s2_index  \
0  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06         7   
1  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06         7   
2 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06         7   
3 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06         7   
4  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06         7   

   points_vect_cent  year_t2  yday_t2_2018_base  bearing_tm1  
0               NaN     2018                206     0.000000  
1               NaN     2018                206     2.802478  
2               NaN     2018                206     2.781049  
3               NaN     2018                206    -0.507220  
4               NaN     2018                206     2.976198  

[5 rows x 36 columns]</code></pre>
</div>
</div>
<section id="importing-spatial-data" class="level2">
<h2 class="anchored" data-anchor-id="importing-spatial-data">Importing spatial data</h2>
</section>
<section id="global-layers" class="level2">
<h2 class="anchored" data-anchor-id="global-layers">Global layers</h2>
<section id="ndvi" class="level3">
<h3 class="anchored" data-anchor-id="ndvi">NDVI</h3>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for monthly NDVI</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'../mapping/cropped rasters/ndvi_monthly.tif'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># read the raster file</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the raster band as separate variable</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    ndvi_global <span class="op">=</span> src.read([i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, src.count <span class="op">+</span> <span class="dv">1</span>)])</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the metadata of the raster</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ndvi_meta <span class="op">=</span> src.meta</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    raster_transform <span class="op">=</span> src.transform</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the metadata to check for time component</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Metadata:"</span>, ndvi_meta)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for specific time-related metadata</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'TIFFTAG_DATETIME'</span> <span class="kw">in</span> src.tags():</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Time component found:"</span>, src.tags()[<span class="st">'TIFFTAG_DATETIME'</span>])</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No explicit time component found in metadata."</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co"># the rasters don't contain a time component</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Metadata: {'driver': 'GTiff', 'dtype': 'float32', 'nodata': nan, 'width': 2400, 'height': 2280, 'count': 24, 'crs': CRS.from_wkt('LOCAL_CS["GDA94 / Geoscience Australia Lambert",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]'), 'transform': Affine(25.0, 0.0, 0.0,
       0.0, -25.0, -1406000.0)}
No explicit time component found in metadata.</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ndvi_meta)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_transform)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ndvi_global.shape)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace NaNs in the original array with -1, which represents water</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>ndvi_global <span class="op">=</span> np.nan_to_num(ndvi_global, nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># from the stack of local layers</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>ndvi_max <span class="op">=</span> <span class="fl">0.8220</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>ndvi_min <span class="op">=</span> <span class="op">-</span><span class="fl">0.2772</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>ndvi_global_tens <span class="op">=</span> torch.from_numpy(ndvi_global)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the data</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>ndvi_global_norm <span class="op">=</span> (ndvi_global_tens <span class="op">-</span> ndvi_min) <span class="op">/</span> (ndvi_max <span class="op">-</span> ndvi_min)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.imshow(ndvi_global_norm.numpy())</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.colorbar()  </span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>plt.imshow(ndvi_global_norm[<span class="dv">1</span>,:,:].numpy())</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>plt.colorbar()  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.imshow(ndvi_global_norm[8,:,:].numpy())</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.colorbar()  </span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'driver': 'GTiff', 'dtype': 'float32', 'nodata': nan, 'width': 2400, 'height': 2280, 'count': 24, 'crs': CRS.from_wkt('LOCAL_CS["GDA94 / Geoscience Australia Lambert",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]'), 'transform': Affine(25.0, 0.0, 0.0,
       0.0, -25.0, -1406000.0)}
| 25.00, 0.00, 0.00|
| 0.00,-25.00,-1406000.00|
| 0.00, 0.00, 1.00|
(24, 2280, 2400)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="canopy-cover" class="level3">
<h3 class="anchored" data-anchor-id="canopy-cover">Canopy cover</h3>
<div id="cell-13" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'../mapping/cropped rasters/canopy_cover.tif'</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># read the raster file</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the raster band as separate variable</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    canopy_global <span class="op">=</span> src.read(<span class="dv">1</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the metadata of the raster</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    canopy_meta <span class="op">=</span> src.meta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(canopy_meta)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(canopy_global.shape)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># from the stack of local layers</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>canopy_max <span class="op">=</span> <span class="fl">82.5000</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>canopy_min <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>canopy_global_tens <span class="op">=</span> torch.from_numpy(canopy_global)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the data</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>canopy_global_norm <span class="op">=</span> (canopy_global_tens <span class="op">-</span> canopy_min) <span class="op">/</span> (canopy_max <span class="op">-</span> canopy_min)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>plt.imshow(canopy_global_norm.numpy())</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>plt.colorbar()  </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'driver': 'GTiff', 'dtype': 'float32', 'nodata': -3.3999999521443642e+38, 'width': 2400, 'height': 2280, 'count': 1, 'crs': CRS.from_wkt('LOCAL_CS["GDA94 / Geoscience Australia Lambert",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]'), 'transform': Affine(25.0, 0.0, 0.0,
       0.0, -25.0, -1406000.0)}
(2280, 2400)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="herbaceous-vegetation" class="level3">
<h3 class="anchored" data-anchor-id="herbaceous-vegetation">Herbaceous vegetation</h3>
<div id="cell-16" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'../mapping/cropped rasters/veg_herby.tif'</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># read the raster file</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the raster band as separate variable</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    herby_global <span class="op">=</span> src.read(<span class="dv">1</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the metadata of the raster</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    herby_meta <span class="op">=</span> src.meta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(herby_meta)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(herby_global.shape)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># from the stack of local layers</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>herby_max <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>herby_min <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>herby_global_tens <span class="op">=</span> torch.from_numpy(herby_global)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the data</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>herby_global_norm <span class="op">=</span> (herby_global_tens <span class="op">-</span> herby_min) <span class="op">/</span> (herby_max <span class="op">-</span> herby_min)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>plt.imshow(herby_global_norm.numpy())</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>plt.colorbar()  </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'driver': 'GTiff', 'dtype': 'float32', 'nodata': -3.3999999521443642e+38, 'width': 2400, 'height': 2280, 'count': 1, 'crs': CRS.from_wkt('LOCAL_CS["GDA94 / Geoscience Australia Lambert",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]'), 'transform': Affine(25.0, 0.0, 0.0,
       0.0, -25.0, -1406000.0)}
(2280, 2400)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="slope" class="level3">
<h3 class="anchored" data-anchor-id="slope">Slope</h3>
<div id="cell-19" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'../mapping/cropped rasters/slope.tif'</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># read the raster file</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the raster band as separate variable</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    slope_global <span class="op">=</span> src.read(<span class="dv">1</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the metadata of the raster</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    slope_meta <span class="op">=</span> src.meta</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    slope_transform <span class="op">=</span> src.transform <span class="co"># same as the raster transform in the NDVI raster read</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_global)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_transform)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[       nan        nan        nan ...        nan        nan        nan]
 [       nan 0.3352837  0.39781624 ... 0.         0.                nan]
 [       nan 0.3983888  0.48142004 ... 0.         0.                nan]
 ...
 [       nan 2.215875   1.9798415  ... 1.5078747  1.268342          nan]
 [       nan 1.9740707  1.7354656  ... 1.697194   1.4880029         nan]
 [       nan        nan        nan ...        nan        nan        nan]]
| 25.00, 0.00, 0.00|
| 0.00,-25.00,-1406000.00|
| 0.00, 0.00, 1.00|</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_meta)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(slope_global.shape)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace NaNs in the original array with -1, which represents water</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>slope_global <span class="op">=</span> np.nan_to_num(slope_global, nan<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># from the stack of local layers</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>slope_max <span class="op">=</span> <span class="fl">12.2981</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>slope_min <span class="op">=</span> <span class="fl">0.0006</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>slope_global_tens <span class="op">=</span> torch.from_numpy(slope_global)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizing the data</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>slope_global_norm <span class="op">=</span> (slope_global_tens <span class="op">-</span> slope_min) <span class="op">/</span> (slope_max <span class="op">-</span> slope_min)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>plt.imshow(slope_global_norm.numpy())</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>plt.colorbar()  </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'driver': 'GTiff', 'dtype': 'float32', 'nodata': nan, 'width': 2400, 'height': 2280, 'count': 1, 'crs': CRS.from_wkt('LOCAL_CS["GDA94 / Geoscience Australia Lambert",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]'), 'transform': Affine(25.0, 0.0, 0.0,
       0.0, -25.0, -1406000.0)}
(2280, 2400)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="global-layers-1" class="level2">
<h2 class="anchored" data-anchor-id="global-layers-1">Global layers</h2>
<div id="cell-22" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure and axis with matplotlib</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="fl">7.5</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the raster</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>show(slope_global, transform<span class="op">=</span>raster_transform, ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the title and labels</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Raster with Geographic Coordinates'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Longitude'</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Latitude'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="going-between-cell-and-raster-coordinates" class="level3">
<h3 class="anchored" data-anchor-id="going-between-cell-and-raster-coordinates">Going between cell and raster coordinates</h3>
<div id="cell-24" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> <span class="fl">5.9e4</span>, <span class="op">-</span><span class="fl">1.447e6</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x, y)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>px, py <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x, y)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Round pixel coordinates to integers</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>px, py <span class="op">=</span> <span class="bu">int</span>(<span class="bu">round</span>(px)), <span class="bu">int</span>(<span class="bu">round</span>(py))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the pixel coordinates   </span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(px, py)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>59000.0 -1447000.0
2360 1640</code></pre>
</div>
</div>
</section>
</section>
<section id="subset-function" class="level2">
<h2 class="anchored" data-anchor-id="subset-function">Subset function</h2>
<div id="cell-26" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> subset_raster_with_padding_torch(raster_tensor, x, y, window_size, transform):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    px, py <span class="op">=</span> <span class="op">~</span>transform <span class="op">*</span> (x, y)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Round pixel coordinates to integers</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># px, py = int(round(px)), int(round(py)) # this will go to the cell adjacent when above 0.5 - which is NOT what we want</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    px, py <span class="op">=</span> <span class="bu">int</span>(px), <span class="bu">int</span>(py) <span class="co"># this will always round towards zero, therefore staying in the same cell</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define half the window size</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    half_window <span class="op">=</span> window_size <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the window boundaries</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    row_start <span class="op">=</span> py <span class="op">-</span> half_window</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    row_stop <span class="op">=</span> py <span class="op">+</span> half_window <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    col_start <span class="op">=</span> px <span class="op">-</span> half_window</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    col_stop <span class="op">=</span> px <span class="op">+</span> half_window <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the subset tensor with zeros (or any other padding value)</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> torch.full((window_size, window_size), <span class="op">-</span><span class="fl">1.0</span>, dtype<span class="op">=</span>raster_tensor.dtype)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the valid region within the raster bounds</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    valid_row_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, row_start)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    valid_row_stop <span class="op">=</span> <span class="bu">min</span>(raster_tensor.shape[<span class="dv">0</span>], row_stop)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    valid_col_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, col_start)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    valid_col_stop <span class="op">=</span> <span class="bu">min</span>(raster_tensor.shape[<span class="dv">1</span>], col_stop)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the corresponding region in the subset tensor</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    subset_row_start <span class="op">=</span> valid_row_start <span class="op">-</span> row_start</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    subset_row_stop <span class="op">=</span> subset_row_start <span class="op">+</span> (valid_row_stop <span class="op">-</span> valid_row_start)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    subset_col_start <span class="op">=</span> valid_col_start <span class="op">-</span> col_start</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    subset_col_stop <span class="op">=</span> subset_col_start <span class="op">+</span> (valid_col_stop <span class="op">-</span> valid_col_start)</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Copy the valid region from the raster tensor to the subset tensor</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    subset[subset_row_start:subset_row_stop, subset_col_start:subset_col_stop] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        raster_tensor[valid_row_start:valid_row_stop, valid_col_start:valid_col_stop]</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> subset, col_start, row_start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Testing the subset function</p>
<div id="cell-28" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">5.9e4</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="op">-</span><span class="fl">1.41e6</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>window_size <span class="op">=</span> <span class="dv">101</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>which_ndvi <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>ndvi_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(ndvi_global_norm[which_ndvi,:,:], x, y, window_size, raster_transform)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>canopy_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(canopy_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>herby_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(herby_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the subset</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].imshow(ndvi_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'NDVI Subset'</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[0, 0].axis('off')</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].imshow(canopy_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Canopy Cover Subset'</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[0, 1].axis('off')</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].imshow(herby_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Herbaceous Vegetation Subset'</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[1, 0].axis('off')</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].imshow(slope_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Slope Subset'</span>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[1, 1].axis('off')</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Text(0.5, 1.0, 'Slope Subset')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-17-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="running-the-model-on-the-subset-layers" class="level1">
<h1>Running the model on the subset layers</h1>
<section id="set-the-device-for-the-model" class="level3">
<h3 class="anchored" data-anchor-id="set-the-device-for-the-model">Set the device for the model</h3>
<div id="cell-31" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train on the GPU or on the CPU, if a GPU is not available</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span>) <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> torch.device(<span class="st">'cpu'</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using </span><span class="sc">{</span>device<span class="sc">}</span><span class="ss"> device"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using cpu device</code></pre>
</div>
</div>
</section>
</section>
<section id="define-the-model" class="level1">
<h1>Define the model</h1>
<div id="cell-33" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Conv2d_block_toFC(nn.Module):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Conv2d_block_toFC, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_channels <span class="op">=</span> params.input_channels</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_channels <span class="op">=</span> params.output_channels</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size <span class="op">=</span> params.kernel_size</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride <span class="op">=</span> params.stride</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size_mp <span class="op">=</span> params.kernel_size_mp</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride_mp <span class="op">=</span> params.stride_mp</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.padding <span class="op">=</span> params.padding</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2d <span class="op">=</span> nn.Sequential(</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.input_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        nn.MaxPool2d(kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size_mp, stride<span class="op">=</span><span class="va">self</span>.stride_mp),</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.output_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        nn.MaxPool2d(kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size_mp, stride<span class="op">=</span><span class="va">self</span>.stride_mp),</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        nn.Flatten())</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.conv2d(x)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Conv2d_block_spatial(nn.Module):</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Conv2d_block_spatial, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_channels <span class="op">=</span> params.input_channels</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_channels <span class="op">=</span> params.output_channels</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size <span class="op">=</span> params.kernel_size</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride <span class="op">=</span> params.stride</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.kernel_size_mp = params.kernel_size_mp</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.stride_mp = params.stride_mp</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.padding <span class="op">=</span> params.padding</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2d <span class="op">=</span> nn.Sequential(</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.input_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.output_channels, out_channels<span class="op">=</span><span class="va">self</span>.output_channels, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding),</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>        nn.ReLU(),</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels<span class="op">=</span><span class="va">self</span>.output_channels, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="va">self</span>.kernel_size, stride<span class="op">=</span><span class="va">self</span>.stride, padding<span class="op">=</span><span class="va">self</span>.padding)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("Shape before squeeze:", self.conv2d(x).shape)</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>        conv2d_spatial <span class="op">=</span> <span class="va">self</span>.conv2d(x).squeeze(dim <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("Shape before logsumexp:", conv2d_spatial.shape)</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise before combining with the movement grid</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>        conv2d_spatial <span class="op">=</span> conv2d_spatial <span class="op">-</span> torch.logsumexp(conv2d_spatial, dim <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># conv2d_spatial = conv2d_spatial/torch.sum(conv2d_spatial)</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conv2d_spatial</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FCN_block_all_habitat(nn.Module):</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FCN_block_all_habitat, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_all <span class="op">=</span> params.dense_dim_in_all</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> params.dense_dim_hidden</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> params.dense_dim_out</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> params.dropout</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffn <span class="op">=</span> nn.Sequential(</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_in_all, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.image_dim <span class="op">*</span> <span class="va">self</span>.image_dim)</span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.ffn(x)</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FCN_block_all_movement(nn.Module):</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FCN_block_all_movement, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_all <span class="op">=</span> params.dense_dim_in_all</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> params.dense_dim_hidden</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> params.dense_dim_out</span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_movement_params <span class="op">=</span> params.num_movement_params</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> params.dropout</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffn <span class="op">=</span> nn.Sequential(</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_in_all, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.num_movement_params)</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.ffn(x)</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FCN_block_nonspatial(nn.Module):</span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FCN_block_nonspatial, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_nonspatial <span class="op">=</span> params.dense_dim_in_nonspatial</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> params.dense_dim_hidden</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> params.dense_dim_out</span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> params.dropout</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ffn <span class="op">=</span> nn.Sequential(</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_in_nonspatial, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_hidden),</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="va">self</span>.dropout),</span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="va">self</span>.dense_dim_hidden, <span class="va">self</span>.dense_dim_out)</span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.ffn(x)</span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a><span class="co">##################################################</span></span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixture of two Gamma and von Mises distributions with the von Mises mu parameters allowed to vary</span></span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a><span class="co">##################################################</span></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Params_to_Grid_Block(nn.Module):</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Params_to_Grid_Block, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pixel_size <span class="op">=</span> params.pixel_size</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.center <span class="op">=</span> <span class="va">self</span>.image_dim <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a>        y, x <span class="op">=</span> np.indices((<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim))</span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_layer <span class="op">=</span> torch.from_numpy(np.sqrt((<span class="va">self</span>.pixel_size<span class="op">*</span>(x <span class="op">-</span> <span class="va">self</span>.center))<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (<span class="va">self</span>.pixel_size<span class="op">*</span>(y <span class="op">-</span> <span class="va">self</span>.center))<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># change the centre cell to the average distance from the centre to the edge of the pixel</span></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_layer[<span class="va">self</span>.center, <span class="va">self</span>.center] <span class="op">=</span> <span class="fl">0.56</span><span class="op">*</span><span class="va">self</span>.pixel_size <span class="co"># average distance from the centre to the perimeter of the pixel (accounting for longer distances at the corners)</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.bearing_layer = torch.from_numpy(np.arctan2(y - self.center, x - self.center))</span></span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bearing_layer <span class="op">=</span> torch.from_numpy(np.arctan2(<span class="va">self</span>.center <span class="op">-</span> y, x <span class="op">-</span> <span class="va">self</span>.center))</span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gamma desnities for the mixture distribution</span></span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gamma_density(<span class="va">self</span>, x, shape, scale):</span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure all tensors are on the same device as x</span></span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a>        shape <span class="op">=</span> shape.to(x.device)</span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> scale.to(x.device)</span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span>torch.lgamma(shape) <span class="op">-</span>shape<span class="op">*</span>torch.log(scale) <span class="op">+</span> (shape <span class="op">-</span> <span class="dv">1</span>)<span class="op">*</span>torch.log(x) <span class="op">-</span> x<span class="op">/</span>scale</span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># von Mises densities for the mixture distribution</span></span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vonmises_density(<span class="va">self</span>, x, kappa, vm_mu):</span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure all tensors are on the same device as x</span></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a>        kappa <span class="op">=</span> kappa.to(x.device)</span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>        vm_mu <span class="op">=</span> vm_mu.to(x.device)</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> kappa<span class="op">*</span>torch.cos(x <span class="op">-</span> vm_mu) <span class="op">-</span> <span class="dv">1</span><span class="op">*</span>(np.log(<span class="dv">2</span><span class="op">*</span>torch.pi) <span class="op">+</span> torch.log(torch.special.i0(kappa)))</span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, bearing):</span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the first mixture distribution</span></span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a>        gamma_shape1 <span class="op">=</span> torch.exp(x[:, <span class="dv">0</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a>        gamma_shape1 <span class="op">=</span> gamma_shape1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a>        gamma_shape1 <span class="op">=</span> gamma_shape1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a>        gamma_scale1 <span class="op">=</span> torch.exp(x[:, <span class="dv">1</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a>        gamma_scale1 <span class="op">=</span> gamma_scale1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a>        gamma_scale1 <span class="op">=</span> gamma_scale1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> torch.exp(x[:, <span class="dv">2</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> gamma_weight1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> gamma_weight1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the second mixture distribution</span></span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a>        gamma_shape2 <span class="op">=</span> torch.exp(x[:, <span class="dv">3</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a>        gamma_shape2 <span class="op">=</span> gamma_shape2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>        gamma_shape2 <span class="op">=</span> gamma_shape2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> torch.exp(x[:, <span class="dv">4</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> gamma_scale2 <span class="op">*</span> <span class="dv">500</span> <span class="co">### to transform the scale parameter to be near 1</span></span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> gamma_scale2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a>        gamma_scale2 <span class="op">=</span> gamma_scale2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> torch.exp(x[:, <span class="dv">5</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> gamma_weight2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> gamma_weight2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply softmax to the weights</span></span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a>        gamma_weights <span class="op">=</span> torch.stack([gamma_weight1, gamma_weight2], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a>        gamma_weights <span class="op">=</span> torch.nn.functional.softmax(gamma_weights, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a>        gamma_weight1 <span class="op">=</span> gamma_weights[<span class="dv">0</span>]</span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a>        gamma_weight2 <span class="op">=</span> gamma_weights[<span class="dv">1</span>]</span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculation of Gamma densities</span></span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a>        gamma_density_layer1 <span class="op">=</span> <span class="va">self</span>.gamma_density(<span class="va">self</span>.distance_layer, gamma_shape1, gamma_scale1).to(device)</span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a>        gamma_density_layer2 <span class="op">=</span> <span class="va">self</span>.gamma_density(<span class="va">self</span>.distance_layer, gamma_shape2, gamma_scale2).to(device)</span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combining both densities to create a mixture distribution using logsumexp</span></span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a>        logsumexp_gamma_corr <span class="op">=</span> torch.<span class="bu">max</span>(gamma_density_layer1, gamma_density_layer2)</span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a>        gamma_density_layer <span class="op">=</span> logsumexp_gamma_corr <span class="op">+</span> torch.log(gamma_weight1 <span class="op">*</span> torch.exp(gamma_density_layer1 <span class="op">-</span> logsumexp_gamma_corr) <span class="op">+</span> gamma_weight2 <span class="op">*</span> torch.exp(gamma_density_layer2 <span class="op">-</span> logsumexp_gamma_corr))</span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(gamma_density_layer))</span></span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(gamma_density_layer)))</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise the gamma weights so they sum to 1</span></span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># gamma_density_layer = gamma_density_layer - torch.logsumexp(gamma_density_layer, dim = (1, 2), keepdim = True)</span></span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(gamma_density_layer))</span></span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(gamma_density_layer)))</span></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Von Mises Distributions</span></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate the new bearing from the turning angle</span></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># takes in the bearing from the previous step and adds the turning angle</span></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a>        bearing_new1 <span class="op">=</span> x[:, <span class="dv">6</span>] <span class="op">+</span> bearing[:, <span class="dv">0</span>]</span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing_new1 = 0.0 + bearing[:, 0]</span></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Bearing.shape ', bearing.shape)</span></span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Bearing[:, 0].shape ', bearing[:, 0].shape)</span></span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Bearing[:, 0] ', bearing[:, 0])</span></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the new bearing becomes the mean of the von Mises distribution</span></span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the estimated parameter [x:, 7] is the turning angle of the next step</span></span>
<span id="cb29-237"><a href="#cb29-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># which is always in reference to the input bearing</span></span>
<span id="cb29-238"><a href="#cb29-238" aria-hidden="true" tabindex="-1"></a>        vonmises_mu1 <span class="op">=</span> bearing_new1.unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a>        vonmises_mu1 <span class="op">=</span> vonmises_mu1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a>        vonmises_mu1 <span class="op">=</span> vonmises_mu1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the first von Mises distribution</span></span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa1 <span class="op">=</span> torch.exp(x[:, <span class="dv">7</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa1 <span class="op">=</span> vonmises_kappa1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa1 <span class="op">=</span> vonmises_kappa1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> torch.exp(x[:, <span class="dv">8</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> vonmises_weight1.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> vonmises_weight1.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-250"><a href="#cb29-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-251"><a href="#cb29-251" aria-hidden="true" tabindex="-1"></a>        <span class="co"># vm_mu and weight for the second von Mises distribution</span></span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a>        bearing_new2 <span class="op">=</span> x[:, <span class="dv">9</span>] <span class="op">+</span> bearing[:, <span class="dv">0</span>]</span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing_new2 = torch.pi + bearing[:, 0]</span></span>
<span id="cb29-254"><a href="#cb29-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing_new2 = -torch.pi + bearing[:, 0]</span></span>
<span id="cb29-255"><a href="#cb29-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a>        vonmises_mu2 <span class="op">=</span> bearing_new2.unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a>        vonmises_mu2 <span class="op">=</span> vonmises_mu2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a>        vonmises_mu2 <span class="op">=</span> vonmises_mu2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parameters of the second von Mises distribution</span></span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa2 <span class="op">=</span> torch.exp(x[:, <span class="dv">10</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa2 <span class="op">=</span> vonmises_kappa2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a>        vonmises_kappa2 <span class="op">=</span> vonmises_kappa2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> torch.exp(x[:, <span class="dv">11</span>]).unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> vonmises_weight2.repeat(<span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim, <span class="dv">1</span>)</span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> vonmises_weight2.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-269"><a href="#cb29-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply softmax to the weights</span></span>
<span id="cb29-270"><a href="#cb29-270" aria-hidden="true" tabindex="-1"></a>        vonmises_weights <span class="op">=</span> torch.stack([vonmises_weight1, vonmises_weight2], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a>        vonmises_weights <span class="op">=</span> torch.nn.functional.softmax(vonmises_weights, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a>        vonmises_weight1 <span class="op">=</span> vonmises_weights[<span class="dv">0</span>]</span>
<span id="cb29-273"><a href="#cb29-273" aria-hidden="true" tabindex="-1"></a>        vonmises_weight2 <span class="op">=</span> vonmises_weights[<span class="dv">1</span>]</span>
<span id="cb29-274"><a href="#cb29-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculation of von Mises densities</span></span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a>        vonmises_density_layer1 <span class="op">=</span> <span class="va">self</span>.vonmises_density(<span class="va">self</span>.bearing_layer, vonmises_kappa1, vonmises_mu1).to(device)</span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a>        vonmises_density_layer2 <span class="op">=</span> <span class="va">self</span>.vonmises_density(<span class="va">self</span>.bearing_layer, vonmises_kappa2, vonmises_mu2).to(device)</span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combining both densities to create a mixture distribution using the logsumexp trick</span></span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a>        logsumexp_vm_corr <span class="op">=</span> torch.<span class="bu">max</span>(vonmises_density_layer1, vonmises_density_layer2)</span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a>        vonmises_density_layer <span class="op">=</span> logsumexp_vm_corr <span class="op">+</span> torch.log(vonmises_weight1 <span class="op">*</span> torch.exp(vonmises_density_layer1 <span class="op">-</span> logsumexp_vm_corr) <span class="op">+</span> vonmises_weight2 <span class="op">*</span> torch.exp(vonmises_density_layer2 <span class="op">-</span> logsumexp_vm_corr))</span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(vonmises_density_layer))</span></span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(vonmises_density_layer)))</span></span>
<span id="cb29-284"><a href="#cb29-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-285"><a href="#cb29-285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise so the densities sum to 1 when exponentiated</span></span>
<span id="cb29-286"><a href="#cb29-286" aria-hidden="true" tabindex="-1"></a>        <span class="co"># vonmises_density_layer = vonmises_density_layer - torch.logsumexp(vonmises_density_layer, dim = (1, 2), keepdim = True)</span></span>
<span id="cb29-287"><a href="#cb29-287" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(vonmises_density_layer))</span></span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(vonmises_density_layer)))</span></span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combining the two distributions</span></span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a>        movement_grid <span class="op">=</span> gamma_density_layer <span class="op">+</span> vonmises_density_layer <span class="co"># Gamma and von Mises densities are on the log-scale</span></span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Movement grid ', torch.sum(movement_grid))</span></span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(movement_grid)))</span></span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalise before combining with the habitat predictions</span></span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a>        movement_grid <span class="op">=</span> movement_grid <span class="op">-</span> torch.logsumexp(movement_grid, dim <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Movement grid norm ', torch.sum(movement_grid))</span></span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(torch.sum(torch.exp(movement_grid)))</span></span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> movement_grid</span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Scalar_to_Grid_Block(nn.Module):</span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Scalar_to_Grid_Block, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a>        num_scalars <span class="op">=</span> x.shape[<span class="dv">1</span>]</span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a>        scalar_map <span class="op">=</span> x.view(x.shape[<span class="dv">0</span>], num_scalars, <span class="dv">1</span>, <span class="dv">1</span>).expand(x.shape[<span class="dv">0</span>], num_scalars, <span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim)</span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scalar_map</span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Vector_to_Grid_Block(nn.Module):</span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Vector_to_Grid_Block, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> params.batch_size</span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> params.image_dim</span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>        x_unnorm <span class="op">=</span> x.reshape(x.shape[<span class="dv">0</span>], <span class="va">self</span>.image_dim, <span class="va">self</span>.image_dim)</span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x_unnorm <span class="op">-</span> torch.logsumexp(x_unnorm, dim <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x = x_unnorm/torch.sum(x_unnorm)</span></span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return x</span></span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConvJointModel(nn.Module):</span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params):</span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(ConvJointModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.conv_habitat = Conv2d_block(params)</span></span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.fcn_habitat_all = FCN_block_all_habitat(params)</span></span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.fcn_habitat_nonspatial = FCN_block_nonspatial(params)</span></span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.habitat_grid_output = Vector_to_Grid_Block(params)</span></span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scalar_grid_output <span class="op">=</span> Scalar_to_Grid_Block(params)</span>
<span id="cb29-342"><a href="#cb29-342" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_habitat <span class="op">=</span> Conv2d_block_spatial(params)</span>
<span id="cb29-343"><a href="#cb29-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv_movement <span class="op">=</span> Conv2d_block_toFC(params)</span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fcn_movement_all <span class="op">=</span> FCN_block_all_movement(params)</span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fcn_movement_nonspatial <span class="op">=</span> FCN_block_nonspatial(params)</span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.movement_grid_output <span class="op">=</span> Params_to_Grid_Block(params)</span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> params.device</span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-351"><a href="#cb29-351" aria-hidden="true" tabindex="-1"></a>        spatial_data_x <span class="op">=</span> x[<span class="dv">0</span>]</span>
<span id="cb29-352"><a href="#cb29-352" aria-hidden="true" tabindex="-1"></a>        scalars_to_grid <span class="op">=</span> x[<span class="dv">1</span>]</span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional_data_x = x[2]</span></span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a>        bearing_x <span class="op">=</span> x[<span class="dv">2</span>]</span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a>        <span class="co"># conv_habitat = self.conv_habitat(spatial_data_x)</span></span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a>        <span class="co"># covariates_habitat = self.fcn_habitat_nonspatial(additional_data_x)</span></span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a>        <span class="co"># all_predictors_habitat = torch.cat([conv_habitat, covariates_habitat], dim = 1)</span></span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # print(f"Shape after concatenation: {all_predictors_habitat.shape}")  # Debugging print</span></span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output_habitat = self.fcn_habitat_all(all_predictors_habitat)</span></span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output_habitat = self.habitat_grid_output(output_habitat)</span></span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SCALAR GRIDS</span></span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a>        scalar_grids <span class="op">=</span> <span class="va">self</span>.scalar_grid_output(scalars_to_grid)</span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a>        all_spatial <span class="op">=</span> torch.cat([spatial_data_x, scalar_grids], dim <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after scalar grid: {all_spatial.shape}")  # Debugging print</span></span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># HABITAT SELECTION</span></span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a>        output_habitat <span class="op">=</span> <span class="va">self</span>.conv_habitat(all_spatial)</span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after CNN habitat: {output_habitat.shape}")  # Debugging print</span></span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MOVEMENT</span></span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>        conv_movement <span class="op">=</span> <span class="va">self</span>.conv_movement(all_spatial)</span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after CNN to FC movement: {conv_movement.shape}")  # Debugging print</span></span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a>        <span class="co"># covariates_movement = self.fcn_movement_nonspatial(additional_data_x)</span></span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after fcn_movement_nonspatial: {covariates_movement.shape}")  # Debugging print</span></span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># all_predictors_movement = torch.cat([conv_movement, covariates_movement], dim = 1)</span></span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after torch.cat([conv_movement, covariates_movement], dim = 1): {all_predictors_movement.shape}")  # Debugging print</span></span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a>        output_movement <span class="op">=</span> <span class="va">self</span>.fcn_movement_all(conv_movement)</span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after fcn_movement_all: {output_movement.shape}")  # Debugging print</span></span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a>        output_movement <span class="op">=</span> <span class="va">self</span>.movement_grid_output(output_movement, bearing_x)</span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Shape after CNN movement: {output_movement.shape}")  # Debugging print</span></span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combine the habitat and movement predictions</span></span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> torch.stack((output_habitat, output_movement), dim <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb29-392"><a href="#cb29-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-393"><a href="#cb29-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelParams():</span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dict_params):</span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> dict_params[<span class="st">"image_dim"</span>]</span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pixel_size <span class="op">=</span> dict_params[<span class="st">"pixel_size"</span>]</span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dim_in_nonspatial_to_grid <span class="op">=</span> dict_params[<span class="st">"dim_in_nonspatial_to_grid"</span>]</span>
<span id="cb29-401"><a href="#cb29-401" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_nonspatial <span class="op">=</span> dict_params[<span class="st">"dense_dim_in_nonspatial"</span>]</span>
<span id="cb29-402"><a href="#cb29-402" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> dict_params[<span class="st">"dense_dim_hidden"</span>]</span>
<span id="cb29-403"><a href="#cb29-403" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> dict_params[<span class="st">"dense_dim_out"</span>]</span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_in_all <span class="op">=</span> dict_params[<span class="st">"dense_dim_in_all"</span>]</span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_hidden <span class="op">=</span> dict_params[<span class="st">"dense_dim_hidden"</span>]</span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense_dim_out <span class="op">=</span> dict_params[<span class="st">"dense_dim_out"</span>]</span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> dict_params[<span class="st">"batch_size"</span>]</span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_channels <span class="op">=</span> dict_params[<span class="st">"input_channels"</span>]</span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_channels <span class="op">=</span> dict_params[<span class="st">"output_channels"</span>]</span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size <span class="op">=</span> dict_params[<span class="st">"kernel_size"</span>]</span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride <span class="op">=</span> dict_params[<span class="st">"stride"</span>]</span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_size_mp <span class="op">=</span> dict_params[<span class="st">"kernel_size_mp"</span>]</span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stride_mp <span class="op">=</span> dict_params[<span class="st">"stride_mp"</span>]</span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.padding <span class="op">=</span> dict_params[<span class="st">"padding"</span>]</span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_dim <span class="op">=</span> dict_params[<span class="st">"image_dim"</span>]</span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_movement_params <span class="op">=</span> dict_params[<span class="st">"num_movement_params"</span>]</span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> dict_params[<span class="st">"dropout"</span>]</span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.device <span class="op">=</span> dict_params[<span class="st">"device"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="instantiate-the-model" class="level2">
<h2 class="anchored" data-anchor-id="instantiate-the-model">Instantiate the model</h2>
<div id="cell-35" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>params_dict <span class="op">=</span> {<span class="st">"batch_size"</span>: <span class="dv">32</span>,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">"image_dim"</span>: <span class="dv">101</span>, <span class="co">#number of pixels along the edge of each local patch/image</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"pixel_size"</span>: <span class="dv">25</span>, <span class="co">#number of metres along the edge of a pixel</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dim_in_nonspatial_to_grid"</span>: <span class="dv">4</span>, <span class="co">#the number of scalar predictors that are converted to a grid and appended to the spatial features</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_in_nonspatial"</span>: <span class="dv">4</span>, <span class="co">#change this to however many other scalar predictors you have (bearing, velocity etc)</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_hidden"</span>: <span class="dv">128</span>, <span class="co">#number of nodes in the hidden layers</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_out"</span>: <span class="dv">128</span>, <span class="co">#number of nodes in the output of the fully connected block (FCN)</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dense_dim_in_all"</span>: <span class="dv">2500</span>,<span class="co"># + 128, #number of inputs entering the fully connected block once the nonspatial features have been concatenated to the spatial features</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>               <span class="st">"input_channels"</span>: <span class="dv">4</span> <span class="op">+</span> <span class="dv">4</span>, <span class="co">#number of spatial layers in each image + number of scalar layers that are converted to a grid</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>               <span class="st">"output_channels"</span>: <span class="dv">4</span>, <span class="co">#number of filters to learn</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">"kernel_size"</span>: <span class="dv">3</span>, <span class="co">#the size of the 2D moving windows / kernels that are being learned</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">"stride"</span>: <span class="dv">1</span>, <span class="co">#the stride used when applying the kernel.  This reduces the dimension of the output if set to greater than 1</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>               <span class="st">"kernel_size_mp"</span>: <span class="dv">2</span>, <span class="co">#the size of the kernel that is used in max pooling operations</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>               <span class="st">"stride_mp"</span>: <span class="dv">2</span>, <span class="co">#the stride that is used in max pooling operations</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>               <span class="st">"padding"</span>: <span class="dv">1</span>, <span class="co">#the amount of padding to apply to images prior to applying the 2D convolution</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>               <span class="st">"num_movement_params"</span>: <span class="dv">12</span>, <span class="co">#number of parameters used to parameterise the movement kernel</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">"dropout"</span>: <span class="fl">0.1</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>               <span class="st">"device"</span>: device</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>               }</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> ModelParams(params_dict)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ConvJointModel(params).to(device)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co"># print(model)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-the-model-weights" class="level2">
<h2 class="anchored" data-anchor-id="load-the-model-weights">Load the model weights</h2>
<div id="cell-37" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># date of the trained model checkpoint</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>date <span class="op">=</span> <span class="st">'2024-11-12'</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # load the model weights</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(model.state_dict())</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(<span class="ss">f'model_checkpoints/checkpoint_CNN_global_buffalo</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_TAmix_bearing-rev_adj_hab-covs_grid-only_</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">.pt'</span>, map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>)))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(model.state_dict())</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model.eval()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\for329\AppData\Local\Temp\ipykernel_22308\338321716.py:6: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  model.load_state_dict(torch.load(f'model_checkpoints/checkpoint_CNN_global_buffalo{buffalo_id}_TAmix_bearing-rev_adj_hab-covs_grid-only_{date}.pt', map_location=torch.device('cpu')))</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>&lt;All keys matched successfully&gt;</code></pre>
</div>
</div>
</section>
<section id="setup-validation" class="level2">
<h2 class="anchored" data-anchor-id="setup-validation">Setup validation</h2>
<div id="cell-39" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping from day of the year to month index</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> day_to_month_index(day_of_year):</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the year and the day within that year</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    base_date <span class="op">=</span> datetime(<span class="dv">2018</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> base_date <span class="op">+</span> timedelta(days<span class="op">=</span><span class="bu">int</span>(day_of_year) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    year_diff <span class="op">=</span> date.year <span class="op">-</span> base_date.year</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    month_index <span class="op">=</span> (date.month <span class="op">-</span> <span class="dv">1</span>) <span class="op">+</span> (year_diff <span class="op">*</span> <span class="dv">12</span>)  <span class="co"># month index (0-based, accounting for year change)</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> month_index</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>yday <span class="op">=</span> <span class="dv">370</span> <span class="co"># NOT THE MONTH (due to 0 indexing) - but the index of the of month of the year to extract the appropriate monthly NDVI</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>month_index <span class="op">=</span> day_to_month_index(yday) </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(month_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>12</code></pre>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>window_size <span class="op">=</span> <span class="dv">101</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># starting location of buffalo 2005</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">41969.310875</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="op">-</span><span class="fl">1.435671e+06</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>yday <span class="op">=</span> <span class="dv">280</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>month_index <span class="op">=</span> day_to_month_index(yday)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>ndvi_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(ndvi_global_norm[month_index,:,:], x, y, window_size, raster_transform)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>canopy_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(canopy_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>herby_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(herby_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(origin_x, origin_y)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the subset</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].imshow(ndvi_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'NDVI'</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[0, 0].axis('off')</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].imshow(canopy_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Canopy Cover'</span>)</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[0, 1].axis('off')</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].imshow(herby_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Herbaceous Vegetation'</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[1, 0].axis('off')</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].imshow(slope_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Slope'</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="co"># axs[1, 1].axis('off')</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1628 1136</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>Text(0.5, 1.0, 'Slope')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-23-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="next-step-probability-values" class="level1">
<h1>Next-step probability values</h1>
<div id="cell-42" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test_data = buffalo_df.iloc[0:10]</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> buffalo_df</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(test_data)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty vectors to store the predicted probabilities</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>habitat_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>move_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>next_step_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># start at 1 so the bearing at t - 1 is available</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n):</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  sample_tm1 <span class="op">=</span> test_data.iloc[i<span class="op">-</span><span class="dv">1</span>] <span class="co"># get the step at t - 1 for the bearing of the approaching step</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  sample <span class="op">=</span> test_data.iloc[i]</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current location (x1, y1)</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> sample[<span class="st">'x1_'</span>]</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> sample[<span class="st">'y1_'</span>]</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('x and y are ', x,y)</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  px, py <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x, y)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_x, new_y = raster_transform * (px, py)</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('px and py are ', px, py)</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next step location (x2, y2)</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  x2 <span class="op">=</span> sample[<span class="st">'x2_'</span>]</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  y2 <span class="op">=</span> sample[<span class="st">'y2_'</span>]</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('x2 and y2 are ', x2, y2)</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>  px2, py2 <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x2, y2)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('px2 and py2 are ', px2, py2)</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # THE Y COORDINATE COMES FIRST in the sampled coordinates</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_px = origin_xs[0] + sampled_coordinates[1]</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_py = origin_ys[0] + sampled_coordinates[0]</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new_x, new_y = raster_transform * (new_px, new_py)</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>  d_x <span class="op">=</span> x2 <span class="op">-</span> x</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>  d_y <span class="op">=</span> y2 <span class="op">-</span> y</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('d_x and d_y are ', d_x, d_y)</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># temporal covariates</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>  hour_t2_sin <span class="op">=</span> sample[<span class="st">'hour_t2_sin'</span>]</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>  hour_t2_cos <span class="op">=</span> sample[<span class="st">'hour_t2_cos'</span>]</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>  yday_t2_sin <span class="op">=</span> sample[<span class="st">'yday_t2_sin'</span>]</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>  yday_t2_cos <span class="op">=</span> sample[<span class="st">'yday_t2_cos'</span>]</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(hour_t2_sin, hour_t2_cos, yday_t2_sin, yday_t2_cos)</span></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bearing of PREVIOUS step</span></span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>  bearing <span class="op">=</span> sample_tm1[<span class="st">'bearing'</span>]</span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(bearing)</span></span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yday = sample['yday_t2_base_2018']</span></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>  yday <span class="op">=</span> sample[<span class="st">'yday_t2'</span>]</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(yday)</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>  month_index <span class="op">=</span> day_to_month_index(yday)</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(month_index)</span></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>  ndvi_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(ndvi_global_norm[month_index,:,:], x, y, window_size, raster_transform)</span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>  canopy_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(canopy_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>  herby_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(herby_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>  slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('origin_x and origin_y are ', origin_x, origin_y)</span></span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>  px2_subset <span class="op">=</span> px2 <span class="op">-</span> origin_x</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>  py2_subset <span class="op">=</span> py2 <span class="op">-</span> origin_y</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('delta origin_x and origin_y are ', px2_subset, py2_subset)</span></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('delta origin_x and origin_y are ', int(px2_subset), int(py2_subset))</span></span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>  value <span class="op">=</span> ndvi_subset.detach().cpu().numpy()[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # from the stack of local layers</span></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ndvi_max = 0.8220</span></span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ndvi_min = -0.2772</span></span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # return to natural scale</span></span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># value_natural = value * (ndvi_max - ndvi_min) + ndvi_min</span></span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Value natural scale = ', value_natural)</span></span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot the subset covariates</span></span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_covs, axs_covs = plt.subplots(2, 2, figsize=(10, 10))</span></span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # NDVI</span></span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[0, 0].imshow(ndvi_subset.numpy(), cmap='viridis')</span></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[0, 0].set_title('NDVI')</span></span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_covs.colorbar(axs_covs[0, 0].imshow(ndvi_subset.numpy(), cmap='viridis'), ax=axs_covs[0, 0], shrink=0.7)</span></span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Canopy Cover</span></span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[0, 1].imshow(canopy_subset.numpy(), cmap='viridis')</span></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[0, 1].set_title('Canopy Cover')</span></span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_covs.colorbar(axs_covs[0, 1].imshow(canopy_subset.numpy(), cmap='viridis'), ax=axs_covs[0, 1], shrink=0.7)</span></span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Herbaceous Vegetation</span></span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[1, 0].imshow(herby_subset.numpy(), cmap='viridis')</span></span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[1, 0].set_title('Herbaceous Vegetation')</span></span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_covs.colorbar(axs_covs[1, 0].imshow(herby_subset.numpy(), cmap='viridis'), ax=axs_covs[1, 0], shrink=0.7)</span></span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Slope</span></span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[1, 1].imshow(slope_subset.numpy(), cmap='viridis')</span></span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_covs[1, 1].set_title('Slope')  </span></span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_covs.colorbar(axs_covs[1, 1].imshow(slope_subset.numpy(), cmap='viridis'), ax=axs_covs[1, 1], shrink=0.7)</span></span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack the channels along a new axis; here, 1 is commonly used for channel axis in PyTorch</span></span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>  x1 <span class="op">=</span> torch.stack([ndvi_subset, canopy_subset, herby_subset, slope_subset], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>  x1 <span class="op">=</span> x1.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x1.shape)</span></span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert lists to PyTorch tensors</span></span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a>  hour_t2_sin_tensor <span class="op">=</span> torch.tensor(hour_t2_sin).<span class="bu">float</span>()</span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a>  hour_t2_cos_tensor <span class="op">=</span> torch.tensor(hour_t2_cos).<span class="bu">float</span>()</span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>  yday_t2_sin_tensor <span class="op">=</span> torch.tensor(yday_t2_sin).<span class="bu">float</span>()</span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a>  yday_t2_cos_tensor <span class="op">=</span> torch.tensor(yday_t2_cos).<span class="bu">float</span>()</span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack tensors column-wise</span></span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a>  x2 <span class="op">=</span> torch.stack((hour_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a>                    hour_t2_cos_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a>                    yday_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a>                    yday_t2_cos_tensor.unsqueeze(<span class="dv">0</span>)),  </span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a>                    dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x2)</span></span>
<span id="cb39-130"><a href="#cb39-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(x2.shape)</span></span>
<span id="cb39-131"><a href="#cb39-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put bearing in the correct dimension (batch_size, 1)</span></span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a>  bearing <span class="op">=</span> torch.tensor(bearing).<span class="bu">float</span>().unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(bearing)</span></span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(bearing.shape)</span></span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a>  test <span class="op">=</span> model((x1, x2, bearing))</span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the results of the habitat density as an image</span></span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a>  hab_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">0</span>]</span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a>  hab_density_exp <span class="op">=</span> np.exp(hab_density)</span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(np.sum(hab_density_exp))</span></span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the probability of habitat selection at the location of x2, y2</span></span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a>  habitat_probs[i] <span class="op">=</span> hab_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Habitat probability value = ', habitat_probs[i])</span></span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the mask for x and y coordinates</span></span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a>  x_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a>  y_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb39-151"><a href="#cb39-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-152"><a href="#cb39-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mask out cells on the edges that affect the colour scale</span></span>
<span id="cb39-153"><a href="#cb39-153" aria-hidden="true" tabindex="-1"></a>  x_mask[:, :<span class="dv">3</span>] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb39-154"><a href="#cb39-154" aria-hidden="true" tabindex="-1"></a>  x_mask[:, <span class="dv">98</span>:] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb39-155"><a href="#cb39-155" aria-hidden="true" tabindex="-1"></a>  y_mask[:<span class="dv">3</span>, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb39-156"><a href="#cb39-156" aria-hidden="true" tabindex="-1"></a>  y_mask[<span class="dv">98</span>:, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb39-157"><a href="#cb39-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-158"><a href="#cb39-158" aria-hidden="true" tabindex="-1"></a>  hab_density_mask <span class="op">=</span> hab_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb39-159"><a href="#cb39-159" aria-hidden="true" tabindex="-1"></a>  hab_density_exp_mask <span class="op">=</span> hab_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb39-160"><a href="#cb39-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-161"><a href="#cb39-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the habitat density as an image - in log scale</span></span>
<span id="cb39-162"><a href="#cb39-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(hab_density_mask)</span></span>
<span id="cb39-163"><a href="#cb39-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb39-164"><a href="#cb39-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb39-165"><a href="#cb39-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-166"><a href="#cb39-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the habitat density as an image - as probabilities</span></span>
<span id="cb39-167"><a href="#cb39-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(hab_density_exp_mask)</span></span>
<span id="cb39-168"><a href="#cb39-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb39-169"><a href="#cb39-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb39-170"><a href="#cb39-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-171"><a href="#cb39-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># movement probability</span></span>
<span id="cb39-172"><a href="#cb39-172" aria-hidden="true" tabindex="-1"></a>  move_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">1</span>]</span>
<span id="cb39-173"><a href="#cb39-173" aria-hidden="true" tabindex="-1"></a>  move_density_exp <span class="op">=</span> np.exp(move_density)</span>
<span id="cb39-174"><a href="#cb39-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(np.sum(move_density_exp))</span></span>
<span id="cb39-175"><a href="#cb39-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-176"><a href="#cb39-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the probability of movement at the location of x2, y2</span></span>
<span id="cb39-177"><a href="#cb39-177" aria-hidden="true" tabindex="-1"></a>  move_probs[i] <span class="op">=</span> move_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb39-178"><a href="#cb39-178" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Movement probability value = ', move_probs[i])</span></span>
<span id="cb39-179"><a href="#cb39-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-180"><a href="#cb39-180" aria-hidden="true" tabindex="-1"></a>  move_density_mask <span class="op">=</span> move_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb39-181"><a href="#cb39-181" aria-hidden="true" tabindex="-1"></a>  move_density_exp_mask <span class="op">=</span> move_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb39-182"><a href="#cb39-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-183"><a href="#cb39-183" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the movement density as an image - in log scale</span></span>
<span id="cb39-184"><a href="#cb39-184" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(move_density_mask)</span></span>
<span id="cb39-185"><a href="#cb39-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb39-186"><a href="#cb39-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb39-187"><a href="#cb39-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-188"><a href="#cb39-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plot the results of the movement density as an image - as probabilities</span></span>
<span id="cb39-189"><a href="#cb39-189" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(move_density_exp_mask)</span></span>
<span id="cb39-190"><a href="#cb39-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb39-191"><a href="#cb39-191" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb39-192"><a href="#cb39-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-193"><a href="#cb39-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next step probability</span></span>
<span id="cb39-194"><a href="#cb39-194" aria-hidden="true" tabindex="-1"></a>  step_density <span class="op">=</span> test[<span class="dv">0</span>, :, :, <span class="dv">0</span>] <span class="op">+</span> test[<span class="dv">0</span>, :, :, <span class="dv">1</span>]</span>
<span id="cb39-195"><a href="#cb39-195" aria-hidden="true" tabindex="-1"></a>  step_density <span class="op">=</span> step_density.detach().cpu().numpy()</span>
<span id="cb39-196"><a href="#cb39-196" aria-hidden="true" tabindex="-1"></a>  step_density_exp <span class="op">=</span> np.exp(step_density)</span>
<span id="cb39-197"><a href="#cb39-197" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Sum of step density exp = ', np.sum(step_density_exp))</span></span>
<span id="cb39-198"><a href="#cb39-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-199"><a href="#cb39-199" aria-hidden="true" tabindex="-1"></a>  step_density_exp_norm <span class="op">=</span> step_density_exp <span class="op">/</span> np.<span class="bu">sum</span>(step_density_exp)</span>
<span id="cb39-200"><a href="#cb39-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Sum of step density exp norm = ', np.sum(step_density_exp_norm))</span></span>
<span id="cb39-201"><a href="#cb39-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-202"><a href="#cb39-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb39-203"><a href="#cb39-203" aria-hidden="true" tabindex="-1"></a>  next_step_probs[i] <span class="op">=</span> step_density_exp_norm[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb39-204"><a href="#cb39-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print('Next-step probability value = ', next_step_probs[i])</span></span>
<span id="cb39-205"><a href="#cb39-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-206"><a href="#cb39-206" aria-hidden="true" tabindex="-1"></a>  step_density_mask <span class="op">=</span> step_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb39-207"><a href="#cb39-207" aria-hidden="true" tabindex="-1"></a>  step_density_exp_norm_mask <span class="op">=</span> step_density_exp_norm <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb39-208"><a href="#cb39-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-209"><a href="#cb39-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # results of the habitat and movement densities</span></span>
<span id="cb39-210"><a href="#cb39-210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # log-scale</span></span>
<span id="cb39-211"><a href="#cb39-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(step_density_mask)</span></span>
<span id="cb39-212"><a href="#cb39-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb39-213"><a href="#cb39-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb39-214"><a href="#cb39-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-215"><a href="#cb39-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # exponentiated</span></span>
<span id="cb39-216"><a href="#cb39-216" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.imshow(step_density_exp_mask)</span></span>
<span id="cb39-217"><a href="#cb39-217" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.colorbar()</span></span>
<span id="cb39-218"><a href="#cb39-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.show()</span></span>
<span id="cb39-219"><a href="#cb39-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-220"><a href="#cb39-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-221"><a href="#cb39-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot the outputs</span></span>
<span id="cb39-222"><a href="#cb39-222" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out, axs_out = plt.subplots(2, 2, figsize=(10, 10))</span></span>
<span id="cb39-223"><a href="#cb39-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-224"><a href="#cb39-224" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot NDVI</span></span>
<span id="cb39-225"><a href="#cb39-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im1 = axs_out[0, 0].imshow(ndvi_subset.numpy(), cmap='viridis')</span></span>
<span id="cb39-226"><a href="#cb39-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[0, 0].set_title('NDVI')</span></span>
<span id="cb39-227"><a href="#cb39-227" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im1, ax=axs_out[0, 0], shrink=0.7)</span></span>
<span id="cb39-228"><a href="#cb39-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-229"><a href="#cb39-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # Plot target</span></span>
<span id="cb39-230"><a href="#cb39-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # im2 = axs[0, 1].imshow(labels.detach().cpu().numpy()[0,:,:], cmap='viridis')</span></span>
<span id="cb39-231"><a href="#cb39-231" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[0, 1].set_title('Observed next step')</span></span>
<span id="cb39-232"><a href="#cb39-232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb39-233"><a href="#cb39-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-234"><a href="#cb39-234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # Plot slope</span></span>
<span id="cb39-235"><a href="#cb39-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # im2 = axs[0, 1].imshow(x1.detach().cpu().numpy()[0,12,:,:], cmap='viridis')</span></span>
<span id="cb39-236"><a href="#cb39-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[0, 1].set_title('Slope')</span></span>
<span id="cb39-237"><a href="#cb39-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb39-238"><a href="#cb39-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-239"><a href="#cb39-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Plot habitat selection log-probability</span></span>
<span id="cb39-240"><a href="#cb39-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im2 = axs_out[0, 1].imshow(hab_density_mask, cmap='viridis')</span></span>
<span id="cb39-241"><a href="#cb39-241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[0, 1].set_title('Habitat selection log-probability')</span></span>
<span id="cb39-242"><a href="#cb39-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im2, ax=axs_out[0, 1], shrink=0.7)</span></span>
<span id="cb39-243"><a href="#cb39-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-244"><a href="#cb39-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Movement density log-probability</span></span>
<span id="cb39-245"><a href="#cb39-245" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im3 = axs_out[1, 0].imshow(move_density_mask, cmap='viridis')</span></span>
<span id="cb39-246"><a href="#cb39-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[1, 0].set_title('Movement log-probability')</span></span>
<span id="cb39-247"><a href="#cb39-247" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im3, ax=axs_out[1, 0], shrink=0.7)</span></span>
<span id="cb39-248"><a href="#cb39-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-249"><a href="#cb39-249" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # # Next-step log probability</span></span>
<span id="cb39-250"><a href="#cb39-250" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # im4 = axs[1, 1].imshow(step_density_mask, cmap='viridis')</span></span>
<span id="cb39-251"><a href="#cb39-251" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # axs[1, 1].set_title('Next-step log-probability')</span></span>
<span id="cb39-252"><a href="#cb39-252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # fig.colorbar(im4, ax=axs[1, 1], shrink=0.7)</span></span>
<span id="cb39-253"><a href="#cb39-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-254"><a href="#cb39-254" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # [(int(py2_subset), int(px2_subset))]</span></span>
<span id="cb39-255"><a href="#cb39-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next_step_mask = np.ones_like(hab_density)</span></span>
<span id="cb39-256"><a href="#cb39-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># next_step_mask[int(py2_subset), int(px2_subset)] = -np.inf</span></span>
<span id="cb39-257"><a href="#cb39-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-258"><a href="#cb39-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Next-step probability</span></span>
<span id="cb39-259"><a href="#cb39-259" aria-hidden="true" tabindex="-1"></a>  <span class="co"># im4 = axs_out[1, 1].imshow(step_density_exp_norm_mask * next_step_mask, cmap='viridis')</span></span>
<span id="cb39-260"><a href="#cb39-260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># axs_out[1, 1].set_title('Next-step probability')</span></span>
<span id="cb39-261"><a href="#cb39-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig_out.colorbar(im4, ax=axs_out[1, 1], shrink=0.7)</span></span>
<span id="cb39-262"><a href="#cb39-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-263"><a href="#cb39-263" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # filename_covs = f'outputs/next_step_validation/id{buffalo_id}_yday{yday_t2_integer}_hour{hour_t2_integer}_bearing{bearing_degrees}_next_r{row}_c{column}.png'</span></span>
<span id="cb39-264"><a href="#cb39-264" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.tight_layout()</span></span>
<span id="cb39-265"><a href="#cb39-265" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.savefig(filename_covs, dpi=600, bbox_inches='tight')</span></span>
<span id="cb39-266"><a href="#cb39-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.show()</span></span>
<span id="cb39-267"><a href="#cb39-267" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # plt.close()  # Close the figure to free memory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">KeyboardInterrupt</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg ansi-bold">In[23], line 137</span>
<span class="ansi-green-fg">    133</span>   bearing <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>tensor(bearing)<span style="color:rgb(98,98,98)">.</span>float()<span style="color:rgb(98,98,98)">.</span>unsqueeze(<span style="color:rgb(98,98,98)">0</span>)<span style="color:rgb(98,98,98)">.</span>unsqueeze(<span style="color:rgb(98,98,98)">0</span>)
<span class="ansi-green-fg">    134</span>   <span style="font-style:italic;color:rgb(95,135,135)"># print(bearing)</span>
<span class="ansi-green-fg">    135</span>   <span style="font-style:italic;color:rgb(95,135,135)"># print(bearing.shape)</span>
<span class="ansi-green-fg ansi-bold">--&gt; 137</span>   test <span style="color:rgb(98,98,98)">=</span> model((x1, x2, bearing))
<span class="ansi-green-fg">    139</span> <span style="font-style:italic;color:rgb(95,135,135)"># plot the results of the habitat density as an image</span>
<span class="ansi-green-fg">    140</span>   hab_density <span style="color:rgb(98,98,98)">=</span> test<span style="color:rgb(98,98,98)">.</span>detach()<span style="color:rgb(98,98,98)">.</span>cpu()<span style="color:rgb(98,98,98)">.</span>numpy()[<span style="color:rgb(98,98,98)">0</span>,:,:,<span style="color:rgb(98,98,98)">0</span>]

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1736</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1734</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg">   1735</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1736</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1747</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1742</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1743</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1744</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg">   1745</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1746</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1747</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1749</span> result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1750</span> called_always_called_hooks <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">set</span>()

Cell <span class="ansi-green-fg ansi-bold">In[18], line 370</span>, in <span class="ansi-cyan-fg">ConvJointModel.forward</span><span class="ansi-blue-fg ansi-bold">(self, x)</span>
<span class="ansi-green-fg">    365</span> all_spatial <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>cat([spatial_data_x, scalar_grids], dim <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(98,98,98)">1</span>)
<span class="ansi-green-fg">    366</span> <span style="font-style:italic;color:rgb(95,135,135)"># print(f"Shape after scalar grid: {all_spatial.shape}")  # Debugging print</span>
<span class="ansi-green-fg">    367</span> 
<span class="ansi-green-fg">    368</span> 
<span class="ansi-green-fg">    369</span> <span style="font-style:italic;color:rgb(95,135,135)"># HABITAT SELECTION</span>
<span class="ansi-green-fg ansi-bold">--&gt; 370</span> output_habitat <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>conv_habitat(all_spatial)
<span class="ansi-green-fg">    371</span> <span style="font-style:italic;color:rgb(95,135,135)"># print(f"Shape after CNN habitat: {output_habitat.shape}")  # Debugging print</span>
<span class="ansi-green-fg">    372</span> 
<span class="ansi-green-fg">    373</span> 
<span class="ansi-green-fg">    374</span> <span style="font-style:italic;color:rgb(95,135,135)"># MOVEMENT</span>
<span class="ansi-green-fg">    375</span> conv_movement <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>conv_movement(all_spatial)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1736</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1734</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg">   1735</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1736</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1747</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1742</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1743</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1744</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg">   1745</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1746</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1747</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1749</span> result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1750</span> called_always_called_hooks <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">set</span>()

Cell <span class="ansi-green-fg ansi-bold">In[18], line 52</span>, in <span class="ansi-cyan-fg">Conv2d_block_spatial.forward</span><span class="ansi-blue-fg ansi-bold">(self, x)</span>
<span class="ansi-green-fg">     50</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">     51</span>     <span style="font-style:italic;color:rgb(95,135,135)"># print("Shape before squeeze:", self.conv2d(x).shape)</span>
<span class="ansi-green-fg ansi-bold">---&gt; 52</span>     conv2d_spatial <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>conv2d(x)<span style="color:rgb(98,98,98)">.</span>squeeze(dim <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(98,98,98)">1</span>)
<span class="ansi-green-fg">     53</span>     <span style="font-style:italic;color:rgb(95,135,135)"># print("Shape before logsumexp:", conv2d_spatial.shape)</span>
<span class="ansi-green-fg">     54</span> 
<span class="ansi-green-fg">     55</span>     <span style="font-style:italic;color:rgb(95,135,135)"># normalise before combining with the movement grid</span>
<span class="ansi-green-fg">     56</span>     conv2d_spatial <span style="color:rgb(98,98,98)">=</span> conv2d_spatial <span style="color:rgb(98,98,98)">-</span> torch<span style="color:rgb(98,98,98)">.</span>logsumexp(conv2d_spatial, dim <span style="color:rgb(98,98,98)">=</span> (<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">2</span>), keepdim <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1736</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1734</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg">   1735</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1736</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1747</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1742</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1743</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1744</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg">   1745</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1746</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1747</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1749</span> result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1750</span> called_always_called_hooks <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">set</span>()

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\container.py:250</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    248</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg">    249</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 250</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> module(<span style="color:rgb(0,135,0)">input</span>)
<span class="ansi-green-fg">    251</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1736</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1734</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg">   1735</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1736</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\module.py:1747</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg ansi-bold">(self, *args, **kwargs)</span>
<span class="ansi-green-fg">   1742</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg">   1743</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg">   1744</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg">   1745</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg">   1746</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg ansi-bold">-&gt; 1747</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> forward_call(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1749</span> result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1750</span> called_always_called_hooks <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">set</span>()

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\modules\activation.py:133</span>, in <span class="ansi-cyan-fg">ReLU.forward</span><span class="ansi-blue-fg ansi-bold">(self, input)</span>
<span class="ansi-green-fg">    132</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg ansi-bold">--&gt; 133</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> F<span style="color:rgb(98,98,98)">.</span>relu(<span style="color:rgb(0,135,0)">input</span>, inplace<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>inplace)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\torch\nn\functional.py:1704</span>, in <span class="ansi-cyan-fg">relu</span><span class="ansi-blue-fg ansi-bold">(input, inplace)</span>
<span class="ansi-green-fg">   1702</span>     result <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>relu_(<span style="color:rgb(0,135,0)">input</span>)
<span class="ansi-green-fg">   1703</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1704</span>     result <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>relu(<span style="color:rgb(0,135,0)">input</span>)
<span class="ansi-green-fg">   1705</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> result

<span class="ansi-red-fg ansi-bold">KeyboardInterrupt</span>: </pre>
</div>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(next_step_probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.         0.0030911  0.00460396 ... 0.         0.         0.        ]</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the habitat probs through time as a line graph</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(habitat_probs[habitat_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Habitat Probability'</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the movement probs through time as a line graph</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(move_probs[move_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Movement Probability'</span>)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the next_step probs through time as a line graph</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>plt.plot(np.log(next_step_probs[next_step_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Next-step Probability'</span>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-26-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-26-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Append the probabilities to the dataframe</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'habitat_probs'</span>] <span class="op">=</span> habitat_probs</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'move_probs'</span>] <span class="op">=</span> move_probs</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'next_step_probs'</span>] <span class="op">=</span> next_step_probs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>csv_filename <span class="op">=</span> <span class="ss">f'../outputs/next_step_probs_TAmix_id</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>today_date<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(csv_filename)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_df.to_csv(csv_filename, index=True)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>../outputs/next_step_probs_TAmix_id2387_2024-12-06.csv</code></pre>
</div>
</div>
</section>
<section id="loop-the-validation-over-each-individual" class="level1">
<h1>Loop the validation over each individual</h1>
<div id="cell-48" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select the id to train the model on</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2005</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 10297</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2014</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 6572</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2327</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 8983</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_id = 2387</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># n_samples = 10409</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the path to your CSV file</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>csv_file_path <span class="op">=</span> <span class="ss">f'../buffalo_local_data_id/validation/validation_buffalo_</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_data_df_lag_1hr_n</span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file into a DataFrame</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>buffalo_df <span class="op">=</span> pd.read_csv(csv_file_path)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Lag the values in column 'A' by one index</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Pad the missing value with a specified value, e.g., 0</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing_tm1'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

         ta    cos_ta         x_min         x_max         y_min         y_max  \
0  1.367942  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06   
1 -0.021429  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06   
2  2.994917 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06   
3 -2.799767 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06   
4  0.285377  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06   

   s2_index  points_vect_cent  year_t2  yday_t2_2018_base  
0         7               NaN     2018                206  
1         7               NaN     2018                206  
2         7               NaN     2018                206  
3         7               NaN     2018                206  
4         7               NaN     2018                206  

[5 rows x 35 columns]
             x_            y_                    t_    id           x1_  \
0  41969.310875 -1.435671e+06  2018-07-25T01:04:23Z  2005  41969.310875   
1  41921.521939 -1.435654e+06  2018-07-25T02:04:39Z  2005  41921.521939   
2  41779.439594 -1.435601e+06  2018-07-25T03:04:17Z  2005  41779.439594   
3  41841.203272 -1.435635e+06  2018-07-25T04:04:39Z  2005  41841.203272   
4  41655.463332 -1.435604e+06  2018-07-25T05:04:27Z  2005  41655.463332   

            y1_           x2_           y2_     x2_cent    y2_cent  ...  \
0 -1.435671e+06  41921.521939 -1.435654e+06  -47.788936  16.857110  ...   
1 -1.435654e+06  41779.439594 -1.435601e+06 -142.082345  53.568427  ...   
2 -1.435601e+06  41841.203272 -1.435635e+06   61.763677 -34.322938  ...   
3 -1.435635e+06  41655.463332 -1.435604e+06 -185.739939  31.003534  ...   
4 -1.435604e+06  41618.651923 -1.435608e+06  -36.811409  -4.438037  ...   

     cos_ta         x_min         x_max         y_min         y_max  s2_index  \
0  0.201466  40706.810875  43231.810875 -1.436934e+06 -1.434409e+06         7   
1  0.999770  40659.021939  43184.021939 -1.436917e+06 -1.434392e+06         7   
2 -0.989262  40516.939594  43041.939594 -1.436863e+06 -1.434338e+06         7   
3 -0.942144  40578.703272  43103.703272 -1.436898e+06 -1.434373e+06         7   
4  0.959556  40392.963332  42917.963332 -1.436867e+06 -1.434342e+06         7   

   points_vect_cent  year_t2  yday_t2_2018_base  bearing_tm1  
0               NaN     2018                206     0.000000  
1               NaN     2018                206     2.802478  
2               NaN     2018                206     2.781049  
3               NaN     2018                206    -0.507220  
4               NaN     2018                206     2.976198  

[5 rows x 36 columns]</code></pre>
</div>
</div>
<div id="cell-49" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Specify the directory containing your TIFF files</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> <span class="st">'../buffalo_local_data_id/validation'</span>  <span class="co"># Replace with the actual path to your TIFF files</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Use glob to get a list of all TIFF files matching the pattern</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>csv_files <span class="op">=</span> glob.glob(os.path.join(data_dir, <span class="st">'validation_*.csv'</span>)) </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Found </span><span class="sc">{</span><span class="bu">len</span>(csv_files)<span class="sc">}</span><span class="ss"> CSV files'</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(csv_files))</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># select only 2005</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>csv_files <span class="op">=</span> [csv_files[<span class="dv">0</span>]]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(csv_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 13 CSV files
../buffalo_local_data_id/validation\validation_buffalo_2005_data_df_lag_1hr_n10297.csv
../buffalo_local_data_id/validation\validation_buffalo_2014_data_df_lag_1hr_n6572.csv
../buffalo_local_data_id/validation\validation_buffalo_2018_data_df_lag_1hr_n9440.csv
../buffalo_local_data_id/validation\validation_buffalo_2021_data_df_lag_1hr_n6928.csv
../buffalo_local_data_id/validation\validation_buffalo_2022_data_df_lag_1hr_n9099.csv
../buffalo_local_data_id/validation\validation_buffalo_2024_data_df_lag_1hr_n9531.csv
../buffalo_local_data_id/validation\validation_buffalo_2039_data_df_lag_1hr_n5569.csv
../buffalo_local_data_id/validation\validation_buffalo_2154_data_df_lag_1hr_n10417.csv
../buffalo_local_data_id/validation\validation_buffalo_2158_data_df_lag_1hr_n9700.csv
../buffalo_local_data_id/validation\validation_buffalo_2223_data_df_lag_1hr_n5310.csv
../buffalo_local_data_id/validation\validation_buffalo_2327_data_df_lag_1hr_n8983.csv
../buffalo_local_data_id/validation\validation_buffalo_2387_data_df_lag_1hr_n10409.csv
../buffalo_local_data_id/validation\validation_buffalo_2393_data_df_lag_1hr_n5299.csv
['../buffalo_local_data_id/validation\\validation_buffalo_2005_data_df_lag_1hr_n10297.csv']</code></pre>
</div>
</div>
<div id="cell-50" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(csv_files)):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file into a DataFrame</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    buffalo_df <span class="op">=</span> pd.read_csv(csv_files[j])</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for saving the file</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    buffalo_id <span class="op">=</span> csv_files[j][<span class="dv">55</span>:<span class="dv">59</span>]</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(buffalo_df.head())</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag the values in column 'A' by one index</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pad the missing value with a specified value, e.g., 0</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'bearing_tm1'</span>] <span class="op">=</span> buffalo_df[<span class="st">'bearing_tm1'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    test_data <span class="op">=</span> buffalo_df.iloc[<span class="dv">7000</span>:<span class="dv">7500</span>]</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># test_data = buffalo_df</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(test_data)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create empty vectors to store the predicted probabilities</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    habitat_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    move_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    next_step_probs <span class="op">=</span> np.repeat(<span class="fl">0.</span>, <span class="bu">len</span>(buffalo_df))</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># start at 1 so the bearing at t - 1 is available</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n):</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        sample_tm1 <span class="op">=</span> test_data.iloc[i<span class="op">-</span><span class="dv">1</span>] <span class="co"># get the step at t - 1 for the bearing of the approaching step</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>        sample <span class="op">=</span> test_data.iloc[i]</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># current location (x1, y1)</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> sample[<span class="st">'x1_'</span>]</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> sample[<span class="st">'y1_'</span>]</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('x and y are ', x,y)</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>        px, py <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x, y)</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_x, new_y = raster_transform * (px, py)</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('px and py are ', px, py)</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># next step location (x2, y2)</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> sample[<span class="st">'x2_'</span>]</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>        y2 <span class="op">=</span> sample[<span class="st">'y2_'</span>]</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('x2 and y2 are ', x2, y2)</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>        px2, py2 <span class="op">=</span> <span class="op">~</span>raster_transform <span class="op">*</span> (x2, y2)</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('px2 and py2 are ', px2, py2)</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # THE Y COORDINATE COMES FIRST in the sampled coordinates</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_px = origin_xs[0] + sampled_coordinates[1]</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_py = origin_ys[0] + sampled_coordinates[0]</span></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Convert geographic coordinates to pixel coordinates</span></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_x, new_y = raster_transform * (new_px, new_py)</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>        d_x <span class="op">=</span> x2 <span class="op">-</span> x</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>        d_y <span class="op">=</span> y2 <span class="op">-</span> y</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('d_x and d_y are ', d_x, d_y)</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># temporal covariates</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>        hour_t2_sin <span class="op">=</span> sample[<span class="st">'hour_t2_sin'</span>]</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>        hour_t2_cos <span class="op">=</span> sample[<span class="st">'hour_t2_cos'</span>]</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>        yday_t2_sin <span class="op">=</span> sample[<span class="st">'yday_t2_sin'</span>]</span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>        yday_t2_cos <span class="op">=</span> sample[<span class="st">'yday_t2_cos'</span>]</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(hour_t2_sin, hour_t2_cos, yday_t2_sin, yday_t2_cos)</span></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>        hour_t2_integer <span class="op">=</span> <span class="bu">int</span>(sample[<span class="st">'hour_t2'</span>])</span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bearing of PREVIOUS step</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>        bearing <span class="op">=</span> sample_tm1[<span class="st">'bearing'</span>]</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(bearing)</span></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>        yday <span class="op">=</span> sample[<span class="st">'yday_t2_2018_base'</span>]</span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># yday = sample['yday_t2']</span></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(yday)</span></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>        yday_t2_integer <span class="op">=</span> <span class="bu">int</span>(yday)</span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>        month_index <span class="op">=</span> day_to_month_index(yday)</span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(month_index)</span></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>        ndvi_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(ndvi_global_norm[month_index,:,:], x, y, window_size, raster_transform)</span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>        canopy_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(canopy_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>        herby_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(herby_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>        slope_subset, origin_x, origin_y <span class="op">=</span> subset_raster_with_padding_torch(slope_global_norm, x, y, window_size, raster_transform)</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('origin_x and origin_y are ', origin_x, origin_y)</span></span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>        px2_subset <span class="op">=</span> px2 <span class="op">-</span> origin_x</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>        py2_subset <span class="op">=</span> py2 <span class="op">-</span> origin_y</span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('delta origin_x and origin_y are ', px2_subset, py2_subset)</span></span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('delta origin_x and origin_y are ', int(px2_subset), int(py2_subset))</span></span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> ndvi_subset.detach().cpu().numpy()[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # from the stack of local layers</span></span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ndvi_max = 0.8220</span></span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ndvi_min = -0.2772</span></span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # return to natural scale</span></span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># value_natural = value * (ndvi_max - ndvi_min) + ndvi_min</span></span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Value natural scale = ', value_natural)</span></span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot the subset covariates</span></span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_covs, axs_covs = plt.subplots(2, 2, figsize=(10, 10))</span></span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # NDVI</span></span>
<span id="cb50-114"><a href="#cb50-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[0, 0].imshow(ndvi_subset.numpy(), cmap='viridis')</span></span>
<span id="cb50-115"><a href="#cb50-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[0, 0].set_title('NDVI')</span></span>
<span id="cb50-116"><a href="#cb50-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_covs.colorbar(axs_covs[0, 0].imshow(ndvi_subset.numpy(), cmap='viridis'), ax=axs_covs[0, 0], shrink=0.7)</span></span>
<span id="cb50-117"><a href="#cb50-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Canopy Cover</span></span>
<span id="cb50-118"><a href="#cb50-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[0, 1].imshow(canopy_subset.numpy(), cmap='viridis')</span></span>
<span id="cb50-119"><a href="#cb50-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[0, 1].set_title('Canopy Cover')</span></span>
<span id="cb50-120"><a href="#cb50-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_covs.colorbar(axs_covs[0, 1].imshow(canopy_subset.numpy(), cmap='viridis'), ax=axs_covs[0, 1], shrink=0.7)</span></span>
<span id="cb50-121"><a href="#cb50-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Herbaceous Vegetation</span></span>
<span id="cb50-122"><a href="#cb50-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[1, 0].imshow(herby_subset.numpy(), cmap='viridis')</span></span>
<span id="cb50-123"><a href="#cb50-123" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[1, 0].set_title('Herbaceous Vegetation')</span></span>
<span id="cb50-124"><a href="#cb50-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_covs.colorbar(axs_covs[1, 0].imshow(herby_subset.numpy(), cmap='viridis'), ax=axs_covs[1, 0], shrink=0.7)</span></span>
<span id="cb50-125"><a href="#cb50-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Slope</span></span>
<span id="cb50-126"><a href="#cb50-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[1, 1].imshow(slope_subset.numpy(), cmap='viridis')</span></span>
<span id="cb50-127"><a href="#cb50-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_covs[1, 1].set_title('Slope')  </span></span>
<span id="cb50-128"><a href="#cb50-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_covs.colorbar(axs_covs[1, 1].imshow(slope_subset.numpy(), cmap='viridis'), ax=axs_covs[1, 1], shrink=0.7)</span></span>
<span id="cb50-129"><a href="#cb50-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-130"><a href="#cb50-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-131"><a href="#cb50-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack the channels along a new axis; here, 1 is commonly used for channel axis in PyTorch</span></span>
<span id="cb50-132"><a href="#cb50-132" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> torch.stack([ndvi_subset, canopy_subset, herby_subset, slope_subset], dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb50-133"><a href="#cb50-133" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> x1.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb50-134"><a href="#cb50-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x1.shape)</span></span>
<span id="cb50-135"><a href="#cb50-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-136"><a href="#cb50-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert lists to PyTorch tensors</span></span>
<span id="cb50-137"><a href="#cb50-137" aria-hidden="true" tabindex="-1"></a>        hour_t2_sin_tensor <span class="op">=</span> torch.tensor(hour_t2_sin).<span class="bu">float</span>()</span>
<span id="cb50-138"><a href="#cb50-138" aria-hidden="true" tabindex="-1"></a>        hour_t2_cos_tensor <span class="op">=</span> torch.tensor(hour_t2_cos).<span class="bu">float</span>()</span>
<span id="cb50-139"><a href="#cb50-139" aria-hidden="true" tabindex="-1"></a>        yday_t2_sin_tensor <span class="op">=</span> torch.tensor(yday_t2_sin).<span class="bu">float</span>()</span>
<span id="cb50-140"><a href="#cb50-140" aria-hidden="true" tabindex="-1"></a>        yday_t2_cos_tensor <span class="op">=</span> torch.tensor(yday_t2_cos).<span class="bu">float</span>()</span>
<span id="cb50-141"><a href="#cb50-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-142"><a href="#cb50-142" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack tensors column-wise</span></span>
<span id="cb50-143"><a href="#cb50-143" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> torch.stack((hour_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb50-144"><a href="#cb50-144" aria-hidden="true" tabindex="-1"></a>                            hour_t2_cos_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb50-145"><a href="#cb50-145" aria-hidden="true" tabindex="-1"></a>                            yday_t2_sin_tensor.unsqueeze(<span class="dv">0</span>), </span>
<span id="cb50-146"><a href="#cb50-146" aria-hidden="true" tabindex="-1"></a>                            yday_t2_cos_tensor.unsqueeze(<span class="dv">0</span>)),  </span>
<span id="cb50-147"><a href="#cb50-147" aria-hidden="true" tabindex="-1"></a>                            dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-148"><a href="#cb50-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x2)</span></span>
<span id="cb50-149"><a href="#cb50-149" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(x2.shape)</span></span>
<span id="cb50-150"><a href="#cb50-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-151"><a href="#cb50-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># put bearing in the correct dimension (batch_size, 1)</span></span>
<span id="cb50-152"><a href="#cb50-152" aria-hidden="true" tabindex="-1"></a>        bearing <span class="op">=</span> torch.tensor(bearing).<span class="bu">float</span>().unsqueeze(<span class="dv">0</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb50-153"><a href="#cb50-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(bearing)</span></span>
<span id="cb50-154"><a href="#cb50-154" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(bearing.shape)</span></span>
<span id="cb50-155"><a href="#cb50-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-156"><a href="#cb50-156" aria-hidden="true" tabindex="-1"></a>        test <span class="op">=</span> model((x1, x2, bearing))</span>
<span id="cb50-157"><a href="#cb50-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-158"><a href="#cb50-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plot the results of the habitat density as an image</span></span>
<span id="cb50-159"><a href="#cb50-159" aria-hidden="true" tabindex="-1"></a>        hab_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">0</span>]</span>
<span id="cb50-160"><a href="#cb50-160" aria-hidden="true" tabindex="-1"></a>        hab_density_exp <span class="op">=</span> np.exp(hab_density)</span>
<span id="cb50-161"><a href="#cb50-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(np.sum(hab_density_exp))</span></span>
<span id="cb50-162"><a href="#cb50-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-163"><a href="#cb50-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the probability of habitat selection at the location of x2, y2</span></span>
<span id="cb50-164"><a href="#cb50-164" aria-hidden="true" tabindex="-1"></a>        habitat_probs[i] <span class="op">=</span> hab_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb50-165"><a href="#cb50-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Habitat probability value = ', habitat_probs[i])</span></span>
<span id="cb50-166"><a href="#cb50-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-167"><a href="#cb50-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the mask for x and y coordinates</span></span>
<span id="cb50-168"><a href="#cb50-168" aria-hidden="true" tabindex="-1"></a>        x_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb50-169"><a href="#cb50-169" aria-hidden="true" tabindex="-1"></a>        y_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb50-170"><a href="#cb50-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-171"><a href="#cb50-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mask out cells on the edges that affect the colour scale</span></span>
<span id="cb50-172"><a href="#cb50-172" aria-hidden="true" tabindex="-1"></a>        x_mask[:, :<span class="dv">3</span>] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb50-173"><a href="#cb50-173" aria-hidden="true" tabindex="-1"></a>        x_mask[:, <span class="dv">98</span>:] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb50-174"><a href="#cb50-174" aria-hidden="true" tabindex="-1"></a>        y_mask[:<span class="dv">3</span>, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb50-175"><a href="#cb50-175" aria-hidden="true" tabindex="-1"></a>        y_mask[<span class="dv">98</span>:, :] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb50-176"><a href="#cb50-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-177"><a href="#cb50-177" aria-hidden="true" tabindex="-1"></a>        hab_density_mask <span class="op">=</span> hab_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb50-178"><a href="#cb50-178" aria-hidden="true" tabindex="-1"></a>        hab_density_exp_mask <span class="op">=</span> hab_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb50-179"><a href="#cb50-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-180"><a href="#cb50-180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the habitat density as an image - in log scale</span></span>
<span id="cb50-181"><a href="#cb50-181" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(hab_density_mask)</span></span>
<span id="cb50-182"><a href="#cb50-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb50-183"><a href="#cb50-183" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb50-184"><a href="#cb50-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-185"><a href="#cb50-185" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plot the results of the habitat density as an image - as probabilities</span></span>
<span id="cb50-186"><a href="#cb50-186" aria-hidden="true" tabindex="-1"></a>        plt.imshow(hab_density_exp_mask <span class="op">*</span> next_step_mask)</span>
<span id="cb50-187"><a href="#cb50-187" aria-hidden="true" tabindex="-1"></a>        plt.colorbar()</span>
<span id="cb50-188"><a href="#cb50-188" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb50-189"><a href="#cb50-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-190"><a href="#cb50-190" aria-hidden="true" tabindex="-1"></a>        <span class="co"># movement probability</span></span>
<span id="cb50-191"><a href="#cb50-191" aria-hidden="true" tabindex="-1"></a>        move_density <span class="op">=</span> test.detach().cpu().numpy()[<span class="dv">0</span>,:,:,<span class="dv">1</span>]</span>
<span id="cb50-192"><a href="#cb50-192" aria-hidden="true" tabindex="-1"></a>        move_density_exp <span class="op">=</span> np.exp(move_density)</span>
<span id="cb50-193"><a href="#cb50-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(np.sum(move_density_exp))</span></span>
<span id="cb50-194"><a href="#cb50-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-195"><a href="#cb50-195" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the probability of movement at the location of x2, y2</span></span>
<span id="cb50-196"><a href="#cb50-196" aria-hidden="true" tabindex="-1"></a>        move_probs[i] <span class="op">=</span> move_density_exp[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb50-197"><a href="#cb50-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Movement probability value = ', move_probs[i])</span></span>
<span id="cb50-198"><a href="#cb50-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-199"><a href="#cb50-199" aria-hidden="true" tabindex="-1"></a>        move_density_mask <span class="op">=</span> move_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb50-200"><a href="#cb50-200" aria-hidden="true" tabindex="-1"></a>        move_density_exp_mask <span class="op">=</span> move_density_exp <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb50-201"><a href="#cb50-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-202"><a href="#cb50-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the movement density as an image - in log scale</span></span>
<span id="cb50-203"><a href="#cb50-203" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(move_density_mask)</span></span>
<span id="cb50-204"><a href="#cb50-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb50-205"><a href="#cb50-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb50-206"><a href="#cb50-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-207"><a href="#cb50-207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # plot the results of the movement density as an image - as probabilities</span></span>
<span id="cb50-208"><a href="#cb50-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(move_density_exp_mask)</span></span>
<span id="cb50-209"><a href="#cb50-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb50-210"><a href="#cb50-210" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb50-211"><a href="#cb50-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-212"><a href="#cb50-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># next step probability</span></span>
<span id="cb50-213"><a href="#cb50-213" aria-hidden="true" tabindex="-1"></a>        step_density <span class="op">=</span> test[<span class="dv">0</span>, :, :, <span class="dv">0</span>] <span class="op">+</span> test[<span class="dv">0</span>, :, :, <span class="dv">1</span>]</span>
<span id="cb50-214"><a href="#cb50-214" aria-hidden="true" tabindex="-1"></a>        step_density <span class="op">=</span> step_density.detach().cpu().numpy()</span>
<span id="cb50-215"><a href="#cb50-215" aria-hidden="true" tabindex="-1"></a>        step_density_exp <span class="op">=</span> np.exp(step_density)</span>
<span id="cb50-216"><a href="#cb50-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Sum of step density exp = ', np.sum(step_density_exp))</span></span>
<span id="cb50-217"><a href="#cb50-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-218"><a href="#cb50-218" aria-hidden="true" tabindex="-1"></a>        step_density_exp_norm <span class="op">=</span> step_density_exp <span class="op">/</span> np.<span class="bu">sum</span>(step_density_exp)</span>
<span id="cb50-219"><a href="#cb50-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Sum of step density exp norm = ', np.sum(step_density_exp_norm))</span></span>
<span id="cb50-220"><a href="#cb50-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-221"><a href="#cb50-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the value of the covariates at the location of x2, y2</span></span>
<span id="cb50-222"><a href="#cb50-222" aria-hidden="true" tabindex="-1"></a>        next_step_probs[i] <span class="op">=</span> step_density_exp_norm[(<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset))]</span>
<span id="cb50-223"><a href="#cb50-223" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('Next-step probability value = ', next_step_probs[i])</span></span>
<span id="cb50-224"><a href="#cb50-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-225"><a href="#cb50-225" aria-hidden="true" tabindex="-1"></a>        step_density_mask <span class="op">=</span> step_density <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb50-226"><a href="#cb50-226" aria-hidden="true" tabindex="-1"></a>        step_density_exp_norm_mask <span class="op">=</span> step_density_exp_norm <span class="op">*</span> x_mask <span class="op">*</span> y_mask</span>
<span id="cb50-227"><a href="#cb50-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-228"><a href="#cb50-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # results of the habitat and movement densities</span></span>
<span id="cb50-229"><a href="#cb50-229" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # log-scale</span></span>
<span id="cb50-230"><a href="#cb50-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(step_density_mask)</span></span>
<span id="cb50-231"><a href="#cb50-231" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb50-232"><a href="#cb50-232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb50-233"><a href="#cb50-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-234"><a href="#cb50-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # exponentiated</span></span>
<span id="cb50-235"><a href="#cb50-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.imshow(step_density_exp_mask)</span></span>
<span id="cb50-236"><a href="#cb50-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.colorbar()</span></span>
<span id="cb50-237"><a href="#cb50-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb50-238"><a href="#cb50-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-239"><a href="#cb50-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [(int(py2_subset), int(px2_subset))]</span></span>
<span id="cb50-240"><a href="#cb50-240" aria-hidden="true" tabindex="-1"></a>        next_step_mask <span class="op">=</span> np.ones_like(hab_density)</span>
<span id="cb50-241"><a href="#cb50-241" aria-hidden="true" tabindex="-1"></a>        next_step_mask[<span class="bu">int</span>(py2_subset), <span class="bu">int</span>(px2_subset)] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb50-242"><a href="#cb50-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-243"><a href="#cb50-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-244"><a href="#cb50-244" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot the outputs</span></span>
<span id="cb50-245"><a href="#cb50-245" aria-hidden="true" tabindex="-1"></a>        fig_out, axs_out <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb50-246"><a href="#cb50-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-247"><a href="#cb50-247" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot NDVI</span></span>
<span id="cb50-248"><a href="#cb50-248" aria-hidden="true" tabindex="-1"></a>        im1 <span class="op">=</span> axs_out[<span class="dv">0</span>, <span class="dv">0</span>].imshow(ndvi_subset.numpy(), cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb50-249"><a href="#cb50-249" aria-hidden="true" tabindex="-1"></a>        axs_out[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'NDVI'</span>)</span>
<span id="cb50-250"><a href="#cb50-250" aria-hidden="true" tabindex="-1"></a>        fig_out.colorbar(im1, ax<span class="op">=</span>axs_out[<span class="dv">0</span>, <span class="dv">0</span>], shrink<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb50-251"><a href="#cb50-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-252"><a href="#cb50-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot target</span></span>
<span id="cb50-253"><a href="#cb50-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im2 = axs[0, 1].imshow(labels.detach().cpu().numpy()[0,:,:], cmap='viridis')</span></span>
<span id="cb50-254"><a href="#cb50-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs[0, 1].set_title('Observed next step')</span></span>
<span id="cb50-255"><a href="#cb50-255" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb50-256"><a href="#cb50-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-257"><a href="#cb50-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot slope</span></span>
<span id="cb50-258"><a href="#cb50-258" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im2 = axs[0, 1].imshow(x1.detach().cpu().numpy()[0,12,:,:], cmap='viridis')</span></span>
<span id="cb50-259"><a href="#cb50-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs[0, 1].set_title('Slope')</span></span>
<span id="cb50-260"><a href="#cb50-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig.colorbar(im2, ax=axs[0, 1], shrink=0.7)</span></span>
<span id="cb50-261"><a href="#cb50-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-262"><a href="#cb50-262" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Plot habitat selection log-probability</span></span>
<span id="cb50-263"><a href="#cb50-263" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im2 = axs_out[0, 1].imshow(hab_density_mask * next_step_mask, cmap='viridis')</span></span>
<span id="cb50-264"><a href="#cb50-264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs_out[0, 1].set_title('Habitat selection log-probability')</span></span>
<span id="cb50-265"><a href="#cb50-265" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig_out.colorbar(im2, ax=axs_out[0, 1], shrink=0.7)</span></span>
<span id="cb50-266"><a href="#cb50-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-267"><a href="#cb50-267" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot habitat selection probability</span></span>
<span id="cb50-268"><a href="#cb50-268" aria-hidden="true" tabindex="-1"></a>        im2 <span class="op">=</span> axs_out[<span class="dv">0</span>, <span class="dv">1</span>].imshow(hab_density_exp_mask <span class="op">*</span> next_step_mask, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb50-269"><a href="#cb50-269" aria-hidden="true" tabindex="-1"></a>        axs_out[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Habitat selection log-probability'</span>)</span>
<span id="cb50-270"><a href="#cb50-270" aria-hidden="true" tabindex="-1"></a>        fig_out.colorbar(im2, ax<span class="op">=</span>axs_out[<span class="dv">0</span>, <span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb50-271"><a href="#cb50-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-272"><a href="#cb50-272" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Movement density log-probability</span></span>
<span id="cb50-273"><a href="#cb50-273" aria-hidden="true" tabindex="-1"></a>        im3 <span class="op">=</span> axs_out[<span class="dv">1</span>, <span class="dv">0</span>].imshow(move_density_mask <span class="op">*</span> next_step_mask, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb50-274"><a href="#cb50-274" aria-hidden="true" tabindex="-1"></a>        axs_out[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Movement log-probability'</span>)</span>
<span id="cb50-275"><a href="#cb50-275" aria-hidden="true" tabindex="-1"></a>        fig_out.colorbar(im3, ax<span class="op">=</span>axs_out[<span class="dv">1</span>, <span class="dv">0</span>], shrink<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb50-276"><a href="#cb50-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-277"><a href="#cb50-277" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Next-step log probability</span></span>
<span id="cb50-278"><a href="#cb50-278" aria-hidden="true" tabindex="-1"></a>        <span class="co"># im4 = axs[1, 1].imshow(step_density_mask, cmap='viridis')</span></span>
<span id="cb50-279"><a href="#cb50-279" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axs[1, 1].set_title('Next-step log-probability')</span></span>
<span id="cb50-280"><a href="#cb50-280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fig.colorbar(im4, ax=axs[1, 1], shrink=0.7)</span></span>
<span id="cb50-281"><a href="#cb50-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-282"><a href="#cb50-282" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-283"><a href="#cb50-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-284"><a href="#cb50-284" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Next-step probability</span></span>
<span id="cb50-285"><a href="#cb50-285" aria-hidden="true" tabindex="-1"></a>        im4 <span class="op">=</span> axs_out[<span class="dv">1</span>, <span class="dv">1</span>].imshow(step_density_exp_norm_mask <span class="op">*</span> next_step_mask, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span>
<span id="cb50-286"><a href="#cb50-286" aria-hidden="true" tabindex="-1"></a>        axs_out[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Next-step probability'</span>)</span>
<span id="cb50-287"><a href="#cb50-287" aria-hidden="true" tabindex="-1"></a>        fig_out.colorbar(im4, ax<span class="op">=</span>axs_out[<span class="dv">1</span>, <span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb50-288"><a href="#cb50-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-289"><a href="#cb50-289" aria-hidden="true" tabindex="-1"></a>        filename_covs <span class="op">=</span> <span class="ss">f'outputs/next_step_validation/id</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_yday</span><span class="sc">{</span>yday_t2_integer<span class="sc">}</span><span class="ss">_hour</span><span class="sc">{</span>hour_t2_integer<span class="sc">}</span><span class="ss">.png'</span></span>
<span id="cb50-290"><a href="#cb50-290" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb50-291"><a href="#cb50-291" aria-hidden="true" tabindex="-1"></a>        plt.savefig(filename_covs, dpi<span class="op">=</span><span class="dv">600</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb50-292"><a href="#cb50-292" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.show()</span></span>
<span id="cb50-293"><a href="#cb50-293" aria-hidden="true" tabindex="-1"></a>        plt.close()  <span class="co"># Close the figure to free memory</span></span>
<span id="cb50-294"><a href="#cb50-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-295"><a href="#cb50-295" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-296"><a href="#cb50-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the habitat probs through time as a line graph</span></span>
<span id="cb50-297"><a href="#cb50-297" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.log(habitat_probs[habitat_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb50-298"><a href="#cb50-298" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb50-299"><a href="#cb50-299" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb50-300"><a href="#cb50-300" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Habitat Probability'</span>)</span>
<span id="cb50-301"><a href="#cb50-301" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb50-302"><a href="#cb50-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-303"><a href="#cb50-303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the movement probs through time as a line graph</span></span>
<span id="cb50-304"><a href="#cb50-304" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.log(move_probs[move_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb50-305"><a href="#cb50-305" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb50-306"><a href="#cb50-306" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb50-307"><a href="#cb50-307" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Movement Probability'</span>)</span>
<span id="cb50-308"><a href="#cb50-308" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb50-309"><a href="#cb50-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-310"><a href="#cb50-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the next_step probs through time as a line graph</span></span>
<span id="cb50-311"><a href="#cb50-311" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.log(next_step_probs[next_step_probs<span class="op">&gt;</span><span class="dv">0</span>]))</span>
<span id="cb50-312"><a href="#cb50-312" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb50-313"><a href="#cb50-313" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb50-314"><a href="#cb50-314" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Next-step Probability'</span>)</span>
<span id="cb50-315"><a href="#cb50-315" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb50-316"><a href="#cb50-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-317"><a href="#cb50-317" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the probabilities to the dataframe</span></span>
<span id="cb50-318"><a href="#cb50-318" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'habitat_probs'</span>] <span class="op">=</span> habitat_probs</span>
<span id="cb50-319"><a href="#cb50-319" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'move_probs'</span>] <span class="op">=</span> move_probs</span>
<span id="cb50-320"><a href="#cb50-320" aria-hidden="true" tabindex="-1"></a>    buffalo_df[<span class="st">'next_step_probs'</span>] <span class="op">=</span> next_step_probs</span>
<span id="cb50-321"><a href="#cb50-321" aria-hidden="true" tabindex="-1"></a>    csv_filename <span class="op">=</span> <span class="ss">f'../outputs/next_step_probs_TAmix_id</span><span class="sc">{</span>buffalo_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>today_date<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb50-322"><a href="#cb50-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-323"><a href="#cb50-323" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(csv_filename)</span>
<span id="cb50-324"><a href="#cb50-324" aria-hidden="true" tabindex="-1"></a>    <span class="co"># buffalo_df.to_csv(csv_filename, index=True)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-13.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-15.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">KeyboardInterrupt</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg ansi-bold">In[34], line 290</span>
<span class="ansi-green-fg">    287</span> fig_out<span style="color:rgb(98,98,98)">.</span>colorbar(im4, ax<span style="color:rgb(98,98,98)">=</span>axs_out[<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">1</span>], shrink<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0.7</span>)
<span class="ansi-green-fg">    289</span> filename_covs <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">outputs/next_step_validation/id</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>buffalo_id<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">_yday</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>yday_t2_integer<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">_hour</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hour_t2_integer<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.png</span><span style="color:rgb(175,0,0)">'</span>
<span class="ansi-green-fg ansi-bold">--&gt; 290</span> plt<span style="color:rgb(98,98,98)">.</span>tight_layout()
<span class="ansi-green-fg">    291</span> plt<span style="color:rgb(98,98,98)">.</span>savefig(filename_covs, dpi<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">600</span>, bbox_inches<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">tight</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg">    292</span> <span style="font-style:italic;color:rgb(95,135,135)"># plt.show()</span>

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\pyplot.py:2801</span>, in <span class="ansi-cyan-fg">tight_layout</span><span class="ansi-blue-fg ansi-bold">(pad, h_pad, w_pad, rect)</span>
<span class="ansi-green-fg">   2793</span> <span style="color:rgb(175,0,255)">@_copy_docstring_and_deprecators</span>(Figure<span style="color:rgb(98,98,98)">.</span>tight_layout)
<span class="ansi-green-fg">   2794</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">tight_layout</span>(
<span class="ansi-green-fg">   2795</span>     <span style="color:rgb(98,98,98)">*</span>,
<span class="ansi-green-fg ansi-bold">   (...)</span>
<span class="ansi-green-fg">   2799</span>     rect: <span style="color:rgb(0,135,0)">tuple</span>[<span style="color:rgb(0,135,0)">float</span>, <span style="color:rgb(0,135,0)">float</span>, <span style="color:rgb(0,135,0)">float</span>, <span style="color:rgb(0,135,0)">float</span>] <span style="color:rgb(98,98,98)">|</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg">   2800</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 2801</span>     gcf()<span style="color:rgb(98,98,98)">.</span>tight_layout(pad<span style="color:rgb(98,98,98)">=</span>pad, h_pad<span style="color:rgb(98,98,98)">=</span>h_pad, w_pad<span style="color:rgb(98,98,98)">=</span>w_pad, rect<span style="color:rgb(98,98,98)">=</span>rect)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\figure.py:3545</span>, in <span class="ansi-cyan-fg">Figure.tight_layout</span><span class="ansi-blue-fg ansi-bold">(self, pad, h_pad, w_pad, rect)</span>
<span class="ansi-green-fg">   3543</span> previous_engine <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>get_layout_engine()
<span class="ansi-green-fg">   3544</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>set_layout_engine(engine)
<span class="ansi-green-fg ansi-bold">-&gt; 3545</span> engine<span style="color:rgb(98,98,98)">.</span>execute(<span style="color:rgb(0,135,0)">self</span>)
<span class="ansi-green-fg">   3546</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> previous_engine <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">isinstance</span>(
<span class="ansi-green-fg">   3547</span>     previous_engine, (TightLayoutEngine, PlaceHolderLayoutEngine)
<span class="ansi-green-fg">   3548</span> ):
<span class="ansi-green-fg">   3549</span>     _api<span style="color:rgb(98,98,98)">.</span>warn_external(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">The figure layout has changed to tight</span><span style="color:rgb(175,0,0)">'</span>)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\layout_engine.py:183</span>, in <span class="ansi-cyan-fg">TightLayoutEngine.execute</span><span class="ansi-blue-fg ansi-bold">(self, fig)</span>
<span class="ansi-green-fg">    181</span> renderer <span style="color:rgb(98,98,98)">=</span> fig<span style="color:rgb(98,98,98)">.</span>_get_renderer()
<span class="ansi-green-fg">    182</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> <span style="color:rgb(0,135,0)">getattr</span>(renderer, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">_draw_disabled</span><span style="color:rgb(175,0,0)">"</span>, nullcontext)():
<span class="ansi-green-fg ansi-bold">--&gt; 183</span>     kwargs <span style="color:rgb(98,98,98)">=</span> get_tight_layout_figure(
<span class="ansi-green-fg">    184</span>         fig, fig<span style="color:rgb(98,98,98)">.</span>axes, get_subplotspec_list(fig<span style="color:rgb(98,98,98)">.</span>axes), renderer,
<span class="ansi-green-fg">    185</span>         pad<span style="color:rgb(98,98,98)">=</span>info[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">pad</span><span style="color:rgb(175,0,0)">'</span>], h_pad<span style="color:rgb(98,98,98)">=</span>info[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">h_pad</span><span style="color:rgb(175,0,0)">'</span>], w_pad<span style="color:rgb(98,98,98)">=</span>info[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">w_pad</span><span style="color:rgb(175,0,0)">'</span>],
<span class="ansi-green-fg">    186</span>         rect<span style="color:rgb(98,98,98)">=</span>info[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">rect</span><span style="color:rgb(175,0,0)">'</span>])
<span class="ansi-green-fg">    187</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> kwargs:
<span class="ansi-green-fg">    188</span>     fig<span style="color:rgb(98,98,98)">.</span>subplots_adjust(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\_tight_layout.py:266</span>, in <span class="ansi-cyan-fg">get_tight_layout_figure</span><span class="ansi-blue-fg ansi-bold">(fig, axes_list, subplotspec_list, renderer, pad, h_pad, w_pad, rect)</span>
<span class="ansi-green-fg">    261</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> {}
<span class="ansi-green-fg">    262</span>     span_pairs<span style="color:rgb(98,98,98)">.</span>append((
<span class="ansi-green-fg">    263</span>         <span style="color:rgb(0,135,0)">slice</span>(ss<span style="color:rgb(98,98,98)">.</span>rowspan<span style="color:rgb(98,98,98)">.</span>start <span style="color:rgb(98,98,98)">*</span> div_row, ss<span style="color:rgb(98,98,98)">.</span>rowspan<span style="color:rgb(98,98,98)">.</span>stop <span style="color:rgb(98,98,98)">*</span> div_row),
<span class="ansi-green-fg">    264</span>         <span style="color:rgb(0,135,0)">slice</span>(ss<span style="color:rgb(98,98,98)">.</span>colspan<span style="color:rgb(98,98,98)">.</span>start <span style="color:rgb(98,98,98)">*</span> div_col, ss<span style="color:rgb(98,98,98)">.</span>colspan<span style="color:rgb(98,98,98)">.</span>stop <span style="color:rgb(98,98,98)">*</span> div_col)))
<span class="ansi-green-fg ansi-bold">--&gt; 266</span> kwargs <span style="color:rgb(98,98,98)">=</span> _auto_adjust_subplotpars(fig, renderer,
<span class="ansi-green-fg">    267</span>                                   shape<span style="color:rgb(98,98,98)">=</span>(max_nrows, max_ncols),
<span class="ansi-green-fg">    268</span>                                   span_pairs<span style="color:rgb(98,98,98)">=</span>span_pairs,
<span class="ansi-green-fg">    269</span>                                   subplot_list<span style="color:rgb(98,98,98)">=</span>subplot_list,
<span class="ansi-green-fg">    270</span>                                   ax_bbox_list<span style="color:rgb(98,98,98)">=</span>ax_bbox_list,
<span class="ansi-green-fg">    271</span>                                   pad<span style="color:rgb(98,98,98)">=</span>pad, h_pad<span style="color:rgb(98,98,98)">=</span>h_pad, w_pad<span style="color:rgb(98,98,98)">=</span>w_pad)
<span class="ansi-green-fg">    273</span> <span style="font-style:italic;color:rgb(95,135,135)"># kwargs can be none if tight_layout fails...</span>
<span class="ansi-green-fg">    274</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> rect <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> kwargs <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">    275</span>     <span style="font-style:italic;color:rgb(95,135,135)"># if rect is given, the whole subplots area (including</span>
<span class="ansi-green-fg">    276</span>     <span style="font-style:italic;color:rgb(95,135,135)"># labels) will fit into the rect instead of the</span>
<span class="ansi-green-fg ansi-bold">   (...)</span>
<span class="ansi-green-fg">    280</span>     <span style="font-style:italic;color:rgb(95,135,135)"># auto_adjust_subplotpars twice, where the second run</span>
<span class="ansi-green-fg">    281</span>     <span style="font-style:italic;color:rgb(95,135,135)"># with adjusted rect parameters.</span>

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\_tight_layout.py:82</span>, in <span class="ansi-cyan-fg">_auto_adjust_subplotpars</span><span class="ansi-blue-fg ansi-bold">(fig, renderer, shape, span_pairs, subplot_list, ax_bbox_list, pad, h_pad, w_pad, rect)</span>
<span class="ansi-green-fg">     80</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> ax <span style="font-weight:bold;color:rgb(175,0,255)">in</span> subplots:
<span class="ansi-green-fg">     81</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ax<span style="color:rgb(98,98,98)">.</span>get_visible():
<span class="ansi-green-fg ansi-bold">---&gt; 82</span>         bb <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> [martist<span style="color:rgb(98,98,98)">.</span>_get_tightbbox_for_layout_only(ax, renderer)]
<span class="ansi-green-fg">     84</span> tight_bbox_raw <span style="color:rgb(98,98,98)">=</span> Bbox<span style="color:rgb(98,98,98)">.</span>union(bb)
<span class="ansi-green-fg">     85</span> tight_bbox <span style="color:rgb(98,98,98)">=</span> fig<span style="color:rgb(98,98,98)">.</span>transFigure<span style="color:rgb(98,98,98)">.</span>inverted()<span style="color:rgb(98,98,98)">.</span>transform_bbox(tight_bbox_raw)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\artist.py:1410</span>, in <span class="ansi-cyan-fg">_get_tightbbox_for_layout_only</span><span class="ansi-blue-fg ansi-bold">(obj, *args, **kwargs)</span>
<span class="ansi-green-fg">   1404</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg">   1405</span> <span style="font-style:italic;color:rgb(175,0,0)">Matplotlib's `.Axes.get_tightbbox` and `.Axis.get_tightbbox` support a</span>
<span class="ansi-green-fg">   1406</span> <span style="font-style:italic;color:rgb(175,0,0)">*for_layout_only* kwarg; this helper tries to use the kwarg but skips it</span>
<span class="ansi-green-fg">   1407</span> <span style="font-style:italic;color:rgb(175,0,0)">when encountering third-party subclasses that do not support it.</span>
<span class="ansi-green-fg">   1408</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg">   1409</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1410</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> obj<span style="color:rgb(98,98,98)">.</span>get_tightbbox(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>{<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">for_layout_only</span><span style="color:rgb(175,0,0)">"</span>: <span style="font-weight:bold;color:rgb(0,135,0)">True</span>})
<span class="ansi-green-fg">   1411</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">TypeError</span>:
<span class="ansi-green-fg">   1412</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> obj<span style="color:rgb(98,98,98)">.</span>get_tightbbox(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\_api\deprecation.py:457</span>, in <span class="ansi-cyan-fg">make_keyword_only.&lt;locals&gt;.wrapper</span><span class="ansi-blue-fg ansi-bold">(*args, **kwargs)</span>
<span class="ansi-green-fg">    451</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">len</span>(args) <span style="color:rgb(98,98,98)">&gt;</span> name_idx:
<span class="ansi-green-fg">    452</span>     warn_deprecated(
<span class="ansi-green-fg">    453</span>         since, message<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Passing the </span><span style="font-weight:bold;color:rgb(175,95,135)">%(name)s</span><span style="color:rgb(175,0,0)"> </span><span style="font-weight:bold;color:rgb(175,95,135)">%(obj_type)s</span><span style="color:rgb(175,0,0)"> </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">    454</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">positionally is deprecated since Matplotlib </span><span style="font-weight:bold;color:rgb(175,95,135)">%(since)s</span><span style="color:rgb(175,0,0)">; the </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">    455</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">parameter will become keyword-only </span><span style="font-weight:bold;color:rgb(175,95,135)">%(removal)s</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg">    456</span>         name<span style="color:rgb(98,98,98)">=</span>name, obj_type<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">parameter of </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>func<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">()</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">--&gt; 457</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> func(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\axes\_base.py:4476</span>, in <span class="ansi-cyan-fg">_AxesBase.get_tightbbox</span><span class="ansi-blue-fg ansi-bold">(self, renderer, call_axes_locator, bbox_extra_artists, for_layout_only)</span>
<span class="ansi-green-fg">   4474</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> axis <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_axis_map<span style="color:rgb(98,98,98)">.</span>values():
<span class="ansi-green-fg">   4475</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>axison <span style="font-weight:bold;color:rgb(175,0,255)">and</span> axis<span style="color:rgb(98,98,98)">.</span>get_visible():
<span class="ansi-green-fg ansi-bold">-&gt; 4476</span>         ba <span style="color:rgb(98,98,98)">=</span> martist<span style="color:rgb(98,98,98)">.</span>_get_tightbbox_for_layout_only(axis, renderer)
<span class="ansi-green-fg">   4477</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ba:
<span class="ansi-green-fg">   4478</span>             bb<span style="color:rgb(98,98,98)">.</span>append(ba)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\artist.py:1410</span>, in <span class="ansi-cyan-fg">_get_tightbbox_for_layout_only</span><span class="ansi-blue-fg ansi-bold">(obj, *args, **kwargs)</span>
<span class="ansi-green-fg">   1404</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg">   1405</span> <span style="font-style:italic;color:rgb(175,0,0)">Matplotlib's `.Axes.get_tightbbox` and `.Axis.get_tightbbox` support a</span>
<span class="ansi-green-fg">   1406</span> <span style="font-style:italic;color:rgb(175,0,0)">*for_layout_only* kwarg; this helper tries to use the kwarg but skips it</span>
<span class="ansi-green-fg">   1407</span> <span style="font-style:italic;color:rgb(175,0,0)">when encountering third-party subclasses that do not support it.</span>
<span class="ansi-green-fg">   1408</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg">   1409</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1410</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> obj<span style="color:rgb(98,98,98)">.</span>get_tightbbox(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>{<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">for_layout_only</span><span style="color:rgb(175,0,0)">"</span>: <span style="font-weight:bold;color:rgb(0,135,0)">True</span>})
<span class="ansi-green-fg">   1411</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">TypeError</span>:
<span class="ansi-green-fg">   1412</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> obj<span style="color:rgb(98,98,98)">.</span>get_tightbbox(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\axis.py:1370</span>, in <span class="ansi-cyan-fg">Axis.get_tightbbox</span><span class="ansi-blue-fg ansi-bold">(self, renderer, for_layout_only)</span>
<span class="ansi-green-fg">   1368</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> renderer <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">   1369</span>     renderer <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>figure<span style="color:rgb(98,98,98)">.</span>_get_renderer()
<span class="ansi-green-fg ansi-bold">-&gt; 1370</span> ticks_to_draw <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_update_ticks()
<span class="ansi-green-fg">   1372</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_update_label_position(renderer)
<span class="ansi-green-fg">   1374</span> <span style="font-style:italic;color:rgb(95,135,135)"># go back to just this axis's tick labels</span>

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\axis.py:1302</span>, in <span class="ansi-cyan-fg">Axis._update_ticks</span><span class="ansi-blue-fg ansi-bold">(self)</span>
<span class="ansi-green-fg">   1300</span> major_locs <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>get_majorticklocs()
<span class="ansi-green-fg">   1301</span> major_labels <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>major<span style="color:rgb(98,98,98)">.</span>formatter<span style="color:rgb(98,98,98)">.</span>format_ticks(major_locs)
<span class="ansi-green-fg ansi-bold">-&gt; 1302</span> major_ticks <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>get_major_ticks(<span style="color:rgb(0,135,0)">len</span>(major_locs))
<span class="ansi-green-fg">   1303</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> tick, loc, label <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(major_ticks, major_locs, major_labels):
<span class="ansi-green-fg">   1304</span>     tick<span style="color:rgb(98,98,98)">.</span>update_position(loc)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\axis.py:1672</span>, in <span class="ansi-cyan-fg">Axis.get_major_ticks</span><span class="ansi-blue-fg ansi-bold">(self, numticks)</span>
<span class="ansi-green-fg">   1670</span>     tick <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_get_tick(major<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>)
<span class="ansi-green-fg">   1671</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>majorTicks<span style="color:rgb(98,98,98)">.</span>append(tick)
<span class="ansi-green-fg ansi-bold">-&gt; 1672</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_copy_tick_props(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>majorTicks[<span style="color:rgb(98,98,98)">0</span>], tick)
<span class="ansi-green-fg">   1674</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>majorTicks[:numticks]

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\axis.py:1618</span>, in <span class="ansi-cyan-fg">Axis._copy_tick_props</span><span class="ansi-blue-fg ansi-bold">(self, src, dest)</span>
<span class="ansi-green-fg">   1616</span> dest<span style="color:rgb(98,98,98)">.</span>label1<span style="color:rgb(98,98,98)">.</span>update_from(src<span style="color:rgb(98,98,98)">.</span>label1)
<span class="ansi-green-fg">   1617</span> dest<span style="color:rgb(98,98,98)">.</span>label2<span style="color:rgb(98,98,98)">.</span>update_from(src<span style="color:rgb(98,98,98)">.</span>label2)
<span class="ansi-green-fg ansi-bold">-&gt; 1618</span> dest<span style="color:rgb(98,98,98)">.</span>tick1line<span style="color:rgb(98,98,98)">.</span>update_from(src<span style="color:rgb(98,98,98)">.</span>tick1line)
<span class="ansi-green-fg">   1619</span> dest<span style="color:rgb(98,98,98)">.</span>tick2line<span style="color:rgb(98,98,98)">.</span>update_from(src<span style="color:rgb(98,98,98)">.</span>tick2line)
<span class="ansi-green-fg">   1620</span> dest<span style="color:rgb(98,98,98)">.</span>gridline<span style="color:rgb(98,98,98)">.</span>update_from(src<span style="color:rgb(98,98,98)">.</span>gridline)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\lines.py:1357</span>, in <span class="ansi-cyan-fg">Line2D.update_from</span><span class="ansi-blue-fg ansi-bold">(self, other)</span>
<span class="ansi-green-fg">   1354</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_solidjoinstyle <span style="color:rgb(98,98,98)">=</span> other<span style="color:rgb(98,98,98)">.</span>_solidjoinstyle
<span class="ansi-green-fg">   1356</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_linestyle <span style="color:rgb(98,98,98)">=</span> other<span style="color:rgb(98,98,98)">.</span>_linestyle
<span class="ansi-green-fg ansi-bold">-&gt; 1357</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_marker <span style="color:rgb(98,98,98)">=</span> MarkerStyle(marker<span style="color:rgb(98,98,98)">=</span>other<span style="color:rgb(98,98,98)">.</span>_marker)
<span class="ansi-green-fg">   1358</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_drawstyle <span style="color:rgb(98,98,98)">=</span> other<span style="color:rgb(98,98,98)">.</span>_drawstyle

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\markers.py:248</span>, in <span class="ansi-cyan-fg">MarkerStyle.__init__</span><span class="ansi-blue-fg ansi-bold">(self, marker, fillstyle, transform, capstyle, joinstyle)</span>
<span class="ansi-green-fg">    246</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_user_joinstyle <span style="color:rgb(98,98,98)">=</span> JoinStyle(joinstyle) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> joinstyle <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">    247</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_set_fillstyle(fillstyle)
<span class="ansi-green-fg ansi-bold">--&gt; 248</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_set_marker(marker)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\markers.py:323</span>, in <span class="ansi-cyan-fg">MarkerStyle._set_marker</span><span class="ansi-blue-fg ansi-bold">(self, marker)</span>
<span class="ansi-green-fg">    321</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_marker_function <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_set_tuple_marker
<span class="ansi-green-fg">    322</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(marker, MarkerStyle):
<span class="ansi-green-fg ansi-bold">--&gt; 323</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__dict__</span> <span style="color:rgb(98,98,98)">=</span> copy<span style="color:rgb(98,98,98)">.</span>deepcopy(marker<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__dict__</span>)
<span class="ansi-green-fg">    324</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    325</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:136</span>, in <span class="ansi-cyan-fg">deepcopy</span><span class="ansi-blue-fg ansi-bold">(x, memo, _nil)</span>
<span class="ansi-green-fg">    134</span> copier <span style="color:rgb(98,98,98)">=</span> _deepcopy_dispatch<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(0,135,0)">cls</span>)
<span class="ansi-green-fg">    135</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> copier <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 136</span>     y <span style="color:rgb(98,98,98)">=</span> copier(x, memo)
<span class="ansi-green-fg">    137</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">issubclass</span>(<span style="color:rgb(0,135,0)">cls</span>, <span style="color:rgb(0,135,0)">type</span>):

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:221</span>, in <span class="ansi-cyan-fg">_deepcopy_dict</span><span class="ansi-blue-fg ansi-bold">(x, memo, deepcopy)</span>
<span class="ansi-green-fg">    219</span> memo[<span style="color:rgb(0,135,0)">id</span>(x)] <span style="color:rgb(98,98,98)">=</span> y
<span class="ansi-green-fg">    220</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> key, value <span style="font-weight:bold;color:rgb(175,0,255)">in</span> x<span style="color:rgb(98,98,98)">.</span>items():
<span class="ansi-green-fg ansi-bold">--&gt; 221</span>     y[deepcopy(key, memo)] <span style="color:rgb(98,98,98)">=</span> deepcopy(value, memo)
<span class="ansi-green-fg">    222</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> y

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:143</span>, in <span class="ansi-cyan-fg">deepcopy</span><span class="ansi-blue-fg ansi-bold">(x, memo, _nil)</span>
<span class="ansi-green-fg">    141</span> copier <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">getattr</span>(x, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">__deepcopy__</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>)
<span class="ansi-green-fg">    142</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> copier <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 143</span>     y <span style="color:rgb(98,98,98)">=</span> copier(memo)
<span class="ansi-green-fg">    144</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    145</span>     reductor <span style="color:rgb(98,98,98)">=</span> dispatch_table<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(0,135,0)">cls</span>)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\site-packages\matplotlib\path.py:285</span>, in <span class="ansi-cyan-fg">Path.__deepcopy__</span><span class="ansi-blue-fg ansi-bold">(self, memo)</span>
<span class="ansi-green-fg">    280</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg">    281</span> <span style="font-style:italic;color:rgb(175,0,0)">Return a deepcopy of the `Path`.  The `Path` will not be</span>
<span class="ansi-green-fg">    282</span> <span style="font-style:italic;color:rgb(175,0,0)">readonly, even if the source `Path` is.</span>
<span class="ansi-green-fg">    283</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg">    284</span> <span style="font-style:italic;color:rgb(95,135,135)"># Deepcopying arrays (vertices, codes) strips the writeable=False flag.</span>
<span class="ansi-green-fg ansi-bold">--&gt; 285</span> p <span style="color:rgb(98,98,98)">=</span> copy<span style="color:rgb(98,98,98)">.</span>deepcopy(<span style="color:rgb(0,135,0)">super</span>(), memo)
<span class="ansi-green-fg">    286</span> p<span style="color:rgb(98,98,98)">.</span>_readonly <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg">    287</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> p

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:162</span>, in <span class="ansi-cyan-fg">deepcopy</span><span class="ansi-blue-fg ansi-bold">(x, memo, _nil)</span>
<span class="ansi-green-fg">    160</span>                 y <span style="color:rgb(98,98,98)">=</span> x
<span class="ansi-green-fg">    161</span>             <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 162</span>                 y <span style="color:rgb(98,98,98)">=</span> _reconstruct(x, memo, <span style="color:rgb(98,98,98)">*</span>rv)
<span class="ansi-green-fg">    164</span> <span style="font-style:italic;color:rgb(95,135,135)"># If is its own copy, don't memoize.</span>
<span class="ansi-green-fg">    165</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> y <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> x:

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:259</span>, in <span class="ansi-cyan-fg">_reconstruct</span><span class="ansi-blue-fg ansi-bold">(x, memo, func, args, state, listiter, dictiter, deepcopy)</span>
<span class="ansi-green-fg">    257</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> state <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">    258</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> deep:
<span class="ansi-green-fg ansi-bold">--&gt; 259</span>         state <span style="color:rgb(98,98,98)">=</span> deepcopy(state, memo)
<span class="ansi-green-fg">    260</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">hasattr</span>(y, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">__setstate__</span><span style="color:rgb(175,0,0)">'</span>):
<span class="ansi-green-fg">    261</span>         y<span style="color:rgb(98,98,98)">.</span>__setstate__(state)

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:136</span>, in <span class="ansi-cyan-fg">deepcopy</span><span class="ansi-blue-fg ansi-bold">(x, memo, _nil)</span>
<span class="ansi-green-fg">    134</span> copier <span style="color:rgb(98,98,98)">=</span> _deepcopy_dispatch<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(0,135,0)">cls</span>)
<span class="ansi-green-fg">    135</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> copier <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 136</span>     y <span style="color:rgb(98,98,98)">=</span> copier(x, memo)
<span class="ansi-green-fg">    137</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">issubclass</span>(<span style="color:rgb(0,135,0)">cls</span>, <span style="color:rgb(0,135,0)">type</span>):

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:221</span>, in <span class="ansi-cyan-fg">_deepcopy_dict</span><span class="ansi-blue-fg ansi-bold">(x, memo, deepcopy)</span>
<span class="ansi-green-fg">    219</span> memo[<span style="color:rgb(0,135,0)">id</span>(x)] <span style="color:rgb(98,98,98)">=</span> y
<span class="ansi-green-fg">    220</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> key, value <span style="font-weight:bold;color:rgb(175,0,255)">in</span> x<span style="color:rgb(98,98,98)">.</span>items():
<span class="ansi-green-fg ansi-bold">--&gt; 221</span>     y[deepcopy(key, memo)] <span style="color:rgb(98,98,98)">=</span> deepcopy(value, memo)
<span class="ansi-green-fg">    222</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> y

File <span class="ansi-green-fg ansi-bold">c:\Users\for329\AppData\Local\miniconda3\envs\deep_ssf_env2\Lib\copy.py:143</span>, in <span class="ansi-cyan-fg">deepcopy</span><span class="ansi-blue-fg ansi-bold">(x, memo, _nil)</span>
<span class="ansi-green-fg">    141</span> copier <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">getattr</span>(x, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">__deepcopy__</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>)
<span class="ansi-green-fg">    142</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> copier <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">--&gt; 143</span>     y <span style="color:rgb(98,98,98)">=</span> copier(memo)
<span class="ansi-green-fg">    144</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    145</span>     reductor <span style="color:rgb(98,98,98)">=</span> dispatch_table<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(0,135,0)">cls</span>)

<span class="ansi-red-fg ansi-bold">KeyboardInterrupt</span>: </pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="deepSSF_next_step_validation_files/figure-html/cell-31-output-18.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-51" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>value <span class="op">=</span> <span class="op">-</span><span class="fl">7.5</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.exp(value))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>value <span class="op">=</span> <span class="fl">6e-4</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.log(value))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># buffalo_df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.0005530843701478336
-7.418580902748128</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>