<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>

<meta charset="utf-8" />
<meta name="generator" content="quarto-1.6.40" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

<meta name="author" content="Scott Forrest" />
<meta name="dcterms.date" content="2025-02-09" />

<title>Preparing data for deepSSF model fitting – deepSSF</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<!-- htmldependencies:E3FAD763 -->
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


<link rel="stylesheet" href="styles.css" />
</head>

<body>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="/index.html">
    <span class="navbar-title">deepSSF</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
  aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation"
  onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="/index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/swforrest/deepSSF"> <i 
  class="bi bi-github" 
  role="img" 
>
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <div id="quarto-toc-target"></div>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Preparing data for deepSSF model fitting</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Scott Forrest </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 9, 2025</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>Here we prepare the data for fitting a deepSSF model. We load the GPS dataand tidy it, create a trajectory object containing a series of steps and read in the environmental layers. For each observed step we crop out local subsets of the environmental layers, centred on the step’s location. For every step we will then have the surrounding environmental information stored as a stack of small rasters, with the ‘target’ of what we’re trying to predict (the actual location of the next step) as a raster layer as well, with all cells being 0 except the observed next location, which is 1. These, along with temporal covariates and the previous bearing, will be the input data for the deepSSF model.</p>
  </div>
</div>


</header>

<nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#loading-packages" id="toc-loading-packages">Loading packages</a></li>
  <li><a href="#import-data" id="toc-import-data">Import data</a></li>
  <li><a href="#tidy-data" id="toc-tidy-data">Tidy data</a></li>
  <li><a href="#setup-trajectory" id="toc-setup-trajectory">Setup trajectory</a></li>
  <li><a href="#plot-the-data-coloured-by-time" id="toc-plot-the-data-coloured-by-time">Plot the data coloured by time</a></li>
  <li><a href="#read-in-the-environmental-covariates" id="toc-read-in-the-environmental-covariates">Read in the environmental covariates</a></li>
  <li><a href="#generating-the-data-to-fit-a-deepssf-model" id="toc-generating-the-data-to-fit-a-deepssf-model">Generating the data to fit a deepSSF model</a>
  <ul>
  <li><a href="#create-a-steps-object-to-check-the-step-lengths" id="toc-create-a-steps-object-to-check-the-step-lengths">Create a steps object to check the step lengths</a>
  <ul>
  <li><a href="#plot-step-lengths" id="toc-plot-step-lengths">Plot step lengths</a></li>
  </ul></li>
  <li><a href="#set-up-the-spatial-extent-of-the-local-covariates" id="toc-set-up-the-spatial-extent-of-the-local-covariates">Set up the spatial extent of the local covariates</a></li>
  </ul></li>
  <li><a href="#loop-over-each-individual-and-save-the-local-rasters" id="toc-loop-over-each-individual-and-save-the-local-rasters">Loop over each individual and save the local rasters</a>
  <ul>
  <li><a href="#check-the-outputs" id="toc-check-the-outputs">Check the outputs</a></li>
  <li><a href="#plot-a-subset-of-the-local-covariates" id="toc-plot-a-subset-of-the-local-covariates">Plot a subset of the local covariates</a></li>
  <li><a href="#to-save-the-object-with-all-of-the-local-covariates" id="toc-to-save-the-object-with-all-of-the-local-covariates">To save the object with all of the local covariates</a></li>
  <li><a href="#to-save-some-plots" id="toc-to-save-some-plots">To save some plots</a></li>
  <li><a href="#plot-the-step-lengths-and-turning-angles" id="toc-plot-the-step-lengths-and-turning-angles">Plot the step lengths and turning angles</a></li>
  </ul></li>
  </ul>
</nav>
<section id="loading-packages" class="level2">
<h2>Loading packages</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;amt&quot;</span>, <span class="st">&quot;sf&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;beepr&quot;</span>, <span class="st">&quot;tictoc&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">walk</span>(packages, require, <span class="at">character.only =</span> T)</span></code></pre></div>
</details>
</div>
</section>
<section id="import-data" class="level2">
<h2>Import data</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>buffalo <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/buffalo.csv&quot;</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 133161 Columns: 11
── Column specification
──────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr
(2): node, dates dbl (7): ...1, lat, lon, height, accuracy, heading, speed dttm
(2): timestamp, DateTime
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">head</span>(buffalo)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":["...1"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["timestamp"],"name":[2],"type":["dttm"],"align":["right"]},{"label":["lat"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["lon"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["height"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["accuracy"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["heading"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["speed"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["node"],"name":[9],"type":["chr"],"align":["left"]},{"label":["dates"],"name":[10],"type":["chr"],"align":["left"]},{"label":["DateTime"],"name":[11],"type":["dttm"],"align":["right"]}],"data":[{"1":"169","2":"2018-07-25 00:04:02.050139","3":"-12.30136","4":"134.3780","5":"91.271","6":"977","7":"0.00000","8":"0.000","9":"2005","10":"25/7/18 10:04","11":"2018-07-25 00:04:02"},{"1":"170","2":"2018-07-25 01:04:23.050139","3":"-12.29955","4":"134.3782","5":"92.105","6":"704","7":"77.04576","8":"0.034","9":"2005","10":"25/7/18 11:04","11":"2018-07-25 01:04:23"},{"1":"171","2":"2018-07-25 02:04:39.050139","3":"-12.29940","4":"134.3778","5":"95.206","6":"1105","7":"128.51200","8":"0.008","9":"2005","10":"25/7/18 12:04","11":"2018-07-25 02:04:39"},{"1":"172","2":"2018-07-25 03:04:17.050873","3":"-12.29893","4":"134.3765","5":"103.939","6":"865","7":"0.00000","8":"0.013","9":"2005","10":"25/7/18 13:04","11":"2018-07-25 03:04:17"},{"1":"173","2":"2018-07-25 04:04:39.050873","3":"-12.29924","4":"134.3770","5":"85.487","6":"711","7":"230.93248","8":"0.010","9":"2005","10":"25/7/18 14:04","11":"2018-07-25 04:04:39"},{"1":"174","2":"2018-07-25 05:04:27.050873","3":"-12.29897","4":"134.3754","5":"95.778","6":"780","7":"207.18592","8":"0.012","9":"2005","10":"25/7/18 15:04","11":"2018-07-25 05:04:27"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="tidy-data" class="level2">
<h2>Tidy data</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># remove individuals that have poor data quality or less than about 3 months of data. </span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># The &quot;2014.GPS_COMPACT copy.csv&quot; string is a duplicate of ID 2024, so we also exclude it</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>buffalo <span class="ot">&lt;-</span> buffalo <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>node <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;2014.GPS_COMPACT copy.csv&quot;</span>, </span>
<span id="cb5-4"><a href="#cb5-4"></a>                                           <span class="co"># 2005, 2014, 2018, 2021, 2022, 2024,</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>                                           <span class="dv">2029</span>, <span class="dv">2043</span>, <span class="dv">2265</span>, <span class="dv">2284</span>, <span class="dv">2346</span>, <span class="dv">2354</span>))</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co"># arrange by time and exclude any duplicate timestamps (within the same individual&#39;s data)</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>buffalo <span class="ot">&lt;-</span> buffalo <span class="sc">%&gt;%</span>  </span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="fu">group_by</span>(node) <span class="sc">%&gt;%</span> </span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="fu">arrange</span>(DateTime, <span class="at">.by_group =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="fu">distinct</span>(DateTime, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="fu">arrange</span>(node) <span class="sc">%&gt;%</span> </span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> node)</span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co"># keep only the relevant columns</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>buffalo_clean <span class="ot">&lt;-</span> buffalo[, <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>)]</span>
<span id="cb5-17"><a href="#cb5-17"></a></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co"># rename the columns</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="fu">colnames</span>(buffalo_clean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co"># convert the time to the correct timezone</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="fu">attr</span>(buffalo_clean<span class="sc">$</span>time, <span class="st">&quot;tzone&quot;</span>) <span class="ot">&lt;-</span> <span class="st">&quot;Australia/Queensland&quot;</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="fu">head</span>(buffalo_clean)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["time"],"name":[2],"type":["dttm"],"align":["right"]},{"label":["lon"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["lat"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"2005","2":"2018-07-25 10:04:02.050139","3":"134.3780","4":"-12.30136"},{"1":"2005","2":"2018-07-25 11:04:23.050139","3":"134.3782","4":"-12.29955"},{"1":"2005","2":"2018-07-25 12:04:39.050139","3":"134.3778","4":"-12.29940"},{"1":"2005","2":"2018-07-25 13:04:17.050873","3":"134.3765","4":"-12.29893"},{"1":"2005","2":"2018-07-25 14:04:39.050873","3":"134.3770","4":"-12.29924"},{"1":"2005","2":"2018-07-25 15:04:27.050873","3":"134.3754","4":"-12.29897"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># check timezone</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">tz</span>(buffalo_clean<span class="sc">$</span>time)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Australia/Queensland&quot;</code></pre>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># create a vector of the unique ids for indexing later</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>buffalo_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(buffalo_clean<span class="sc">$</span>id)</span></code></pre></div>
</details>
</div>
</section>
<section id="setup-trajectory" class="level2">
<h2>Setup trajectory</h2>
<p>Use the <code>amt</code> package to create a trajectory object from the cleaned data.</p>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>buffalo_all <span class="ot">&lt;-</span> buffalo_clean <span class="sc">%&gt;%</span> <span class="fu">mk_track</span>(<span class="at">id =</span> id,</span>
<span id="cb9-2"><a href="#cb9-2"></a>                                          lon,</span>
<span id="cb9-3"><a href="#cb9-3"></a>                                          lat, </span>
<span id="cb9-4"><a href="#cb9-4"></a>                                          time, </span>
<span id="cb9-5"><a href="#cb9-5"></a>                                          <span class="at">all_cols =</span> T,</span>
<span id="cb9-6"><a href="#cb9-6"></a>                                          <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="co"># Transformation to GDA94 / Geoscience Australia Lambert (https://epsg.io/3112)</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="fu">transform_coords</span>(<span class="at">crs_to =</span> <span class="dv">3112</span>, <span class="at">crs_from =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id) </span></code></pre></div>
</details>
</div>
</section>
<section id="plot-the-data-coloured-by-time" class="level2">
<h2>Plot the data coloured by time</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>buffalo_all <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x_, <span class="at">y =</span> y_, <span class="at">colour =</span> t_)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="fu">scale_colour_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" /></p>
</figure>
</div>
</div>
</div>
</section>
<section id="read-in-the-environmental-covariates" class="level2">
<h2>Read in the environmental covariates</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>ndvi_projected <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/ndvi_GEE_projected_watermask20230207.tif&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a>terra<span class="sc">::</span><span class="fu">time</span>(ndvi_projected) <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(<span class="st">&quot;2018-01-01&quot;</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">23</span>))</span>
<span id="cb11-3"><a href="#cb11-3"></a>slope <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/slope_raster.tif&quot;</span>)</span>
<span id="cb11-4"><a href="#cb11-4"></a>veg_herby <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/veg_herby.tif&quot;</span>)</span>
<span id="cb11-5"><a href="#cb11-5"></a>canopy_cover <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/canopy_cover.tif&quot;</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co"># change the names (these will become the column names when extracting </span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co"># covariate values at the used and random steps)</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="fu">names</span>(ndvi_projected) <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;ndvi&quot;</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(ndvi_projected))</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="fu">names</span>(slope) <span class="ot">&lt;-</span> <span class="st">&quot;slope&quot;</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="fu">names</span>(veg_herby) <span class="ot">&lt;-</span> <span class="st">&quot;veg_herby&quot;</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="fu">names</span>(canopy_cover) <span class="ot">&lt;-</span> <span class="st">&quot;canopy_cover&quot;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co"># to plot the rasters</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="fu">plot</span>(ndvi_projected)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">plot</span>(ndvi_projected[[<span class="dv">1</span>]])</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">plot</span>(slope)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-6-3.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">plot</span>(veg_herby)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-6-4.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">plot</span>(canopy_cover)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-6-5.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># get the resolution from the covariates</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>res <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">res</span>(ndvi_projected)[<span class="dv">1</span>]</span></code></pre></div>
</details>
</div>
</section>
<section id="generating-the-data-to-fit-a-deepssf-model" class="level1">
<h1>Generating the data to fit a deepSSF model</h1>
<section id="create-a-steps-object-to-check-the-step-lengths" class="level2">
<h2>Create a steps object to check the step lengths</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># nest the data by individual</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>buffalo_all_nested <span class="ot">&lt;-</span> buffalo_all <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id) <span class="sc">%&gt;%</span> <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span><span class="st">&quot;id&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a>buffalo_all_nested_steps <span class="ot">&lt;-</span> buffalo_all_nested <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="fu">mutate</span>(<span class="at">steps =</span> <span class="fu">map</span>(data, <span class="cf">function</span>(x)</span>
<span id="cb17-6"><a href="#cb17-6"></a>    x <span class="sc">%&gt;%</span> </span>
<span id="cb17-7"><a href="#cb17-7"></a>      <span class="co"># track_resample(rate = hours(1), tolerance = minutes(10)) %&gt;%</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>      <span class="fu">steps</span>()))</span>
<span id="cb17-9"><a href="#cb17-9"></a></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co"># unnest the data after creating &#39;steps&#39; objects</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>buffalo_all_steps <span class="ot">&lt;-</span> buffalo_all_nested_steps <span class="sc">%&gt;%</span> </span>
<span id="cb17-12"><a href="#cb17-12"></a>  amt<span class="sc">::</span><span class="fu">select</span>(id, steps) <span class="sc">%&gt;%</span> </span>
<span id="cb17-13"><a href="#cb17-13"></a>  amt<span class="sc">::</span><span class="fu">unnest</span>(<span class="at">cols =</span> steps)</span>
<span id="cb17-14"><a href="#cb17-14"></a></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="fu">head</span>(buffalo_all_steps)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["x1_"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["x2_"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["y1_"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["y2_"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["sl_"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["direction_p"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["ta_"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["t1_"],"name":[9],"type":["dttm"],"align":["right"]},{"label":["t2_"],"name":[10],"type":["dttm"],"align":["right"]},{"label":["dt_"],"name":[11],"type":["drtn"],"align":["right"]}],"data":[{"1":"2005","2":"41941.33","3":"41969.31","4":"-1435875","5":"-1435671","6":"205.97331","7":"1.4345362","8":"NA","9":"2018-07-25 10:04:02.050139","10":"2018-07-25 11:04:23.050139","11":"60.35000 mins","_rn_":"1"},{"1":"2005","2":"41969.31","3":"41921.52","4":"-1435671","5":"-1435654","6":"50.67489","7":"2.8024782","8":"1.36794199","9":"2018-07-25 11:04:23.050139","10":"2018-07-25 12:04:39.050139","11":"60.26667 mins","_rn_":"2"},{"1":"2005","2":"41921.52","3":"41779.44","4":"-1435654","5":"-1435601","6":"151.84521","7":"2.7810489","8":"-0.02142933","9":"2018-07-25 12:04:39.050139","10":"2018-07-25 13:04:17.050873","11":"59.63335 mins","_rn_":"3"},{"1":"2005","2":"41779.44","3":"41841.20","4":"-1435601","5":"-1435635","6":"70.65986","7":"-0.5072195","8":"2.99491689","9":"2018-07-25 13:04:17.050873","10":"2018-07-25 14:04:39.050873","11":"60.36667 mins","_rn_":"4"},{"1":"2005","2":"41841.20","3":"41655.46","4":"-1435635","5":"-1435604","6":"188.30970","7":"2.9761984","8":"-2.79976733","9":"2018-07-25 14:04:39.050873","10":"2018-07-25 15:04:27.050873","11":"59.80000 mins","_rn_":"5"},{"1":"2005","2":"41655.46","3":"41618.65","4":"-1435604","5":"-1435608","6":"37.07797","7":"-3.0216103","8":"0.28537660","9":"2018-07-25 15:04:27.050873","10":"2018-07-25 16:04:24.048919","11":"59.94997 mins","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<section id="plot-step-lengths" class="level3">
<h3>Plot step lengths</h3>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># plot step lengths</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>buffalo_all_steps <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">filter</span>(sl_ <span class="sc">&lt;</span> <span class="dv">2000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> sl_), <span class="co">#, bins = 50</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>                 <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Step length (m)&quot;</span>) <span class="sc">+</span> <span class="co">#, limits = c(-25, 1250)</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Step lengths&quot;</span>) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># proportion of steps less than the buffer distance</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># the distance should be a multiple of the resolution</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>distance <span class="ot">&lt;-</span> <span class="dv">1250</span></span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co"># check if multiple of the resolution?</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>distance <span class="sc">%%</span> res <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># buffer distance (add the resolution of the cell/2 as we want a centre cell)</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>buffer <span class="ot">&lt;-</span> <span class="dv">1250</span> <span class="sc">+</span> (res<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co"># calculate proportion</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>prop_steps <span class="ot">&lt;-</span> buffalo_all_steps <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sl_ <span class="sc">&lt;</span> buffer) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span> buffalo_all_steps <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Proportion of steps less than &quot;</span>, buffer, <span class="st">&quot;m: &quot;</span>, <span class="fu">round</span>(prop_steps, <span class="dv">4</span>)))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Proportion of steps less than 1262.5m: 0.9573&quot;</code></pre>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># distance to the corner</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>corner_dist <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(buffer<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> buffer<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Distance to the corner: &quot;</span>, <span class="fu">round</span>(corner_dist, <span class="dv">2</span>)))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Distance to the corner: 1785.44&quot;</code></pre>
</div>
</div>
<p>In our case 95% of the steps were less than a distance of 1262.5m, which would mean that including 101 x 101 cells (which would be 2525 m x 2525 m) would include at least 95% of the steps.</p>
<p>Note: as 1262.5 m is the shortest distance to the boundary, and it is further to a corner (which is 1786 m away), which means we will actually be including more than 95% of the steps.</p>
</section>
</section>
<section id="set-up-the-spatial-extent-of-the-local-covariates" class="level2">
<h2>Set up the spatial extent of the local covariates</h2>
<p>We calculate the number of cells in each axis, and set the lag between locations. Typically this will just be 1, as we want the next-step to be the target. However, it may be possible to improve model training by using different lags and including the time difference between locations as a covariate. I expect that this would help to predict across different time scales and not be restricted to the time scale that the data was collected at.</p>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># calculate the number of cells in each axis</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>nxn_cells <span class="ot">&lt;-</span> buffer<span class="sc">*</span><span class="dv">2</span><span class="sc">/</span>res</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Number of cells in each axis: &quot;</span>, nxn_cells))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Number of cells in each axis: 101&quot;</code></pre>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># hourly lag - to set larger time differences between locations</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>hourly_lag <span class="ot">&lt;-</span> <span class="dv">1</span></span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="loop-over-each-individual-and-save-the-local-rasters" class="level1">
<h1>Loop over each individual and save the local rasters</h1>
<p>This is the main function of the script. It loops over each individual and calculates step level information, such as the location and time of the next step (x2, y2, t2), step length, turning angle, and different time components.</p>
<p>It also determines where to crop the local layers by subtracting and adding the buffer distance from the location of each step. It then crops out the local layers for each step and saves them as a list entry into the data frame.</p>
<p>It then creates a raster stack (with the number of layers equal to the number of steps) for each covariate and saves it as a tif.</p>
<p>For each individual, this will therefore create a csv containing the step level information, and a tif for each covariate containing the local layers for each step.</p>
<p>It takes quite a while to run, around 1 hour per individual in our case, so we will illustrate the function with 10 steps per individual. Uncomment the line specified in the loop to use the full dataset.</p>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(buffalo_ids)) {</span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a>  buffalo_data <span class="ot">&lt;-</span> buffalo_all <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">==</span> buffalo_ids[i])</span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="co"># all data for that individual</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>  buffalo_data <span class="ot">&lt;-</span> buffalo_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(t_)</span>
<span id="cb28-6"><a href="#cb28-6"></a>  </span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="co"># to use a subset of the data for that individual for testing</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="co"># COMMENT THIS LINE OUT TO USE THE FULL DATASET</span></span>
<span id="cb28-9"><a href="#cb28-9"></a>  buffalo_data <span class="ot">&lt;-</span> buffalo_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(t_) <span class="sc">|&gt;</span>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb28-10"><a href="#cb28-10"></a></span>
<span id="cb28-11"><a href="#cb28-11"></a>  n_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(buffalo_data)</span>
<span id="cb28-12"><a href="#cb28-12"></a>  </span>
<span id="cb28-13"><a href="#cb28-13"></a>  <span class="fu">tic</span>()</span>
<span id="cb28-14"><a href="#cb28-14"></a>  </span>
<span id="cb28-15"><a href="#cb28-15"></a>  buffalo_data_covs <span class="ot">&lt;-</span> buffalo_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb28-16"><a href="#cb28-16"></a>    </span>
<span id="cb28-17"><a href="#cb28-17"></a>    <span class="at">x1_ =</span> x_,</span>
<span id="cb28-18"><a href="#cb28-18"></a>    <span class="at">y1_ =</span> y_,</span>
<span id="cb28-19"><a href="#cb28-19"></a>    <span class="at">x2_ =</span> <span class="fu">lead</span>(x1_, <span class="at">n =</span> hourly_lag, <span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb28-20"><a href="#cb28-20"></a>    <span class="at">y2_ =</span> <span class="fu">lead</span>(y1_, <span class="at">n =</span> hourly_lag, <span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb28-21"><a href="#cb28-21"></a>    <span class="at">x2_cent =</span> x2_ <span class="sc">-</span> x1_,</span>
<span id="cb28-22"><a href="#cb28-22"></a>    <span class="at">y2_cent =</span> y2_ <span class="sc">-</span> y1_,</span>
<span id="cb28-23"><a href="#cb28-23"></a>    <span class="at">t2_ =</span> <span class="fu">lead</span>(t_, <span class="at">n =</span> hourly_lag, <span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb28-24"><a href="#cb28-24"></a>    <span class="at">t_diff =</span> <span class="fu">round</span>(<span class="fu">difftime</span>(t2_, t_, <span class="at">units =</span> <span class="st">&quot;hours&quot;</span>),<span class="dv">0</span>),</span>
<span id="cb28-25"><a href="#cb28-25"></a>    <span class="at">hour_t1 =</span> lubridate<span class="sc">::</span><span class="fu">hour</span>(t_),</span>
<span id="cb28-26"><a href="#cb28-26"></a>    <span class="at">yday_t1 =</span> lubridate<span class="sc">::</span><span class="fu">yday</span>(t_),</span>
<span id="cb28-27"><a href="#cb28-27"></a>    <span class="at">hour_t2 =</span> lubridate<span class="sc">::</span><span class="fu">hour</span>(t2_),</span>
<span id="cb28-28"><a href="#cb28-28"></a>    <span class="at">hour_t2_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>hour_t2<span class="sc">/</span><span class="dv">24</span>),</span>
<span id="cb28-29"><a href="#cb28-29"></a>    <span class="at">hour_t2_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>hour_t2<span class="sc">/</span><span class="dv">24</span>),</span>
<span id="cb28-30"><a href="#cb28-30"></a>    <span class="at">yday_t2 =</span> lubridate<span class="sc">::</span><span class="fu">yday</span>(t2_),</span>
<span id="cb28-31"><a href="#cb28-31"></a>    <span class="at">yday_t2_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>yday_t2<span class="sc">/</span><span class="fl">365.25</span>),</span>
<span id="cb28-32"><a href="#cb28-32"></a>    <span class="at">yday_t2_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>yday_t2<span class="sc">/</span><span class="fl">365.25</span>),</span>
<span id="cb28-33"><a href="#cb28-33"></a>    </span>
<span id="cb28-34"><a href="#cb28-34"></a>    <span class="at">sl =</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(<span class="fu">diff</span>(y_)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">diff</span>(x_)<span class="sc">^</span><span class="dv">2</span>), <span class="cn">NA</span>),</span>
<span id="cb28-35"><a href="#cb28-35"></a>    <span class="at">log_sl =</span> <span class="fu">log</span>(sl),</span>
<span id="cb28-36"><a href="#cb28-36"></a>    <span class="at">bearing =</span> <span class="fu">c</span>(<span class="fu">atan2</span>(<span class="fu">diff</span>(y_), <span class="fu">diff</span>(x_)), <span class="cn">NA</span>),</span>
<span id="cb28-37"><a href="#cb28-37"></a>    <span class="at">bearing_sin =</span> <span class="fu">sin</span>(bearing),</span>
<span id="cb28-38"><a href="#cb28-38"></a>    <span class="at">bearing_cos =</span> <span class="fu">cos</span>(bearing),</span>
<span id="cb28-39"><a href="#cb28-39"></a>    <span class="at">ta =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">ifelse</span>(</span>
<span id="cb28-40"><a href="#cb28-40"></a>      <span class="fu">diff</span>(bearing) <span class="sc">&gt;</span> pi, <span class="fu">diff</span>(bearing)<span class="sc">-</span>(<span class="dv">2</span><span class="sc">*</span>pi), <span class="fu">ifelse</span>(</span>
<span id="cb28-41"><a href="#cb28-41"></a>        <span class="fu">diff</span>(bearing) <span class="sc">&lt;</span> <span class="sc">-</span>pi, <span class="fu">diff</span>(bearing)<span class="sc">+</span>(<span class="dv">2</span><span class="sc">*</span>pi), <span class="fu">diff</span>(bearing)))),</span>
<span id="cb28-42"><a href="#cb28-42"></a>    <span class="at">cos_ta =</span> <span class="fu">cos</span>(ta),</span>
<span id="cb28-43"><a href="#cb28-43"></a>      </span>
<span id="cb28-44"><a href="#cb28-44"></a>    <span class="co"># extent for cropping the spatial covariates</span></span>
<span id="cb28-45"><a href="#cb28-45"></a>    <span class="at">x_min =</span> x_ <span class="sc">-</span> buffer,</span>
<span id="cb28-46"><a href="#cb28-46"></a>    <span class="at">x_max =</span> x_ <span class="sc">+</span> buffer,</span>
<span id="cb28-47"><a href="#cb28-47"></a>    <span class="at">y_min =</span> y_ <span class="sc">-</span> buffer,</span>
<span id="cb28-48"><a href="#cb28-48"></a>    <span class="at">y_max =</span> y_ <span class="sc">+</span> buffer,</span>
<span id="cb28-49"><a href="#cb28-49"></a>    </span>
<span id="cb28-50"><a href="#cb28-50"></a>  </span>
<span id="cb28-51"><a href="#cb28-51"></a>    <span class="co"># crop out and store the local covariates centered on the animal&#39;s location </span></span>
<span id="cb28-52"><a href="#cb28-52"></a>    <span class="co"># with an extent set in the previous chunk</span></span>
<span id="cb28-53"><a href="#cb28-53"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb28-54"><a href="#cb28-54"></a></span>
<span id="cb28-55"><a href="#cb28-55"></a>    <span class="at">extent_00centre =</span> <span class="fu">list</span>(<span class="fu">ext</span>(x_min <span class="sc">-</span> x_, x_max <span class="sc">-</span> x_, y_min <span class="sc">-</span> y_, y_max <span class="sc">-</span> y_)),</span>
<span id="cb28-56"><a href="#cb28-56"></a></span>
<span id="cb28-57"><a href="#cb28-57"></a>    <span class="co"># NDVI</span></span>
<span id="cb28-58"><a href="#cb28-58"></a>    <span class="at">ndvi_index =</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(<span class="fu">difftime</span>(t_, terra<span class="sc">::</span><span class="fu">time</span>(ndvi_projected)))),</span>
<span id="cb28-59"><a href="#cb28-59"></a>    <span class="at">ndvi_cent =</span> <span class="fu">list</span>({</span>
<span id="cb28-60"><a href="#cb28-60"></a>      ndvi_cent <span class="ot">=</span> <span class="fu">crop</span>(ndvi_projected[[ndvi_index]], <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb28-61"><a href="#cb28-61"></a>      <span class="fu">ext</span>(ndvi_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb28-62"><a href="#cb28-62"></a>      ndvi_cent</span>
<span id="cb28-63"><a href="#cb28-63"></a>      }),</span>
<span id="cb28-64"><a href="#cb28-64"></a></span>
<span id="cb28-65"><a href="#cb28-65"></a>    <span class="co"># herbaceous vegetation</span></span>
<span id="cb28-66"><a href="#cb28-66"></a>    <span class="at">veg_herby_cent =</span> <span class="fu">list</span>({</span>
<span id="cb28-67"><a href="#cb28-67"></a>      veg_herby_cent <span class="ot">=</span> <span class="fu">crop</span>(veg_herby, <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb28-68"><a href="#cb28-68"></a>      <span class="fu">ext</span>(veg_herby_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb28-69"><a href="#cb28-69"></a>      veg_herby_cent</span>
<span id="cb28-70"><a href="#cb28-70"></a>      }),</span>
<span id="cb28-71"><a href="#cb28-71"></a></span>
<span id="cb28-72"><a href="#cb28-72"></a>    <span class="co"># canopy cover</span></span>
<span id="cb28-73"><a href="#cb28-73"></a>    <span class="at">canopy_cover_cent =</span> <span class="fu">list</span>({</span>
<span id="cb28-74"><a href="#cb28-74"></a>      canopy_cover_cent <span class="ot">=</span> <span class="fu">crop</span>(canopy_cover, <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb28-75"><a href="#cb28-75"></a>      <span class="fu">ext</span>(canopy_cover_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb28-76"><a href="#cb28-76"></a>      canopy_cover_cent</span>
<span id="cb28-77"><a href="#cb28-77"></a>      }),</span>
<span id="cb28-78"><a href="#cb28-78"></a></span>
<span id="cb28-79"><a href="#cb28-79"></a>    <span class="co"># slope</span></span>
<span id="cb28-80"><a href="#cb28-80"></a>    <span class="at">slope_cent =</span> <span class="fu">list</span>({</span>
<span id="cb28-81"><a href="#cb28-81"></a>      slope_cent <span class="ot">&lt;-</span> <span class="fu">crop</span>(slope, <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb28-82"><a href="#cb28-82"></a>      <span class="fu">ext</span>(slope_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb28-83"><a href="#cb28-83"></a>      slope_cent</span>
<span id="cb28-84"><a href="#cb28-84"></a>      }),</span>
<span id="cb28-85"><a href="#cb28-85"></a></span>
<span id="cb28-86"><a href="#cb28-86"></a>    <span class="co"># rasterised location of the next step - centred on (0,0)</span></span>
<span id="cb28-87"><a href="#cb28-87"></a>    <span class="at">points_vect_cent =</span> <span class="fu">list</span>(terra<span class="sc">::</span><span class="fu">vect</span>(<span class="fu">cbind</span>(x2_ <span class="sc">-</span> x_, y2_ <span class="sc">-</span> y_), <span class="at">type =</span> <span class="st">&quot;points&quot;</span>, <span class="at">crs =</span> <span class="st">&quot;EPSG:3112&quot;</span>)),</span>
<span id="cb28-88"><a href="#cb28-88"></a>    <span class="at">pres_cent =</span> <span class="fu">list</span>(<span class="fu">rasterize</span>(points_vect_cent, ndvi_cent, <span class="at">background=</span><span class="dv">0</span>))</span>
<span id="cb28-89"><a href="#cb28-89"></a></span>
<span id="cb28-90"><a href="#cb28-90"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="co"># to remove the &#39;rowwise&#39; class</span></span>
<span id="cb28-91"><a href="#cb28-91"></a></span>
<span id="cb28-92"><a href="#cb28-92"></a></span>
<span id="cb28-93"><a href="#cb28-93"></a>  <span class="fu">toc</span>()</span>
<span id="cb28-94"><a href="#cb28-94"></a></span>
<span id="cb28-95"><a href="#cb28-95"></a>  <span class="co"># remove steps that fall outside of the local spatial extent</span></span>
<span id="cb28-96"><a href="#cb28-96"></a>  buffalo_data_covs <span class="ot">&lt;-</span> buffalo_data_covs <span class="sc">%&gt;%</span></span>
<span id="cb28-97"><a href="#cb28-97"></a>    <span class="fu">filter</span>(x2_cent <span class="sc">&gt;</span> <span class="sc">-</span>buffer <span class="sc">&amp;</span> x2_cent <span class="sc">&lt;</span> buffer <span class="sc">&amp;</span> y2_cent <span class="sc">&gt;</span> <span class="sc">-</span>buffer <span class="sc">&amp;</span> y2_cent <span class="sc">&lt;</span> buffer) <span class="sc">%&gt;%</span></span>
<span id="cb28-98"><a href="#cb28-98"></a>    <span class="fu">drop_na</span>(ta)</span>
<span id="cb28-99"><a href="#cb28-99"></a></span>
<span id="cb28-100"><a href="#cb28-100"></a>  <span class="co"># remove the columns that are no longer needed</span></span>
<span id="cb28-101"><a href="#cb28-101"></a>  buffalo_data_df <span class="ot">&lt;-</span> buffalo_data_covs <span class="sc">%&gt;%</span></span>
<span id="cb28-102"><a href="#cb28-102"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>extent_00centre,</span>
<span id="cb28-103"><a href="#cb28-103"></a>                <span class="sc">-</span>ndvi_cent,</span>
<span id="cb28-104"><a href="#cb28-104"></a>                <span class="sc">-</span>veg_herby_cent,</span>
<span id="cb28-105"><a href="#cb28-105"></a>                <span class="sc">-</span>canopy_cover_cent,</span>
<span id="cb28-106"><a href="#cb28-106"></a>                <span class="sc">-</span>slope_cent,</span>
<span id="cb28-107"><a href="#cb28-107"></a>                <span class="sc">-</span>points_vect_cent,</span>
<span id="cb28-108"><a href="#cb28-108"></a>                <span class="sc">-</span>pres_cent</span>
<span id="cb28-109"><a href="#cb28-109"></a>                )</span>
<span id="cb28-110"><a href="#cb28-110"></a></span>
<span id="cb28-111"><a href="#cb28-111"></a>  <span class="co"># save the data</span></span>
<span id="cb28-112"><a href="#cb28-112"></a>  <span class="fu">write_csv</span>(buffalo_data_df, <span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_data_id/buffalo_&quot;</span>, buffalo_ids[i],</span>
<span id="cb28-113"><a href="#cb28-113"></a>                                    <span class="st">&quot;_data_df_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.csv&quot;</span>))</span>
<span id="cb28-114"><a href="#cb28-114"></a></span>
<span id="cb28-115"><a href="#cb28-115"></a>  <span class="co"># saving the raster objects</span></span>
<span id="cb28-116"><a href="#cb28-116"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>ndvi_cent) <span class="sc">%&gt;%</span></span>
<span id="cb28-117"><a href="#cb28-117"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_ndvi_cent&quot;</span>,</span>
<span id="cb28-118"><a href="#cb28-118"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb28-119"><a href="#cb28-119"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb28-120"><a href="#cb28-120"></a></span>
<span id="cb28-121"><a href="#cb28-121"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>veg_herby_cent) <span class="sc">%&gt;%</span></span>
<span id="cb28-122"><a href="#cb28-122"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_herby_cent&quot;</span>,</span>
<span id="cb28-123"><a href="#cb28-123"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb28-124"><a href="#cb28-124"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb28-125"><a href="#cb28-125"></a></span>
<span id="cb28-126"><a href="#cb28-126"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>canopy_cover_cent) <span class="sc">%&gt;%</span></span>
<span id="cb28-127"><a href="#cb28-127"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_canopy_cent&quot;</span>,</span>
<span id="cb28-128"><a href="#cb28-128"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb28-129"><a href="#cb28-129"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb28-130"><a href="#cb28-130"></a></span>
<span id="cb28-131"><a href="#cb28-131"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>slope_cent) <span class="sc">%&gt;%</span></span>
<span id="cb28-132"><a href="#cb28-132"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_slope_cent&quot;</span>,</span>
<span id="cb28-133"><a href="#cb28-133"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb28-134"><a href="#cb28-134"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb28-135"><a href="#cb28-135"></a></span>
<span id="cb28-136"><a href="#cb28-136"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>pres_cent) <span class="sc">%&gt;%</span></span>
<span id="cb28-137"><a href="#cb28-137"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_pres_cent&quot;</span>,</span>
<span id="cb28-138"><a href="#cb28-138"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb28-139"><a href="#cb28-139"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb28-140"><a href="#cb28-140"></a>  </span>
<span id="cb28-141"><a href="#cb28-141"></a>}</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>38.25 sec elapsed
36.39 sec elapsed
38.11 sec elapsed
36.47 sec elapsed
37.87 sec elapsed
35.91 sec elapsed
36.51 sec elapsed
35.28 sec elapsed
36.29 sec elapsed
33.89 sec elapsed
34.1 sec elapsed
35.44 sec elapsed
36.75 sec elapsed</code></pre>
</div>
</div>
<section id="check-the-outputs" class="level2">
<h2>Check the outputs</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">head</span>(buffalo_data_covs)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":["x_"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["y_"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["t_"],"name":[3],"type":["dttm"],"align":["right"]},{"label":["id"],"name":[4],"type":["chr"],"align":["left"]},{"label":["x1_"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["y1_"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["x2_"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["y2_"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["x2_cent"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["y2_cent"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["t2_"],"name":[11],"type":["dttm"],"align":["right"]},{"label":["t_diff"],"name":[12],"type":["drtn"],"align":["right"]},{"label":["hour_t1"],"name":[13],"type":["int"],"align":["right"]},{"label":["yday_t1"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["hour_t2"],"name":[15],"type":["int"],"align":["right"]},{"label":["hour_t2_sin"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["hour_t2_cos"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["yday_t2"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["yday_t2_sin"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["yday_t2_cos"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["sl"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["log_sl"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["bearing"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["bearing_sin"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["bearing_cos"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["ta"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["cos_ta"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["x_min"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["x_max"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["y_min"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["y_max"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["extent_00centre"],"name":[32],"type":["list"],"align":["right"]},{"label":["ndvi_index"],"name":[33],"type":["int"],"align":["right"]},{"label":["ndvi_cent"],"name":[34],"type":["list"],"align":["right"]},{"label":["veg_herby_cent"],"name":[35],"type":["list"],"align":["right"]},{"label":["canopy_cover_cent"],"name":[36],"type":["list"],"align":["right"]},{"label":["slope_cent"],"name":[37],"type":["list"],"align":["right"]},{"label":["points_vect_cent"],"name":[38],"type":["list"],"align":["right"]},{"label":["pres_cent"],"name":[39],"type":["list"],"align":["right"]}],"data":[{"1":"32550.35","2":"-1423005","3":"2018-07-25 12:11:31.053162","4":"2393","5":"32550.35","6":"-1423005","7":"32550.67","8":"-1423009","9":"0.323102","10":"-4.3363236","11":"2018-07-25 13:10:28.053162","12":"1 hours","13":"12","14":"206","15":"13","16":"-0.2588190","17":"-9.659258e-01","18":"206","19":"-0.3913578","20":"-0.9202386","21":"4.348344","22":"1.4697951","23":"-1.4964232","24":"-0.9972356","25":"0.07430461","26":"-2.9443625","27":"-0.9806131","28":"31287.85","29":"33812.85","30":"-1424267","31":"-1421742","32":"<S4: SpatExtent>","33":"8","34":"<S4: SpatRaster>","35":"<S4: SpatRaster>","36":"<S4: SpatRaster>","37":"<S4: SpatRaster>","38":"<S4: SpatVector>","39":"<S4: SpatRaster>"},{"1":"32550.67","2":"-1423009","3":"2018-07-25 13:10:28.053162","4":"2393","5":"32550.67","6":"-1423009","7":"32549.54","8":"-1423008","9":"-1.130789","10":"0.9171712","11":"2018-07-25 14:11:04.000000","12":"1 hours","13":"13","14":"206","15":"14","16":"-0.5000000","17":"-8.660254e-01","18":"206","19":"-0.3913578","20":"-0.9202386","21":"1.455983","22":"0.3756815","23":"2.4601264","24":"0.6299325","25":"-0.77664991","26":"-2.3266358","27":"-0.6858998","28":"31288.17","29":"33813.17","30":"-1424272","31":"-1421747","32":"<S4: SpatExtent>","33":"8","34":"<S4: SpatRaster>","35":"<S4: SpatRaster>","36":"<S4: SpatRaster>","37":"<S4: SpatRaster>","38":"<S4: SpatVector>","39":"<S4: SpatRaster>"},{"1":"32549.54","2":"-1423008","3":"2018-07-25 14:11:04.000000","4":"2393","5":"32549.54","6":"-1423008","7":"32552.11","8":"-1423003","9":"2.567030","10":"5.3118617","11":"2018-07-25 15:12:01.000000","12":"1 hours","13":"14","14":"206","15":"15","16":"-0.7071068","17":"-7.071068e-01","18":"206","19":"-0.3913578","20":"-0.9202386","21":"5.899620","22":"1.7748879","23":"1.1206272","24":"0.9003735","25":"0.43511779","26":"-1.3394992","27":"0.2292403","28":"31287.04","29":"33812.04","30":"-1424271","31":"-1421746","32":"<S4: SpatExtent>","33":"8","34":"<S4: SpatRaster>","35":"<S4: SpatRaster>","36":"<S4: SpatRaster>","37":"<S4: SpatRaster>","38":"<S4: SpatVector>","39":"<S4: SpatRaster>"},{"1":"32552.11","2":"-1423003","3":"2018-07-25 15:12:01.000000","4":"2393","5":"32552.11","6":"-1423003","7":"32555.78","8":"-1423001","9":"3.670077","10":"2.0237395","11":"2018-07-25 16:10:49.000000","12":"1 hours","13":"15","14":"206","15":"16","16":"-0.8660254","17":"-5.000000e-01","18":"206","19":"-0.3913578","20":"-0.9202386","21":"4.191061","22":"1.4329538","23":"0.5039297","24":"0.4828705","25":"0.87569177","26":"-0.6166975","27":"0.8157929","28":"31289.61","29":"33814.61","30":"-1424266","31":"-1421741","32":"<S4: SpatExtent>","33":"8","34":"<S4: SpatRaster>","35":"<S4: SpatRaster>","36":"<S4: SpatRaster>","37":"<S4: SpatRaster>","38":"<S4: SpatVector>","39":"<S4: SpatRaster>"},{"1":"32555.78","2":"-1423001","3":"2018-07-25 16:10:49.000000","4":"2393","5":"32555.78","6":"-1423001","7":"32550.93","8":"-1422997","9":"-4.845028","10":"3.7710528","11":"2018-07-25 17:12:20.053162","12":"1 hours","13":"16","14":"206","15":"17","16":"-0.9659258","17":"-2.588190e-01","18":"206","19":"-0.3913578","20":"-0.9202386","21":"6.139636","22":"1.8147655","23":"2.4802027","24":"0.6142143","25":"-0.78913925","26":"1.9762729","27":"-0.3944568","28":"31293.28","29":"33818.28","30":"-1424264","31":"-1421739","32":"<S4: SpatExtent>","33":"8","34":"<S4: SpatRaster>","35":"<S4: SpatRaster>","36":"<S4: SpatRaster>","37":"<S4: SpatRaster>","38":"<S4: SpatVector>","39":"<S4: SpatRaster>"},{"1":"32550.93","2":"-1422997","3":"2018-07-25 17:12:20.053162","4":"2393","5":"32550.93","6":"-1422997","7":"32546.75","8":"-1423008","9":"-4.178376","10":"-10.4227241","11":"2018-07-25 18:10:23.053162","12":"1 hours","13":"17","14":"206","15":"18","16":"-1.0000000","17":"-1.836910e-16","18":"206","19":"-0.3913578","20":"-0.9202386","21":"11.229069","22":"2.4185059","23":"-1.9520705","24":"-0.9281913","25":"-0.37210348","26":"1.8509121","27":"-0.2764669","28":"31288.43","29":"33813.43","30":"-1424260","31":"-1421735","32":"<S4: SpatExtent>","33":"8","34":"<S4: SpatRaster>","35":"<S4: SpatRaster>","36":"<S4: SpatRaster>","37":"<S4: SpatRaster>","38":"<S4: SpatVector>","39":"<S4: SpatRaster>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">which</span>(<span class="fu">is.na</span>(buffalo_data_covs<span class="sc">$</span>ta))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>integer(0)</code></pre>
</div>
</div>
</section>
<section id="plot-a-subset-of-the-local-covariates" class="level2">
<h2>Plot a subset of the local covariates</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>n_plots <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="co"># NDVI</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>ndvi_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-3.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Herbaceous vegetation</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>veg_herby_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-4.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-5.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-6.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Canopy cover</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>canopy_cover_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-7.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-8.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-9.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># Slope</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>slope_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-10.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-11.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-12.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Target (location of the next step)</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>pres_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-13.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-14.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-12-15.png" class="img-fluid" /></p>
</figure>
</div>
</div>
</div>
</section>
<section id="to-save-the-object-with-all-of-the-local-covariates" class="level2">
<h2>To save the object with all of the local covariates</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># saveRDS(buffalo_data_covs, paste0(&quot;buffalo_data_id_covs_&quot;, Sys.Date(), &quot;.rds&quot;))</span></span></code></pre></div>
</details>
</div>
</section>
<section id="to-save-some-plots" class="level2">
<h2>To save some plots</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="co">#   png(filename = paste0(&quot;ndvi_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="co">#   terra::plot(buffalo_data_covs$ndvi_cent[[i]])</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="co">#   dev.off()</span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="co"># }</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="co"># </span></span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="co"># # for the pres layers</span></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="co">#   </span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="co">#   # change the 0 values to NA</span></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="co">#   layer &lt;- buffalo_data_covs$pres_cent[[i]]</span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="co">#   layer[layer == 0] &lt;- 0.5</span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="co">#   </span></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="co">#   ndvi_layer &lt;- buffalo_data_covs$ndvi_cent[[i]]</span></span>
<span id="cb39-16"><a href="#cb39-16"></a><span class="co">#   new_layer &lt;- layer*ndvi_layer</span></span>
<span id="cb39-17"><a href="#cb39-17"></a><span class="co">#   </span></span>
<span id="cb39-18"><a href="#cb39-18"></a><span class="co">#   # save the plot</span></span>
<span id="cb39-19"><a href="#cb39-19"></a><span class="co">#   png(filename = paste0(&quot;pres_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb39-20"><a href="#cb39-20"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb39-21"><a href="#cb39-21"></a><span class="co">#   terra::plot(new_layer)</span></span>
<span id="cb39-22"><a href="#cb39-22"></a><span class="co">#   dev.off()</span></span>
<span id="cb39-23"><a href="#cb39-23"></a><span class="co"># }</span></span>
<span id="cb39-24"><a href="#cb39-24"></a><span class="co"># </span></span>
<span id="cb39-25"><a href="#cb39-25"></a><span class="co"># </span></span>
<span id="cb39-26"><a href="#cb39-26"></a><span class="co"># # other plots</span></span>
<span id="cb39-27"><a href="#cb39-27"></a><span class="co"># </span></span>
<span id="cb39-28"><a href="#cb39-28"></a><span class="co"># n_plots &lt;- 1</span></span>
<span id="cb39-29"><a href="#cb39-29"></a><span class="co"># </span></span>
<span id="cb39-30"><a href="#cb39-30"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb39-31"><a href="#cb39-31"></a><span class="co">#   png(filename = paste0(&quot;veg_herby_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb39-32"><a href="#cb39-32"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb39-33"><a href="#cb39-33"></a><span class="co">#   terra::plot(buffalo_data_covs$veg_herby_cent[[i]])</span></span>
<span id="cb39-34"><a href="#cb39-34"></a><span class="co">#   dev.off()</span></span>
<span id="cb39-35"><a href="#cb39-35"></a><span class="co"># }</span></span>
<span id="cb39-36"><a href="#cb39-36"></a><span class="co"># </span></span>
<span id="cb39-37"><a href="#cb39-37"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb39-38"><a href="#cb39-38"></a><span class="co">#   png(filename = paste0(&quot;canopy_cover_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb39-39"><a href="#cb39-39"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb39-40"><a href="#cb39-40"></a><span class="co">#   terra::plot(buffalo_data_covs$canopy_cover_cent[[i]])</span></span>
<span id="cb39-41"><a href="#cb39-41"></a><span class="co">#   dev.off()</span></span>
<span id="cb39-42"><a href="#cb39-42"></a><span class="co"># }</span></span>
<span id="cb39-43"><a href="#cb39-43"></a><span class="co"># </span></span>
<span id="cb39-44"><a href="#cb39-44"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb39-45"><a href="#cb39-45"></a><span class="co">#   png(filename = paste0(&quot;slope_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb39-46"><a href="#cb39-46"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb39-47"><a href="#cb39-47"></a><span class="co">#   terra::plot(buffalo_data_covs$slope_cent[[i]])</span></span>
<span id="cb39-48"><a href="#cb39-48"></a><span class="co">#   dev.off()</span></span>
<span id="cb39-49"><a href="#cb39-49"></a><span class="co"># }</span></span></code></pre></div>
</details>
</div>
</section>
<section id="plot-the-step-lengths-and-turning-angles" class="level2">
<h2>Plot the step lengths and turning angles</h2>
<div class="cell">
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># plot step lengths</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>buffalo_data_covs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sl <span class="sc">&lt;</span> <span class="dv">2000</span>) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> sl), </span>
<span id="cb40-4"><a href="#cb40-4"></a>                 <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Step length (m)&quot;</span>) <span class="sc">+</span> <span class="co">#, limits = c(-25, 1250)</span></span>
<span id="cb40-6"><a href="#cb40-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Step lengths&quot;</span>) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># ggsave(&quot;outputs/step_length.png&quot;, height = 60, width = 120, units = &quot;mm&quot;, dpi = 600)</span></span>
<span id="cb41-2"><a href="#cb41-2"></a></span>
<span id="cb41-3"><a href="#cb41-3"></a></span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="co"># plot turning angles</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>buffalo_data_covs <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> ta), </span>
<span id="cb41-7"><a href="#cb41-7"></a>                 <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Turning angle (radians)&quot;</span>, </span>
<span id="cb41-9"><a href="#cb41-9"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span>pi, <span class="sc">-</span>pi<span class="sc">/</span><span class="dv">2</span>, <span class="dv">0</span>, pi<span class="sc">/</span><span class="dv">2</span>, pi),</span>
<span id="cb41-10"><a href="#cb41-10"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="fu">expression</span>(<span class="sc">-</span>pi), <span class="fu">expression</span>(<span class="sc">-</span>pi<span class="sc">/</span><span class="dv">2</span>), <span class="st">&quot;0&quot;</span>, <span class="fu">expression</span>(pi<span class="sc">/</span><span class="dv">2</span>), <span class="fu">expression</span>(pi))</span>
<span id="cb41-11"><a href="#cb41-11"></a>  ) <span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-13"><a href="#cb41-13"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Turning angles&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-14"><a href="#cb41-14"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img src="deepSSF_data_prep_id_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid" /></p>
</figure>
</div>
</div>
<details open class="code-fold">
<summary>Code</summary>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource r cell-code number-lines"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># ggsave(&quot;outputs/turning_angle.png&quot;, height = 60, width = 120, units = &quot;mm&quot;, dpi = 600)  </span></span></code></pre></div>
</details>
</div>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1zaWRlYmFyLXRpdGxl">deepSSF</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXItdGl0bGU=">deepSSF</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6SG9tZQ==">Home</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2luZGV4Lmh0bWw=">/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6QWJvdXQ=">About</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2Fib3V0Lmh0bWw=">/about.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6aHR0cHM6Ly9naXRodWIuY29tL3N3Zm9ycmVzdC9kZWVwU1NG">https://github.com/swforrest/deepSSF</span></p>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW1ldGF0aXRsZQ==">Preparing data for deepSSF model fitting – deepSSF</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLXR3aXR0ZXJjYXJkdGl0bGU=">Preparing data for deepSSF model fitting – deepSSF</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW9nY2FyZHRpdGxl">Preparing data for deepSSF model fitting – deepSSF</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW1ldGFzaXRlbmFtZQ==">deepSSF</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLXR3aXR0ZXJjYXJkZGVzYw==">Here we prepare the data for fitting a deepSSF model. We load the GPS dataand tidy it, create a trajectory object containing a series of steps and read in the environmental layers. For each observed step we crop out local subsets of the environmental layers, centred on the step’s location. For every step we will then have the surrounding environmental information stored as a stack of small rasters, with the ‘target’ of what we’re trying to predict (the actual location of the next step) as a raster layer as well, with all cells being 0 except the observed next location, which is 1. These, along with temporal covariates and the previous bearing, will be the input data for the deepSSF model.</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW9nY2FyZGRkZXNj">Here we prepare the data for fitting a deepSSF model. We load the GPS dataand tidy it, create a trajectory object containing a series of steps and read in the environmental layers. For each observed step we crop out local subsets of the environmental layers, centred on the step’s location. For every step we will then have the surrounding environmental information stored as a stack of small rasters, with the ‘target’ of what we’re trying to predict (the actual location of the next step) as a raster layer as well, with all cells being 0 except the observed next location, which is 1. These, along with temporal covariates and the previous bearing, will be the input data for the deepSSF model.</span></p>
</div>
<!-- -->
<div class="quarto-embedded-source-code">
<div class="sourceCode" id="cb43" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines"><code class="sourceCode markdown"><span id="cb43-1"><a href="#cb43-1"></a><span class="co">---</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="an">title:</span><span class="co"> &quot;Preparing data for deepSSF model fitting&quot;</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="an">author:</span><span class="co"> &quot;Scott Forrest&quot;</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="an">date:</span><span class="co"> &quot;`r Sys.Date()`&quot;</span></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb43-6"><a href="#cb43-6"></a><span class="co">  cache: false</span></span>
<span id="cb43-7"><a href="#cb43-7"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb43-9"><a href="#cb43-9"></a><span class="an">number-sections:</span><span class="co"> false</span></span>
<span id="cb43-10"><a href="#cb43-10"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb43-11"><a href="#cb43-11"></a><span class="co">  html:</span></span>
<span id="cb43-12"><a href="#cb43-12"></a><span class="co">    self-contained: true</span></span>
<span id="cb43-13"><a href="#cb43-13"></a><span class="co">    code-fold: show</span></span>
<span id="cb43-14"><a href="#cb43-14"></a><span class="co">    code-tools: true</span></span>
<span id="cb43-15"><a href="#cb43-15"></a><span class="co">    df-print: paged</span></span>
<span id="cb43-16"><a href="#cb43-16"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb43-17"><a href="#cb43-17"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb43-18"><a href="#cb43-18"></a><span class="co">    fig-format: png</span></span>
<span id="cb43-19"><a href="#cb43-19"></a><span class="co">    fig-dpi: 300</span></span>
<span id="cb43-20"><a href="#cb43-20"></a><span class="co">  pdf:</span></span>
<span id="cb43-21"><a href="#cb43-21"></a><span class="co">    geometry: </span></span>
<span id="cb43-22"><a href="#cb43-22"></a><span class="co">      - top=30mm</span></span>
<span id="cb43-23"><a href="#cb43-23"></a><span class="co">      - left=30mm</span></span>
<span id="cb43-24"><a href="#cb43-24"></a><span class="an">editor:</span></span>
<span id="cb43-25"><a href="#cb43-25"></a><span class="co">  source</span></span>
<span id="cb43-26"><a href="#cb43-26"></a><span class="an">abstract:</span><span class="co"> |</span></span>
<span id="cb43-27"><a href="#cb43-27"></a><span class="co">  Here we prepare the data for fitting a deepSSF model. We load the GPS dataand tidy it, create a trajectory object containing a series of steps and read in the environmental layers. For each observed step we crop out local subsets of the environmental layers, centred on the step&#39;s location. For every step we will then have the surrounding environmental information stored as a stack of small rasters, with the &#39;target&#39; of what we&#39;re trying to predict (the actual location of the next step) as a raster layer as well, with all cells being 0 except the observed next location, which is 1. These, along with temporal covariates and the previous bearing, will be the input data for the deepSSF model.</span></span>
<span id="cb43-28"><a href="#cb43-28"></a><span class="co">---</span></span>
<span id="cb43-29"><a href="#cb43-29"></a></span>
<span id="cb43-30"><a href="#cb43-30"></a><span class="fu">## Loading packages</span></span>
<span id="cb43-31"><a href="#cb43-31"></a></span>
<span id="cb43-32"><a href="#cb43-32"></a>quarto-executable-code-5450563D</span>
<span id="cb43-33"><a href="#cb43-33"></a></span>
<span id="cb43-34"><a href="#cb43-34"></a><span class="in">```r</span></span>
<span id="cb43-35"><a href="#cb43-35"></a><span class="co">#| warning=FALSE</span></span>
<span id="cb43-36"><a href="#cb43-36"></a></span>
<span id="cb43-37"><a href="#cb43-37"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb43-38"><a href="#cb43-38"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;amt&quot;</span>, <span class="st">&quot;sf&quot;</span>, <span class="st">&quot;terra&quot;</span>, <span class="st">&quot;beepr&quot;</span>, <span class="st">&quot;tictoc&quot;</span>)</span>
<span id="cb43-39"><a href="#cb43-39"></a><span class="fu">walk</span>(packages, require, <span class="at">character.only =</span> T)</span>
<span id="cb43-40"><a href="#cb43-40"></a></span>
<span id="cb43-41"><a href="#cb43-41"></a><span class="in">```</span></span>
<span id="cb43-42"><a href="#cb43-42"></a></span>
<span id="cb43-43"><a href="#cb43-43"></a><span class="fu">## Import data</span></span>
<span id="cb43-44"><a href="#cb43-44"></a></span>
<span id="cb43-45"><a href="#cb43-45"></a>quarto-executable-code-5450563D</span>
<span id="cb43-46"><a href="#cb43-46"></a></span>
<span id="cb43-47"><a href="#cb43-47"></a><span class="in">```r</span></span>
<span id="cb43-48"><a href="#cb43-48"></a>buffalo <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/buffalo.csv&quot;</span>)</span>
<span id="cb43-49"><a href="#cb43-49"></a><span class="fu">head</span>(buffalo)</span>
<span id="cb43-50"><a href="#cb43-50"></a></span>
<span id="cb43-51"><a href="#cb43-51"></a><span class="in">```</span></span>
<span id="cb43-52"><a href="#cb43-52"></a></span>
<span id="cb43-53"><a href="#cb43-53"></a><span class="fu">## Tidy data</span></span>
<span id="cb43-54"><a href="#cb43-54"></a></span>
<span id="cb43-55"><a href="#cb43-55"></a>quarto-executable-code-5450563D</span>
<span id="cb43-56"><a href="#cb43-56"></a></span>
<span id="cb43-57"><a href="#cb43-57"></a><span class="in">```r</span></span>
<span id="cb43-58"><a href="#cb43-58"></a><span class="co"># remove individuals that have poor data quality or less than about 3 months of data. </span></span>
<span id="cb43-59"><a href="#cb43-59"></a><span class="co"># The &quot;2014.GPS_COMPACT copy.csv&quot; string is a duplicate of ID 2024, so we also exclude it</span></span>
<span id="cb43-60"><a href="#cb43-60"></a>buffalo <span class="ot">&lt;-</span> buffalo <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>node <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;2014.GPS_COMPACT copy.csv&quot;</span>, </span>
<span id="cb43-61"><a href="#cb43-61"></a>                                           <span class="co"># 2005, 2014, 2018, 2021, 2022, 2024,</span></span>
<span id="cb43-62"><a href="#cb43-62"></a>                                           <span class="dv">2029</span>, <span class="dv">2043</span>, <span class="dv">2265</span>, <span class="dv">2284</span>, <span class="dv">2346</span>, <span class="dv">2354</span>))</span>
<span id="cb43-63"><a href="#cb43-63"></a></span>
<span id="cb43-64"><a href="#cb43-64"></a><span class="co"># arrange by time and exclude any duplicate timestamps (within the same individual&#39;s data)</span></span>
<span id="cb43-65"><a href="#cb43-65"></a>buffalo <span class="ot">&lt;-</span> buffalo <span class="sc">%&gt;%</span>  </span>
<span id="cb43-66"><a href="#cb43-66"></a>  <span class="fu">group_by</span>(node) <span class="sc">%&gt;%</span> </span>
<span id="cb43-67"><a href="#cb43-67"></a>  <span class="fu">arrange</span>(DateTime, <span class="at">.by_group =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb43-68"><a href="#cb43-68"></a>  <span class="fu">distinct</span>(DateTime, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb43-69"><a href="#cb43-69"></a>  <span class="fu">arrange</span>(node) <span class="sc">%&gt;%</span> </span>
<span id="cb43-70"><a href="#cb43-70"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> node)</span>
<span id="cb43-71"><a href="#cb43-71"></a></span>
<span id="cb43-72"><a href="#cb43-72"></a><span class="co"># keep only the relevant columns</span></span>
<span id="cb43-73"><a href="#cb43-73"></a>buffalo_clean <span class="ot">&lt;-</span> buffalo[, <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>)]</span>
<span id="cb43-74"><a href="#cb43-74"></a></span>
<span id="cb43-75"><a href="#cb43-75"></a><span class="co"># rename the columns</span></span>
<span id="cb43-76"><a href="#cb43-76"></a><span class="fu">colnames</span>(buffalo_clean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span>
<span id="cb43-77"><a href="#cb43-77"></a></span>
<span id="cb43-78"><a href="#cb43-78"></a><span class="co"># convert the time to the correct timezone</span></span>
<span id="cb43-79"><a href="#cb43-79"></a><span class="fu">attr</span>(buffalo_clean<span class="sc">$</span>time, <span class="st">&quot;tzone&quot;</span>) <span class="ot">&lt;-</span> <span class="st">&quot;Australia/Queensland&quot;</span></span>
<span id="cb43-80"><a href="#cb43-80"></a><span class="fu">head</span>(buffalo_clean)</span>
<span id="cb43-81"><a href="#cb43-81"></a></span>
<span id="cb43-82"><a href="#cb43-82"></a><span class="co"># check timezone</span></span>
<span id="cb43-83"><a href="#cb43-83"></a><span class="fu">tz</span>(buffalo_clean<span class="sc">$</span>time)</span>
<span id="cb43-84"><a href="#cb43-84"></a></span>
<span id="cb43-85"><a href="#cb43-85"></a><span class="co"># create a vector of the unique ids for indexing later</span></span>
<span id="cb43-86"><a href="#cb43-86"></a>buffalo_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(buffalo_clean<span class="sc">$</span>id)</span>
<span id="cb43-87"><a href="#cb43-87"></a></span>
<span id="cb43-88"><a href="#cb43-88"></a><span class="in">```</span></span>
<span id="cb43-89"><a href="#cb43-89"></a></span>
<span id="cb43-90"><a href="#cb43-90"></a><span class="fu">## Setup trajectory</span></span>
<span id="cb43-91"><a href="#cb43-91"></a></span>
<span id="cb43-92"><a href="#cb43-92"></a>Use the <span class="in">`amt`</span> package to create a trajectory object from the cleaned data. </span>
<span id="cb43-93"><a href="#cb43-93"></a></span>
<span id="cb43-94"><a href="#cb43-94"></a>quarto-executable-code-5450563D</span>
<span id="cb43-95"><a href="#cb43-95"></a></span>
<span id="cb43-96"><a href="#cb43-96"></a><span class="in">```r</span></span>
<span id="cb43-97"><a href="#cb43-97"></a>buffalo_all <span class="ot">&lt;-</span> buffalo_clean <span class="sc">%&gt;%</span> <span class="fu">mk_track</span>(<span class="at">id =</span> id,</span>
<span id="cb43-98"><a href="#cb43-98"></a>                                          lon,</span>
<span id="cb43-99"><a href="#cb43-99"></a>                                          lat, </span>
<span id="cb43-100"><a href="#cb43-100"></a>                                          time, </span>
<span id="cb43-101"><a href="#cb43-101"></a>                                          <span class="at">all_cols =</span> T,</span>
<span id="cb43-102"><a href="#cb43-102"></a>                                          <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-103"><a href="#cb43-103"></a>  <span class="co"># Transformation to GDA94 / Geoscience Australia Lambert (https://epsg.io/3112)</span></span>
<span id="cb43-104"><a href="#cb43-104"></a>  <span class="fu">transform_coords</span>(<span class="at">crs_to =</span> <span class="dv">3112</span>, <span class="at">crs_from =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id) </span>
<span id="cb43-105"><a href="#cb43-105"></a></span>
<span id="cb43-106"><a href="#cb43-106"></a><span class="in">```</span></span>
<span id="cb43-107"><a href="#cb43-107"></a></span>
<span id="cb43-108"><a href="#cb43-108"></a><span class="fu">## Plot the data coloured by time</span></span>
<span id="cb43-109"><a href="#cb43-109"></a></span>
<span id="cb43-110"><a href="#cb43-110"></a>quarto-executable-code-5450563D</span>
<span id="cb43-111"><a href="#cb43-111"></a></span>
<span id="cb43-112"><a href="#cb43-112"></a><span class="in">```r</span></span>
<span id="cb43-113"><a href="#cb43-113"></a>buffalo_all <span class="sc">%&gt;%</span></span>
<span id="cb43-114"><a href="#cb43-114"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x_, <span class="at">y =</span> y_, <span class="at">colour =</span> t_)) <span class="sc">+</span></span>
<span id="cb43-115"><a href="#cb43-115"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb43-116"><a href="#cb43-116"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb43-117"><a href="#cb43-117"></a>  <span class="fu">scale_colour_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb43-118"><a href="#cb43-118"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb43-119"><a href="#cb43-119"></a></span>
<span id="cb43-120"><a href="#cb43-120"></a><span class="in">```</span></span>
<span id="cb43-121"><a href="#cb43-121"></a></span>
<span id="cb43-122"><a href="#cb43-122"></a><span class="fu">## Read in the environmental covariates</span></span>
<span id="cb43-123"><a href="#cb43-123"></a></span>
<span id="cb43-124"><a href="#cb43-124"></a>quarto-executable-code-5450563D</span>
<span id="cb43-125"><a href="#cb43-125"></a></span>
<span id="cb43-126"><a href="#cb43-126"></a><span class="in">```r</span></span>
<span id="cb43-127"><a href="#cb43-127"></a>ndvi_projected <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/ndvi_GEE_projected_watermask20230207.tif&quot;</span>)</span>
<span id="cb43-128"><a href="#cb43-128"></a>terra<span class="sc">::</span><span class="fu">time</span>(ndvi_projected) <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(lubridate<span class="sc">::</span><span class="fu">ymd</span>(<span class="st">&quot;2018-01-01&quot;</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">23</span>))</span>
<span id="cb43-129"><a href="#cb43-129"></a>slope <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/slope_raster.tif&quot;</span>)</span>
<span id="cb43-130"><a href="#cb43-130"></a>veg_herby <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/veg_herby.tif&quot;</span>)</span>
<span id="cb43-131"><a href="#cb43-131"></a>canopy_cover <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;mapping/cropped rasters/canopy_cover.tif&quot;</span>)</span>
<span id="cb43-132"><a href="#cb43-132"></a></span>
<span id="cb43-133"><a href="#cb43-133"></a><span class="co"># change the names (these will become the column names when extracting </span></span>
<span id="cb43-134"><a href="#cb43-134"></a><span class="co"># covariate values at the used and random steps)</span></span>
<span id="cb43-135"><a href="#cb43-135"></a><span class="fu">names</span>(ndvi_projected) <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;ndvi&quot;</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(ndvi_projected))</span>
<span id="cb43-136"><a href="#cb43-136"></a><span class="fu">names</span>(slope) <span class="ot">&lt;-</span> <span class="st">&quot;slope&quot;</span></span>
<span id="cb43-137"><a href="#cb43-137"></a><span class="fu">names</span>(veg_herby) <span class="ot">&lt;-</span> <span class="st">&quot;veg_herby&quot;</span></span>
<span id="cb43-138"><a href="#cb43-138"></a><span class="fu">names</span>(canopy_cover) <span class="ot">&lt;-</span> <span class="st">&quot;canopy_cover&quot;</span></span>
<span id="cb43-139"><a href="#cb43-139"></a></span>
<span id="cb43-140"><a href="#cb43-140"></a><span class="co"># to plot the rasters</span></span>
<span id="cb43-141"><a href="#cb43-141"></a><span class="fu">plot</span>(ndvi_projected)</span>
<span id="cb43-142"><a href="#cb43-142"></a><span class="fu">plot</span>(ndvi_projected[[<span class="dv">1</span>]])</span>
<span id="cb43-143"><a href="#cb43-143"></a><span class="fu">plot</span>(slope)</span>
<span id="cb43-144"><a href="#cb43-144"></a><span class="fu">plot</span>(veg_herby)</span>
<span id="cb43-145"><a href="#cb43-145"></a><span class="fu">plot</span>(canopy_cover)</span>
<span id="cb43-146"><a href="#cb43-146"></a></span>
<span id="cb43-147"><a href="#cb43-147"></a><span class="co"># get the resolution from the covariates</span></span>
<span id="cb43-148"><a href="#cb43-148"></a>res <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">res</span>(ndvi_projected)[<span class="dv">1</span>]</span>
<span id="cb43-149"><a href="#cb43-149"></a></span>
<span id="cb43-150"><a href="#cb43-150"></a><span class="in">```</span></span>
<span id="cb43-151"><a href="#cb43-151"></a></span>
<span id="cb43-152"><a href="#cb43-152"></a><span class="fu"># Generating the data to fit a deepSSF model</span></span>
<span id="cb43-153"><a href="#cb43-153"></a></span>
<span id="cb43-154"><a href="#cb43-154"></a><span class="fu">## Create a steps object to check the step lengths</span></span>
<span id="cb43-155"><a href="#cb43-155"></a></span>
<span id="cb43-156"><a href="#cb43-156"></a>quarto-executable-code-5450563D</span>
<span id="cb43-157"><a href="#cb43-157"></a></span>
<span id="cb43-158"><a href="#cb43-158"></a><span class="in">```r</span></span>
<span id="cb43-159"><a href="#cb43-159"></a><span class="co"># nest the data by individual</span></span>
<span id="cb43-160"><a href="#cb43-160"></a>buffalo_all_nested <span class="ot">&lt;-</span> buffalo_all <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id) <span class="sc">%&gt;%</span> <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span><span class="st">&quot;id&quot;</span>)</span>
<span id="cb43-161"><a href="#cb43-161"></a></span>
<span id="cb43-162"><a href="#cb43-162"></a>buffalo_all_nested_steps <span class="ot">&lt;-</span> buffalo_all_nested <span class="sc">%&gt;%</span></span>
<span id="cb43-163"><a href="#cb43-163"></a>  <span class="fu">mutate</span>(<span class="at">steps =</span> <span class="fu">map</span>(data, <span class="cf">function</span>(x)</span>
<span id="cb43-164"><a href="#cb43-164"></a>    x <span class="sc">%&gt;%</span> </span>
<span id="cb43-165"><a href="#cb43-165"></a>      <span class="co"># track_resample(rate = hours(1), tolerance = minutes(10)) %&gt;%</span></span>
<span id="cb43-166"><a href="#cb43-166"></a>      <span class="fu">steps</span>()))</span>
<span id="cb43-167"><a href="#cb43-167"></a></span>
<span id="cb43-168"><a href="#cb43-168"></a><span class="co"># unnest the data after creating &#39;steps&#39; objects</span></span>
<span id="cb43-169"><a href="#cb43-169"></a>buffalo_all_steps <span class="ot">&lt;-</span> buffalo_all_nested_steps <span class="sc">%&gt;%</span> </span>
<span id="cb43-170"><a href="#cb43-170"></a>  amt<span class="sc">::</span><span class="fu">select</span>(id, steps) <span class="sc">%&gt;%</span> </span>
<span id="cb43-171"><a href="#cb43-171"></a>  amt<span class="sc">::</span><span class="fu">unnest</span>(<span class="at">cols =</span> steps)</span>
<span id="cb43-172"><a href="#cb43-172"></a></span>
<span id="cb43-173"><a href="#cb43-173"></a><span class="fu">head</span>(buffalo_all_steps)</span>
<span id="cb43-174"><a href="#cb43-174"></a></span>
<span id="cb43-175"><a href="#cb43-175"></a><span class="in">```</span></span>
<span id="cb43-176"><a href="#cb43-176"></a></span>
<span id="cb43-177"><a href="#cb43-177"></a><span class="fu">### Plot step lengths</span></span>
<span id="cb43-178"><a href="#cb43-178"></a></span>
<span id="cb43-179"><a href="#cb43-179"></a>quarto-executable-code-5450563D</span>
<span id="cb43-180"><a href="#cb43-180"></a></span>
<span id="cb43-181"><a href="#cb43-181"></a><span class="in">```r</span></span>
<span id="cb43-182"><a href="#cb43-182"></a><span class="co"># plot step lengths</span></span>
<span id="cb43-183"><a href="#cb43-183"></a>buffalo_all_steps <span class="sc">%&gt;%</span> </span>
<span id="cb43-184"><a href="#cb43-184"></a>  <span class="fu">filter</span>(sl_ <span class="sc">&lt;</span> <span class="dv">2000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-185"><a href="#cb43-185"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb43-186"><a href="#cb43-186"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> sl_), <span class="co">#, bins = 50</span></span>
<span id="cb43-187"><a href="#cb43-187"></a>                 <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb43-188"><a href="#cb43-188"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Step length (m)&quot;</span>) <span class="sc">+</span> <span class="co">#, limits = c(-25, 1250)</span></span>
<span id="cb43-189"><a href="#cb43-189"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-190"><a href="#cb43-190"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Step lengths&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-191"><a href="#cb43-191"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb43-192"><a href="#cb43-192"></a></span>
<span id="cb43-193"><a href="#cb43-193"></a><span class="co"># proportion of steps less than the buffer distance</span></span>
<span id="cb43-194"><a href="#cb43-194"></a><span class="co"># the distance should be a multiple of the resolution</span></span>
<span id="cb43-195"><a href="#cb43-195"></a>distance <span class="ot">&lt;-</span> <span class="dv">1250</span></span>
<span id="cb43-196"><a href="#cb43-196"></a></span>
<span id="cb43-197"><a href="#cb43-197"></a><span class="co"># check if multiple of the resolution?</span></span>
<span id="cb43-198"><a href="#cb43-198"></a>distance <span class="sc">%%</span> res <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb43-199"><a href="#cb43-199"></a></span>
<span id="cb43-200"><a href="#cb43-200"></a><span class="co"># buffer distance (add the resolution of the cell/2 as we want a centre cell)</span></span>
<span id="cb43-201"><a href="#cb43-201"></a>buffer <span class="ot">&lt;-</span> <span class="dv">1250</span> <span class="sc">+</span> (res<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb43-202"><a href="#cb43-202"></a></span>
<span id="cb43-203"><a href="#cb43-203"></a><span class="co"># calculate proportion</span></span>
<span id="cb43-204"><a href="#cb43-204"></a>prop_steps <span class="ot">&lt;-</span> buffalo_all_steps <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sl_ <span class="sc">&lt;</span> buffer) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span> buffalo_all_steps <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb43-205"><a href="#cb43-205"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Proportion of steps less than &quot;</span>, buffer, <span class="st">&quot;m: &quot;</span>, <span class="fu">round</span>(prop_steps, <span class="dv">4</span>)))</span>
<span id="cb43-206"><a href="#cb43-206"></a></span>
<span id="cb43-207"><a href="#cb43-207"></a><span class="co"># distance to the corner</span></span>
<span id="cb43-208"><a href="#cb43-208"></a>corner_dist <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(buffer<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> buffer<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb43-209"><a href="#cb43-209"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Distance to the corner: &quot;</span>, <span class="fu">round</span>(corner_dist, <span class="dv">2</span>)))</span>
<span id="cb43-210"><a href="#cb43-210"></a></span>
<span id="cb43-211"><a href="#cb43-211"></a><span class="in">```</span></span>
<span id="cb43-212"><a href="#cb43-212"></a>In our case 95% of the steps were less than a distance of 1262.5m, which would mean that including 101 x 101 cells (which would be 2525 m x 2525 m) would include at least 95% of the steps. </span>
<span id="cb43-213"><a href="#cb43-213"></a></span>
<span id="cb43-214"><a href="#cb43-214"></a>Note: as 1262.5 m is the shortest distance to the boundary, and it is further to a corner (which is 1786 m away), which means we will actually be including more than 95% of the steps.</span>
<span id="cb43-215"><a href="#cb43-215"></a></span>
<span id="cb43-216"><a href="#cb43-216"></a><span class="fu">## Set up the spatial extent of the local covariates</span></span>
<span id="cb43-217"><a href="#cb43-217"></a></span>
<span id="cb43-218"><a href="#cb43-218"></a>We calculate the number of cells in each axis, and set the lag between locations. Typically this will just be 1, as we want the next-step to be the target. However, it may be possible to improve model training by using different lags and including the time difference between locations as a covariate. I expect that this would help to predict across different time scales and not be restricted to the time scale that the data was collected at.</span>
<span id="cb43-219"><a href="#cb43-219"></a></span>
<span id="cb43-220"><a href="#cb43-220"></a>quarto-executable-code-5450563D</span>
<span id="cb43-221"><a href="#cb43-221"></a></span>
<span id="cb43-222"><a href="#cb43-222"></a><span class="in">```r</span></span>
<span id="cb43-223"><a href="#cb43-223"></a><span class="co"># calculate the number of cells in each axis</span></span>
<span id="cb43-224"><a href="#cb43-224"></a>nxn_cells <span class="ot">&lt;-</span> buffer<span class="sc">*</span><span class="dv">2</span><span class="sc">/</span>res</span>
<span id="cb43-225"><a href="#cb43-225"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Number of cells in each axis: &quot;</span>, nxn_cells))</span>
<span id="cb43-226"><a href="#cb43-226"></a></span>
<span id="cb43-227"><a href="#cb43-227"></a><span class="co"># hourly lag - to set larger time differences between locations</span></span>
<span id="cb43-228"><a href="#cb43-228"></a>hourly_lag <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb43-229"><a href="#cb43-229"></a></span>
<span id="cb43-230"><a href="#cb43-230"></a><span class="in">```</span></span>
<span id="cb43-231"><a href="#cb43-231"></a></span>
<span id="cb43-232"><a href="#cb43-232"></a><span class="fu"># Loop over each individual and save the local rasters</span></span>
<span id="cb43-233"><a href="#cb43-233"></a></span>
<span id="cb43-234"><a href="#cb43-234"></a>This is the main function of the script. It loops over each individual and calculates step level information, such as the location and time of the next step (x2, y2, t2), step length, turning angle, and different time components. </span>
<span id="cb43-235"><a href="#cb43-235"></a></span>
<span id="cb43-236"><a href="#cb43-236"></a>It also determines where to crop the local layers by subtracting and adding the buffer distance from the location of each step. It then crops out the local layers for each step and saves them as a list entry into the data frame. </span>
<span id="cb43-237"><a href="#cb43-237"></a></span>
<span id="cb43-238"><a href="#cb43-238"></a>It then creates a raster stack (with the number of layers equal to the number of steps) for each covariate and saves it as a tif.</span>
<span id="cb43-239"><a href="#cb43-239"></a></span>
<span id="cb43-240"><a href="#cb43-240"></a>For each individual, this will therefore create a csv containing the step level information, and a tif for each covariate containing the local layers for each step. </span>
<span id="cb43-241"><a href="#cb43-241"></a></span>
<span id="cb43-242"><a href="#cb43-242"></a>It takes quite a while to run, around 1 hour per individual in our case, so we will illustrate the function with 10 steps per individual. Uncomment the line specified in the loop to use the full dataset.</span>
<span id="cb43-243"><a href="#cb43-243"></a></span>
<span id="cb43-244"><a href="#cb43-244"></a></span>
<span id="cb43-245"><a href="#cb43-245"></a>quarto-executable-code-5450563D</span>
<span id="cb43-246"><a href="#cb43-246"></a></span>
<span id="cb43-247"><a href="#cb43-247"></a><span class="in">```r</span></span>
<span id="cb43-248"><a href="#cb43-248"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(buffalo_ids)) {</span>
<span id="cb43-249"><a href="#cb43-249"></a></span>
<span id="cb43-250"><a href="#cb43-250"></a>  buffalo_data <span class="ot">&lt;-</span> buffalo_all <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">==</span> buffalo_ids[i])</span>
<span id="cb43-251"><a href="#cb43-251"></a>  <span class="co"># all data for that individual</span></span>
<span id="cb43-252"><a href="#cb43-252"></a>  buffalo_data <span class="ot">&lt;-</span> buffalo_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(t_)</span>
<span id="cb43-253"><a href="#cb43-253"></a>  </span>
<span id="cb43-254"><a href="#cb43-254"></a>  <span class="co"># to use a subset of the data for that individual for testing</span></span>
<span id="cb43-255"><a href="#cb43-255"></a>  <span class="co"># COMMENT THIS LINE OUT TO USE THE FULL DATASET</span></span>
<span id="cb43-256"><a href="#cb43-256"></a>  buffalo_data <span class="ot">&lt;-</span> buffalo_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(t_) <span class="sc">|&gt;</span>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb43-257"><a href="#cb43-257"></a></span>
<span id="cb43-258"><a href="#cb43-258"></a>  n_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(buffalo_data)</span>
<span id="cb43-259"><a href="#cb43-259"></a>  </span>
<span id="cb43-260"><a href="#cb43-260"></a>  <span class="fu">tic</span>()</span>
<span id="cb43-261"><a href="#cb43-261"></a>  </span>
<span id="cb43-262"><a href="#cb43-262"></a>  buffalo_data_covs <span class="ot">&lt;-</span> buffalo_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb43-263"><a href="#cb43-263"></a>    </span>
<span id="cb43-264"><a href="#cb43-264"></a>    <span class="at">x1_ =</span> x_,</span>
<span id="cb43-265"><a href="#cb43-265"></a>    <span class="at">y1_ =</span> y_,</span>
<span id="cb43-266"><a href="#cb43-266"></a>    <span class="at">x2_ =</span> <span class="fu">lead</span>(x1_, <span class="at">n =</span> hourly_lag, <span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb43-267"><a href="#cb43-267"></a>    <span class="at">y2_ =</span> <span class="fu">lead</span>(y1_, <span class="at">n =</span> hourly_lag, <span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb43-268"><a href="#cb43-268"></a>    <span class="at">x2_cent =</span> x2_ <span class="sc">-</span> x1_,</span>
<span id="cb43-269"><a href="#cb43-269"></a>    <span class="at">y2_cent =</span> y2_ <span class="sc">-</span> y1_,</span>
<span id="cb43-270"><a href="#cb43-270"></a>    <span class="at">t2_ =</span> <span class="fu">lead</span>(t_, <span class="at">n =</span> hourly_lag, <span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb43-271"><a href="#cb43-271"></a>    <span class="at">t_diff =</span> <span class="fu">round</span>(<span class="fu">difftime</span>(t2_, t_, <span class="at">units =</span> <span class="st">&quot;hours&quot;</span>),<span class="dv">0</span>),</span>
<span id="cb43-272"><a href="#cb43-272"></a>    <span class="at">hour_t1 =</span> lubridate<span class="sc">::</span><span class="fu">hour</span>(t_),</span>
<span id="cb43-273"><a href="#cb43-273"></a>    <span class="at">yday_t1 =</span> lubridate<span class="sc">::</span><span class="fu">yday</span>(t_),</span>
<span id="cb43-274"><a href="#cb43-274"></a>    <span class="at">hour_t2 =</span> lubridate<span class="sc">::</span><span class="fu">hour</span>(t2_),</span>
<span id="cb43-275"><a href="#cb43-275"></a>    <span class="at">hour_t2_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>hour_t2<span class="sc">/</span><span class="dv">24</span>),</span>
<span id="cb43-276"><a href="#cb43-276"></a>    <span class="at">hour_t2_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>hour_t2<span class="sc">/</span><span class="dv">24</span>),</span>
<span id="cb43-277"><a href="#cb43-277"></a>    <span class="at">yday_t2 =</span> lubridate<span class="sc">::</span><span class="fu">yday</span>(t2_),</span>
<span id="cb43-278"><a href="#cb43-278"></a>    <span class="at">yday_t2_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>yday_t2<span class="sc">/</span><span class="fl">365.25</span>),</span>
<span id="cb43-279"><a href="#cb43-279"></a>    <span class="at">yday_t2_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>yday_t2<span class="sc">/</span><span class="fl">365.25</span>),</span>
<span id="cb43-280"><a href="#cb43-280"></a>    </span>
<span id="cb43-281"><a href="#cb43-281"></a>    <span class="at">sl =</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(<span class="fu">diff</span>(y_)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">diff</span>(x_)<span class="sc">^</span><span class="dv">2</span>), <span class="cn">NA</span>),</span>
<span id="cb43-282"><a href="#cb43-282"></a>    <span class="at">log_sl =</span> <span class="fu">log</span>(sl),</span>
<span id="cb43-283"><a href="#cb43-283"></a>    <span class="at">bearing =</span> <span class="fu">c</span>(<span class="fu">atan2</span>(<span class="fu">diff</span>(y_), <span class="fu">diff</span>(x_)), <span class="cn">NA</span>),</span>
<span id="cb43-284"><a href="#cb43-284"></a>    <span class="at">bearing_sin =</span> <span class="fu">sin</span>(bearing),</span>
<span id="cb43-285"><a href="#cb43-285"></a>    <span class="at">bearing_cos =</span> <span class="fu">cos</span>(bearing),</span>
<span id="cb43-286"><a href="#cb43-286"></a>    <span class="at">ta =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">ifelse</span>(</span>
<span id="cb43-287"><a href="#cb43-287"></a>      <span class="fu">diff</span>(bearing) <span class="sc">&gt;</span> pi, <span class="fu">diff</span>(bearing)<span class="sc">-</span>(<span class="dv">2</span><span class="sc">*</span>pi), <span class="fu">ifelse</span>(</span>
<span id="cb43-288"><a href="#cb43-288"></a>        <span class="fu">diff</span>(bearing) <span class="sc">&lt;</span> <span class="sc">-</span>pi, <span class="fu">diff</span>(bearing)<span class="sc">+</span>(<span class="dv">2</span><span class="sc">*</span>pi), <span class="fu">diff</span>(bearing)))),</span>
<span id="cb43-289"><a href="#cb43-289"></a>    <span class="at">cos_ta =</span> <span class="fu">cos</span>(ta),</span>
<span id="cb43-290"><a href="#cb43-290"></a>      </span>
<span id="cb43-291"><a href="#cb43-291"></a>    <span class="co"># extent for cropping the spatial covariates</span></span>
<span id="cb43-292"><a href="#cb43-292"></a>    <span class="at">x_min =</span> x_ <span class="sc">-</span> buffer,</span>
<span id="cb43-293"><a href="#cb43-293"></a>    <span class="at">x_max =</span> x_ <span class="sc">+</span> buffer,</span>
<span id="cb43-294"><a href="#cb43-294"></a>    <span class="at">y_min =</span> y_ <span class="sc">-</span> buffer,</span>
<span id="cb43-295"><a href="#cb43-295"></a>    <span class="at">y_max =</span> y_ <span class="sc">+</span> buffer,</span>
<span id="cb43-296"><a href="#cb43-296"></a>    </span>
<span id="cb43-297"><a href="#cb43-297"></a>  </span>
<span id="cb43-298"><a href="#cb43-298"></a>    <span class="co"># crop out and store the local covariates centered on the animal&#39;s location </span></span>
<span id="cb43-299"><a href="#cb43-299"></a>    <span class="co"># with an extent set in the previous chunk</span></span>
<span id="cb43-300"><a href="#cb43-300"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb43-301"><a href="#cb43-301"></a></span>
<span id="cb43-302"><a href="#cb43-302"></a>    <span class="at">extent_00centre =</span> <span class="fu">list</span>(<span class="fu">ext</span>(x_min <span class="sc">-</span> x_, x_max <span class="sc">-</span> x_, y_min <span class="sc">-</span> y_, y_max <span class="sc">-</span> y_)),</span>
<span id="cb43-303"><a href="#cb43-303"></a></span>
<span id="cb43-304"><a href="#cb43-304"></a>    <span class="co"># NDVI</span></span>
<span id="cb43-305"><a href="#cb43-305"></a>    <span class="at">ndvi_index =</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(<span class="fu">difftime</span>(t_, terra<span class="sc">::</span><span class="fu">time</span>(ndvi_projected)))),</span>
<span id="cb43-306"><a href="#cb43-306"></a>    <span class="at">ndvi_cent =</span> <span class="fu">list</span>({</span>
<span id="cb43-307"><a href="#cb43-307"></a>      ndvi_cent <span class="ot">=</span> <span class="fu">crop</span>(ndvi_projected[[ndvi_index]], <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb43-308"><a href="#cb43-308"></a>      <span class="fu">ext</span>(ndvi_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb43-309"><a href="#cb43-309"></a>      ndvi_cent</span>
<span id="cb43-310"><a href="#cb43-310"></a>      }),</span>
<span id="cb43-311"><a href="#cb43-311"></a></span>
<span id="cb43-312"><a href="#cb43-312"></a>    <span class="co"># herbaceous vegetation</span></span>
<span id="cb43-313"><a href="#cb43-313"></a>    <span class="at">veg_herby_cent =</span> <span class="fu">list</span>({</span>
<span id="cb43-314"><a href="#cb43-314"></a>      veg_herby_cent <span class="ot">=</span> <span class="fu">crop</span>(veg_herby, <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb43-315"><a href="#cb43-315"></a>      <span class="fu">ext</span>(veg_herby_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb43-316"><a href="#cb43-316"></a>      veg_herby_cent</span>
<span id="cb43-317"><a href="#cb43-317"></a>      }),</span>
<span id="cb43-318"><a href="#cb43-318"></a></span>
<span id="cb43-319"><a href="#cb43-319"></a>    <span class="co"># canopy cover</span></span>
<span id="cb43-320"><a href="#cb43-320"></a>    <span class="at">canopy_cover_cent =</span> <span class="fu">list</span>({</span>
<span id="cb43-321"><a href="#cb43-321"></a>      canopy_cover_cent <span class="ot">=</span> <span class="fu">crop</span>(canopy_cover, <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb43-322"><a href="#cb43-322"></a>      <span class="fu">ext</span>(canopy_cover_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb43-323"><a href="#cb43-323"></a>      canopy_cover_cent</span>
<span id="cb43-324"><a href="#cb43-324"></a>      }),</span>
<span id="cb43-325"><a href="#cb43-325"></a></span>
<span id="cb43-326"><a href="#cb43-326"></a>    <span class="co"># slope</span></span>
<span id="cb43-327"><a href="#cb43-327"></a>    <span class="at">slope_cent =</span> <span class="fu">list</span>({</span>
<span id="cb43-328"><a href="#cb43-328"></a>      slope_cent <span class="ot">&lt;-</span> <span class="fu">crop</span>(slope, <span class="fu">ext</span>(x_min, x_max, y_min, y_max))</span>
<span id="cb43-329"><a href="#cb43-329"></a>      <span class="fu">ext</span>(slope_cent) <span class="ot">&lt;-</span> extent_00centre</span>
<span id="cb43-330"><a href="#cb43-330"></a>      slope_cent</span>
<span id="cb43-331"><a href="#cb43-331"></a>      }),</span>
<span id="cb43-332"><a href="#cb43-332"></a></span>
<span id="cb43-333"><a href="#cb43-333"></a>    <span class="co"># rasterised location of the next step - centred on (0,0)</span></span>
<span id="cb43-334"><a href="#cb43-334"></a>    <span class="at">points_vect_cent =</span> <span class="fu">list</span>(terra<span class="sc">::</span><span class="fu">vect</span>(<span class="fu">cbind</span>(x2_ <span class="sc">-</span> x_, y2_ <span class="sc">-</span> y_), <span class="at">type =</span> <span class="st">&quot;points&quot;</span>, <span class="at">crs =</span> <span class="st">&quot;EPSG:3112&quot;</span>)),</span>
<span id="cb43-335"><a href="#cb43-335"></a>    <span class="at">pres_cent =</span> <span class="fu">list</span>(<span class="fu">rasterize</span>(points_vect_cent, ndvi_cent, <span class="at">background=</span><span class="dv">0</span>))</span>
<span id="cb43-336"><a href="#cb43-336"></a></span>
<span id="cb43-337"><a href="#cb43-337"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="co"># to remove the &#39;rowwise&#39; class</span></span>
<span id="cb43-338"><a href="#cb43-338"></a></span>
<span id="cb43-339"><a href="#cb43-339"></a></span>
<span id="cb43-340"><a href="#cb43-340"></a>  <span class="fu">toc</span>()</span>
<span id="cb43-341"><a href="#cb43-341"></a></span>
<span id="cb43-342"><a href="#cb43-342"></a>  <span class="co"># remove steps that fall outside of the local spatial extent</span></span>
<span id="cb43-343"><a href="#cb43-343"></a>  buffalo_data_covs <span class="ot">&lt;-</span> buffalo_data_covs <span class="sc">%&gt;%</span></span>
<span id="cb43-344"><a href="#cb43-344"></a>    <span class="fu">filter</span>(x2_cent <span class="sc">&gt;</span> <span class="sc">-</span>buffer <span class="sc">&amp;</span> x2_cent <span class="sc">&lt;</span> buffer <span class="sc">&amp;</span> y2_cent <span class="sc">&gt;</span> <span class="sc">-</span>buffer <span class="sc">&amp;</span> y2_cent <span class="sc">&lt;</span> buffer) <span class="sc">%&gt;%</span></span>
<span id="cb43-345"><a href="#cb43-345"></a>    <span class="fu">drop_na</span>(ta)</span>
<span id="cb43-346"><a href="#cb43-346"></a></span>
<span id="cb43-347"><a href="#cb43-347"></a>  <span class="co"># remove the columns that are no longer needed</span></span>
<span id="cb43-348"><a href="#cb43-348"></a>  buffalo_data_df <span class="ot">&lt;-</span> buffalo_data_covs <span class="sc">%&gt;%</span></span>
<span id="cb43-349"><a href="#cb43-349"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>extent_00centre,</span>
<span id="cb43-350"><a href="#cb43-350"></a>                <span class="sc">-</span>ndvi_cent,</span>
<span id="cb43-351"><a href="#cb43-351"></a>                <span class="sc">-</span>veg_herby_cent,</span>
<span id="cb43-352"><a href="#cb43-352"></a>                <span class="sc">-</span>canopy_cover_cent,</span>
<span id="cb43-353"><a href="#cb43-353"></a>                <span class="sc">-</span>slope_cent,</span>
<span id="cb43-354"><a href="#cb43-354"></a>                <span class="sc">-</span>points_vect_cent,</span>
<span id="cb43-355"><a href="#cb43-355"></a>                <span class="sc">-</span>pres_cent</span>
<span id="cb43-356"><a href="#cb43-356"></a>                )</span>
<span id="cb43-357"><a href="#cb43-357"></a></span>
<span id="cb43-358"><a href="#cb43-358"></a>  <span class="co"># save the data</span></span>
<span id="cb43-359"><a href="#cb43-359"></a>  <span class="fu">write_csv</span>(buffalo_data_df, <span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_data_id/buffalo_&quot;</span>, buffalo_ids[i],</span>
<span id="cb43-360"><a href="#cb43-360"></a>                                    <span class="st">&quot;_data_df_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.csv&quot;</span>))</span>
<span id="cb43-361"><a href="#cb43-361"></a></span>
<span id="cb43-362"><a href="#cb43-362"></a>  <span class="co"># saving the raster objects</span></span>
<span id="cb43-363"><a href="#cb43-363"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>ndvi_cent) <span class="sc">%&gt;%</span></span>
<span id="cb43-364"><a href="#cb43-364"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_ndvi_cent&quot;</span>,</span>
<span id="cb43-365"><a href="#cb43-365"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb43-366"><a href="#cb43-366"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb43-367"><a href="#cb43-367"></a></span>
<span id="cb43-368"><a href="#cb43-368"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>veg_herby_cent) <span class="sc">%&gt;%</span></span>
<span id="cb43-369"><a href="#cb43-369"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_herby_cent&quot;</span>,</span>
<span id="cb43-370"><a href="#cb43-370"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb43-371"><a href="#cb43-371"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb43-372"><a href="#cb43-372"></a></span>
<span id="cb43-373"><a href="#cb43-373"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>canopy_cover_cent) <span class="sc">%&gt;%</span></span>
<span id="cb43-374"><a href="#cb43-374"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_canopy_cent&quot;</span>,</span>
<span id="cb43-375"><a href="#cb43-375"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb43-376"><a href="#cb43-376"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb43-377"><a href="#cb43-377"></a></span>
<span id="cb43-378"><a href="#cb43-378"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>slope_cent) <span class="sc">%&gt;%</span></span>
<span id="cb43-379"><a href="#cb43-379"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_slope_cent&quot;</span>,</span>
<span id="cb43-380"><a href="#cb43-380"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb43-381"><a href="#cb43-381"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb43-382"><a href="#cb43-382"></a></span>
<span id="cb43-383"><a href="#cb43-383"></a>  <span class="fu">rast</span>(buffalo_data_covs<span class="sc">$</span>pres_cent) <span class="sc">%&gt;%</span></span>
<span id="cb43-384"><a href="#cb43-384"></a>    <span class="fu">writeRaster</span>(<span class="fu">paste0</span>(<span class="st">&quot;buffalo_local_layers_id/buffalo_&quot;</span>, buffalo_ids[i], <span class="st">&quot;_pres_cent&quot;</span>,</span>
<span id="cb43-385"><a href="#cb43-385"></a>                       nxn_cells, <span class="st">&quot;x&quot;</span>, nxn_cells, <span class="st">&quot;_lag_&quot;</span>, hourly_lag, <span class="st">&quot;hr_n&quot;</span>, n_samples, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb43-386"><a href="#cb43-386"></a>                <span class="at">overwrite =</span> T)</span>
<span id="cb43-387"><a href="#cb43-387"></a>  </span>
<span id="cb43-388"><a href="#cb43-388"></a>}</span>
<span id="cb43-389"><a href="#cb43-389"></a></span>
<span id="cb43-390"><a href="#cb43-390"></a><span class="in">```</span></span>
<span id="cb43-391"><a href="#cb43-391"></a></span>
<span id="cb43-392"><a href="#cb43-392"></a><span class="fu">## Check the outputs</span></span>
<span id="cb43-393"><a href="#cb43-393"></a></span>
<span id="cb43-394"><a href="#cb43-394"></a>quarto-executable-code-5450563D</span>
<span id="cb43-395"><a href="#cb43-395"></a></span>
<span id="cb43-396"><a href="#cb43-396"></a><span class="in">```r</span></span>
<span id="cb43-397"><a href="#cb43-397"></a><span class="fu">head</span>(buffalo_data_covs)</span>
<span id="cb43-398"><a href="#cb43-398"></a><span class="fu">which</span>(<span class="fu">is.na</span>(buffalo_data_covs<span class="sc">$</span>ta))</span>
<span id="cb43-399"><a href="#cb43-399"></a></span>
<span id="cb43-400"><a href="#cb43-400"></a><span class="in">```</span></span>
<span id="cb43-401"><a href="#cb43-401"></a></span>
<span id="cb43-402"><a href="#cb43-402"></a><span class="fu">## Plot a subset of the local covariates</span></span>
<span id="cb43-403"><a href="#cb43-403"></a></span>
<span id="cb43-404"><a href="#cb43-404"></a>quarto-executable-code-5450563D</span>
<span id="cb43-405"><a href="#cb43-405"></a></span>
<span id="cb43-406"><a href="#cb43-406"></a><span class="in">```r</span></span>
<span id="cb43-407"><a href="#cb43-407"></a>n_plots <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb43-408"><a href="#cb43-408"></a></span>
<span id="cb43-409"><a href="#cb43-409"></a><span class="co"># NDVI</span></span>
<span id="cb43-410"><a href="#cb43-410"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>ndvi_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span>
<span id="cb43-411"><a href="#cb43-411"></a></span>
<span id="cb43-412"><a href="#cb43-412"></a><span class="co"># Herbaceous vegetation</span></span>
<span id="cb43-413"><a href="#cb43-413"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>veg_herby_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span>
<span id="cb43-414"><a href="#cb43-414"></a></span>
<span id="cb43-415"><a href="#cb43-415"></a><span class="co"># Canopy cover</span></span>
<span id="cb43-416"><a href="#cb43-416"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>canopy_cover_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span>
<span id="cb43-417"><a href="#cb43-417"></a></span>
<span id="cb43-418"><a href="#cb43-418"></a><span class="co"># Slope</span></span>
<span id="cb43-419"><a href="#cb43-419"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>slope_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span>
<span id="cb43-420"><a href="#cb43-420"></a></span>
<span id="cb43-421"><a href="#cb43-421"></a><span class="co"># Target (location of the next step)</span></span>
<span id="cb43-422"><a href="#cb43-422"></a><span class="fu">walk</span>(buffalo_data_covs<span class="sc">$</span>pres_cent[<span class="dv">1</span><span class="sc">:</span>n_plots], terra<span class="sc">::</span>plot)</span>
<span id="cb43-423"><a href="#cb43-423"></a></span>
<span id="cb43-424"><a href="#cb43-424"></a><span class="in">```</span></span>
<span id="cb43-425"><a href="#cb43-425"></a></span>
<span id="cb43-426"><a href="#cb43-426"></a><span class="fu">## To save the object with all of the local covariates</span></span>
<span id="cb43-427"><a href="#cb43-427"></a></span>
<span id="cb43-428"><a href="#cb43-428"></a>quarto-executable-code-5450563D</span>
<span id="cb43-429"><a href="#cb43-429"></a></span>
<span id="cb43-430"><a href="#cb43-430"></a><span class="in">```r</span></span>
<span id="cb43-431"><a href="#cb43-431"></a><span class="co"># saveRDS(buffalo_data_covs, paste0(&quot;buffalo_data_id_covs_&quot;, Sys.Date(), &quot;.rds&quot;))</span></span>
<span id="cb43-432"><a href="#cb43-432"></a></span>
<span id="cb43-433"><a href="#cb43-433"></a><span class="in">```</span></span>
<span id="cb43-434"><a href="#cb43-434"></a></span>
<span id="cb43-435"><a href="#cb43-435"></a><span class="fu">## To save some plots</span></span>
<span id="cb43-436"><a href="#cb43-436"></a></span>
<span id="cb43-437"><a href="#cb43-437"></a>quarto-executable-code-5450563D</span>
<span id="cb43-438"><a href="#cb43-438"></a></span>
<span id="cb43-439"><a href="#cb43-439"></a><span class="in">```r</span></span>
<span id="cb43-440"><a href="#cb43-440"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb43-441"><a href="#cb43-441"></a><span class="co">#   png(filename = paste0(&quot;ndvi_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb43-442"><a href="#cb43-442"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb43-443"><a href="#cb43-443"></a><span class="co">#   terra::plot(buffalo_data_covs$ndvi_cent[[i]])</span></span>
<span id="cb43-444"><a href="#cb43-444"></a><span class="co">#   dev.off()</span></span>
<span id="cb43-445"><a href="#cb43-445"></a><span class="co"># }</span></span>
<span id="cb43-446"><a href="#cb43-446"></a><span class="co"># </span></span>
<span id="cb43-447"><a href="#cb43-447"></a><span class="co"># # for the pres layers</span></span>
<span id="cb43-448"><a href="#cb43-448"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb43-449"><a href="#cb43-449"></a><span class="co">#   </span></span>
<span id="cb43-450"><a href="#cb43-450"></a><span class="co">#   # change the 0 values to NA</span></span>
<span id="cb43-451"><a href="#cb43-451"></a><span class="co">#   layer &lt;- buffalo_data_covs$pres_cent[[i]]</span></span>
<span id="cb43-452"><a href="#cb43-452"></a><span class="co">#   layer[layer == 0] &lt;- 0.5</span></span>
<span id="cb43-453"><a href="#cb43-453"></a><span class="co">#   </span></span>
<span id="cb43-454"><a href="#cb43-454"></a><span class="co">#   ndvi_layer &lt;- buffalo_data_covs$ndvi_cent[[i]]</span></span>
<span id="cb43-455"><a href="#cb43-455"></a><span class="co">#   new_layer &lt;- layer*ndvi_layer</span></span>
<span id="cb43-456"><a href="#cb43-456"></a><span class="co">#   </span></span>
<span id="cb43-457"><a href="#cb43-457"></a><span class="co">#   # save the plot</span></span>
<span id="cb43-458"><a href="#cb43-458"></a><span class="co">#   png(filename = paste0(&quot;pres_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb43-459"><a href="#cb43-459"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb43-460"><a href="#cb43-460"></a><span class="co">#   terra::plot(new_layer)</span></span>
<span id="cb43-461"><a href="#cb43-461"></a><span class="co">#   dev.off()</span></span>
<span id="cb43-462"><a href="#cb43-462"></a><span class="co"># }</span></span>
<span id="cb43-463"><a href="#cb43-463"></a><span class="co"># </span></span>
<span id="cb43-464"><a href="#cb43-464"></a><span class="co"># </span></span>
<span id="cb43-465"><a href="#cb43-465"></a><span class="co"># # other plots</span></span>
<span id="cb43-466"><a href="#cb43-466"></a><span class="co"># </span></span>
<span id="cb43-467"><a href="#cb43-467"></a><span class="co"># n_plots &lt;- 1</span></span>
<span id="cb43-468"><a href="#cb43-468"></a><span class="co"># </span></span>
<span id="cb43-469"><a href="#cb43-469"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb43-470"><a href="#cb43-470"></a><span class="co">#   png(filename = paste0(&quot;veg_herby_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb43-471"><a href="#cb43-471"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb43-472"><a href="#cb43-472"></a><span class="co">#   terra::plot(buffalo_data_covs$veg_herby_cent[[i]])</span></span>
<span id="cb43-473"><a href="#cb43-473"></a><span class="co">#   dev.off()</span></span>
<span id="cb43-474"><a href="#cb43-474"></a><span class="co"># }</span></span>
<span id="cb43-475"><a href="#cb43-475"></a><span class="co"># </span></span>
<span id="cb43-476"><a href="#cb43-476"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb43-477"><a href="#cb43-477"></a><span class="co">#   png(filename = paste0(&quot;canopy_cover_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb43-478"><a href="#cb43-478"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb43-479"><a href="#cb43-479"></a><span class="co">#   terra::plot(buffalo_data_covs$canopy_cover_cent[[i]])</span></span>
<span id="cb43-480"><a href="#cb43-480"></a><span class="co">#   dev.off()</span></span>
<span id="cb43-481"><a href="#cb43-481"></a><span class="co"># }</span></span>
<span id="cb43-482"><a href="#cb43-482"></a><span class="co"># </span></span>
<span id="cb43-483"><a href="#cb43-483"></a><span class="co"># for(i in 1:n_plots) {</span></span>
<span id="cb43-484"><a href="#cb43-484"></a><span class="co">#   png(filename = paste0(&quot;slope_cent_&quot;, i, &quot;.png&quot;),</span></span>
<span id="cb43-485"><a href="#cb43-485"></a><span class="co">#       width = 150, height = 150, units = &quot;mm&quot;, res = 600)</span></span>
<span id="cb43-486"><a href="#cb43-486"></a><span class="co">#   terra::plot(buffalo_data_covs$slope_cent[[i]])</span></span>
<span id="cb43-487"><a href="#cb43-487"></a><span class="co">#   dev.off()</span></span>
<span id="cb43-488"><a href="#cb43-488"></a><span class="co"># }</span></span>
<span id="cb43-489"><a href="#cb43-489"></a></span>
<span id="cb43-490"><a href="#cb43-490"></a><span class="in">```</span></span>
<span id="cb43-491"><a href="#cb43-491"></a></span>
<span id="cb43-492"><a href="#cb43-492"></a><span class="fu">## Plot the step lengths and turning angles</span></span>
<span id="cb43-493"><a href="#cb43-493"></a></span>
<span id="cb43-494"><a href="#cb43-494"></a>quarto-executable-code-5450563D</span>
<span id="cb43-495"><a href="#cb43-495"></a></span>
<span id="cb43-496"><a href="#cb43-496"></a><span class="in">```r</span></span>
<span id="cb43-497"><a href="#cb43-497"></a><span class="co"># plot step lengths</span></span>
<span id="cb43-498"><a href="#cb43-498"></a>buffalo_data_covs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sl <span class="sc">&lt;</span> <span class="dv">2000</span>) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb43-499"><a href="#cb43-499"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> sl), </span>
<span id="cb43-500"><a href="#cb43-500"></a>                 <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb43-501"><a href="#cb43-501"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Step length (m)&quot;</span>) <span class="sc">+</span> <span class="co">#, limits = c(-25, 1250)</span></span>
<span id="cb43-502"><a href="#cb43-502"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-503"><a href="#cb43-503"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Step lengths&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-504"><a href="#cb43-504"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb43-505"><a href="#cb43-505"></a></span>
<span id="cb43-506"><a href="#cb43-506"></a><span class="co"># ggsave(&quot;outputs/step_length.png&quot;, height = 60, width = 120, units = &quot;mm&quot;, dpi = 600)</span></span>
<span id="cb43-507"><a href="#cb43-507"></a></span>
<span id="cb43-508"><a href="#cb43-508"></a></span>
<span id="cb43-509"><a href="#cb43-509"></a><span class="co"># plot turning angles</span></span>
<span id="cb43-510"><a href="#cb43-510"></a>buffalo_data_covs <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb43-511"><a href="#cb43-511"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> ta), </span>
<span id="cb43-512"><a href="#cb43-512"></a>                 <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb43-513"><a href="#cb43-513"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Turning angle (radians)&quot;</span>, </span>
<span id="cb43-514"><a href="#cb43-514"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span>pi, <span class="sc">-</span>pi<span class="sc">/</span><span class="dv">2</span>, <span class="dv">0</span>, pi<span class="sc">/</span><span class="dv">2</span>, pi),</span>
<span id="cb43-515"><a href="#cb43-515"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="fu">expression</span>(<span class="sc">-</span>pi), <span class="fu">expression</span>(<span class="sc">-</span>pi<span class="sc">/</span><span class="dv">2</span>), <span class="st">&quot;0&quot;</span>, <span class="fu">expression</span>(pi<span class="sc">/</span><span class="dv">2</span>), <span class="fu">expression</span>(pi))</span>
<span id="cb43-516"><a href="#cb43-516"></a>  ) <span class="sc">+</span></span>
<span id="cb43-517"><a href="#cb43-517"></a>  <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-518"><a href="#cb43-518"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Turning angles&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-519"><a href="#cb43-519"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb43-520"><a href="#cb43-520"></a></span>
<span id="cb43-521"><a href="#cb43-521"></a><span class="co"># ggsave(&quot;outputs/turning_angle.png&quot;, height = 60, width = 120, units = &quot;mm&quot;, dpi = 600)  </span></span>
<span id="cb43-522"><a href="#cb43-522"></a></span>
<span id="cb43-523"><a href="#cb43-523"></a><span class="in">```</span></span></code></pre></div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->

</body>

</html>
